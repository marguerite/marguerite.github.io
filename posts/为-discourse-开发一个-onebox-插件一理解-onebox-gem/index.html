<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem | Marguerite Su: Golang/Ruby Programmer, openSUSE Member</title>
<meta name="keywords" content="">
<meta name="description" content="ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem
æˆ‘ä»¬ openSUSE ä¸­æ–‡è®ºå›ç”¨çš„æ˜¯ discourseï¼Œæœ‰ä¸€å¤©ç»™ç”¨æˆ·è´´äº†ä¸€ä¸ª OBS çš„é“¾æ¥ï¼Œçªç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯å¯ä»¥è®©å®ƒä¹Ÿèƒ½åƒ github ä¸€æ ·æœ‰ä¸€ä¸ªæ¼‚äº®çš„é¢„è§ˆå°çª—å£ ğŸ¤“ äºæ˜¯è¯´å¹²å°±å¹²ï¼šdiscourse-openbuildservice-onebox æ’ä»¶ã€‚
ä»¥ä¸‹æ˜¯æ•™ç¨‹ï¼Œç”±äºæ¶‰åŠåˆ°ç›®å‰æœ€å¤§çš„ Ruby on Rails ç¨‹åº discourseï¼Œä¼šåˆ†æˆå‡ éƒ¨åˆ†æ¥è®²è§£ã€‚ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è¯•ç€ç†è§£ä¸€ä¸‹ discourse å‡ºå“çš„ onebox gemã€‚
Ruby ä½œä¸ºä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œæ‰€æœ‰å¯¹è±¡çš„æ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™ã€‚å­¦åå«åš Meta Programmingã€‚è¿™æ˜¯ç†è§£ onebox gem çš„åŸºç¡€ã€‚
æˆ‘ä»¬ä¸‹é¢æ¥çœ‹ discourse æ˜¯æ€ä¹ˆä½¿ç”¨ onebox gem çš„ï¼Œä¸‹é¢æ˜¯ app/models/post_analyzer.rb çš„ cook å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠä½ è¾“å…¥çš„æ–‡å­—è½¬ä¸º html ä¿å­˜åœ¨ postgresql æ•°æ®åº“ï¼Œæ˜¯æœ€åŸºç¡€çš„å‡½æ•°ä¹‹ä¸€ï¼š
  def cook(raw, opts = {})
    [...]

    result = Oneboxer.apply(cooked) do |url|
      @onebox_urls &lt;&lt; url
      if opts[:invalidate_oneboxes]
        Oneboxer.invalidate(url)
        InlineOneboxer.invalidate(url)
      end
      onebox = Oneboxer.cached_onebox(url)
      @found_oneboxes = true if onebox.present?
      onebox
    end

    cooked = result.to_html if result.changed?
    cooked
  end
å¯ä»¥çœ‹åˆ° discourse è‡ªå·±è¿˜æœ‰ä¸€ä¸ª Oneboxer çš„ wrapperï¼Œè¿™é‡Œä½¿ç”¨äº† Oneboxer.apply å’Œ Oneboxer.cache_onebox å‡½æ•°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ‹ lib/oneboxer.rbï¼š">
<meta name="author" content="">
<link rel="canonical" href="https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://marguerite.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://marguerite.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://marguerite.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://marguerite.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://marguerite.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" integrity="sha512-7QTQ5Qsc/IL1k8UU2bkNFjpKTfwnvGuPYE6fzm6yeneWTEGiA3zspgjcTsSgln9m0cn3MgyE7EnDNkF1bB/uCw==" crossorigin="anonymous" /><meta property="og:url" content="https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/">
  <meta property="og:site_name" content="Marguerite Su: Golang/Ruby Programmer, openSUSE Member">
  <meta property="og:title" content="ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem">
  <meta property="og:description" content="ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem æˆ‘ä»¬ openSUSE ä¸­æ–‡è®ºå›ç”¨çš„æ˜¯ discourseï¼Œæœ‰ä¸€å¤©ç»™ç”¨æˆ·è´´äº†ä¸€ä¸ª OBS çš„é“¾æ¥ï¼Œçªç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯å¯ä»¥è®©å®ƒä¹Ÿèƒ½åƒ github ä¸€æ ·æœ‰ä¸€ä¸ªæ¼‚äº®çš„é¢„è§ˆå°çª—å£ ğŸ¤“ äºæ˜¯è¯´å¹²å°±å¹²ï¼šdiscourse-openbuildservice-onebox æ’ä»¶ã€‚
ä»¥ä¸‹æ˜¯æ•™ç¨‹ï¼Œç”±äºæ¶‰åŠåˆ°ç›®å‰æœ€å¤§çš„ Ruby on Rails ç¨‹åº discourseï¼Œä¼šåˆ†æˆå‡ éƒ¨åˆ†æ¥è®²è§£ã€‚ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è¯•ç€ç†è§£ä¸€ä¸‹ discourse å‡ºå“çš„ onebox gemã€‚
Ruby ä½œä¸ºä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œæ‰€æœ‰å¯¹è±¡çš„æ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™ã€‚å­¦åå«åš Meta Programmingã€‚è¿™æ˜¯ç†è§£ onebox gem çš„åŸºç¡€ã€‚
æˆ‘ä»¬ä¸‹é¢æ¥çœ‹ discourse æ˜¯æ€ä¹ˆä½¿ç”¨ onebox gem çš„ï¼Œä¸‹é¢æ˜¯ app/models/post_analyzer.rb çš„ cook å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠä½ è¾“å…¥çš„æ–‡å­—è½¬ä¸º html ä¿å­˜åœ¨ postgresql æ•°æ®åº“ï¼Œæ˜¯æœ€åŸºç¡€çš„å‡½æ•°ä¹‹ä¸€ï¼š
def cook(raw, opts = {}) [...] result = Oneboxer.apply(cooked) do |url| @onebox_urls &lt;&lt; url if opts[:invalidate_oneboxes] Oneboxer.invalidate(url) InlineOneboxer.invalidate(url) end onebox = Oneboxer.cached_onebox(url) @found_oneboxes = true if onebox.present? onebox end cooked = result.to_html if result.changed? cooked end å¯ä»¥çœ‹åˆ° discourse è‡ªå·±è¿˜æœ‰ä¸€ä¸ª Oneboxer çš„ wrapperï¼Œè¿™é‡Œä½¿ç”¨äº† Oneboxer.apply å’Œ Oneboxer.cache_onebox å‡½æ•°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ‹ lib/oneboxer.rbï¼š">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-11-28T14:59:00+08:00">
    <meta property="article:modified_time" content="2020-11-28T14:59:00+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem">
<meta name="twitter:description" content="ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem
æˆ‘ä»¬ openSUSE ä¸­æ–‡è®ºå›ç”¨çš„æ˜¯ discourseï¼Œæœ‰ä¸€å¤©ç»™ç”¨æˆ·è´´äº†ä¸€ä¸ª OBS çš„é“¾æ¥ï¼Œçªç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯å¯ä»¥è®©å®ƒä¹Ÿèƒ½åƒ github ä¸€æ ·æœ‰ä¸€ä¸ªæ¼‚äº®çš„é¢„è§ˆå°çª—å£ ğŸ¤“ äºæ˜¯è¯´å¹²å°±å¹²ï¼šdiscourse-openbuildservice-onebox æ’ä»¶ã€‚
ä»¥ä¸‹æ˜¯æ•™ç¨‹ï¼Œç”±äºæ¶‰åŠåˆ°ç›®å‰æœ€å¤§çš„ Ruby on Rails ç¨‹åº discourseï¼Œä¼šåˆ†æˆå‡ éƒ¨åˆ†æ¥è®²è§£ã€‚ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è¯•ç€ç†è§£ä¸€ä¸‹ discourse å‡ºå“çš„ onebox gemã€‚
Ruby ä½œä¸ºä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œæ‰€æœ‰å¯¹è±¡çš„æ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™ã€‚å­¦åå«åš Meta Programmingã€‚è¿™æ˜¯ç†è§£ onebox gem çš„åŸºç¡€ã€‚
æˆ‘ä»¬ä¸‹é¢æ¥çœ‹ discourse æ˜¯æ€ä¹ˆä½¿ç”¨ onebox gem çš„ï¼Œä¸‹é¢æ˜¯ app/models/post_analyzer.rb çš„ cook å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠä½ è¾“å…¥çš„æ–‡å­—è½¬ä¸º html ä¿å­˜åœ¨ postgresql æ•°æ®åº“ï¼Œæ˜¯æœ€åŸºç¡€çš„å‡½æ•°ä¹‹ä¸€ï¼š
  def cook(raw, opts = {})
    [...]

    result = Oneboxer.apply(cooked) do |url|
      @onebox_urls &lt;&lt; url
      if opts[:invalidate_oneboxes]
        Oneboxer.invalidate(url)
        InlineOneboxer.invalidate(url)
      end
      onebox = Oneboxer.cached_onebox(url)
      @found_oneboxes = true if onebox.present?
      onebox
    end

    cooked = result.to_html if result.changed?
    cooked
  end
å¯ä»¥çœ‹åˆ° discourse è‡ªå·±è¿˜æœ‰ä¸€ä¸ª Oneboxer çš„ wrapperï¼Œè¿™é‡Œä½¿ç”¨äº† Oneboxer.apply å’Œ Oneboxer.cache_onebox å‡½æ•°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ‹ lib/oneboxer.rbï¼š">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://marguerite.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem",
      "item": "https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem",
  "name": "ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem",
  "description": "ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem æˆ‘ä»¬ openSUSE ä¸­æ–‡è®ºå›ç”¨çš„æ˜¯ discourseï¼Œæœ‰ä¸€å¤©ç»™ç”¨æˆ·è´´äº†ä¸€ä¸ª OBS çš„é“¾æ¥ï¼Œçªç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯å¯ä»¥è®©å®ƒä¹Ÿèƒ½åƒ github ä¸€æ ·æœ‰ä¸€ä¸ªæ¼‚äº®çš„é¢„è§ˆå°çª—å£ ğŸ¤“ äºæ˜¯è¯´å¹²å°±å¹²ï¼šdiscourse-openbuildservice-onebox æ’ä»¶ã€‚\nä»¥ä¸‹æ˜¯æ•™ç¨‹ï¼Œç”±äºæ¶‰åŠåˆ°ç›®å‰æœ€å¤§çš„ Ruby on Rails ç¨‹åº discourseï¼Œä¼šåˆ†æˆå‡ éƒ¨åˆ†æ¥è®²è§£ã€‚ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è¯•ç€ç†è§£ä¸€ä¸‹ discourse å‡ºå“çš„ onebox gemã€‚\nRuby ä½œä¸ºä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œæ‰€æœ‰å¯¹è±¡çš„æ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™ã€‚å­¦åå«åš Meta Programmingã€‚è¿™æ˜¯ç†è§£ onebox gem çš„åŸºç¡€ã€‚\næˆ‘ä»¬ä¸‹é¢æ¥çœ‹ discourse æ˜¯æ€ä¹ˆä½¿ç”¨ onebox gem çš„ï¼Œä¸‹é¢æ˜¯ app/models/post_analyzer.rb çš„ cook å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠä½ è¾“å…¥çš„æ–‡å­—è½¬ä¸º html ä¿å­˜åœ¨ postgresql æ•°æ®åº“ï¼Œæ˜¯æœ€åŸºç¡€çš„å‡½æ•°ä¹‹ä¸€ï¼š\ndef cook(raw, opts = {}) [...] result = Oneboxer.apply(cooked) do |url| @onebox_urls \u0026lt;\u0026lt; url if opts[:invalidate_oneboxes] Oneboxer.invalidate(url) InlineOneboxer.invalidate(url) end onebox = Oneboxer.cached_onebox(url) @found_oneboxes = true if onebox.present? onebox end cooked = result.to_html if result.changed? cooked end å¯ä»¥çœ‹åˆ° discourse è‡ªå·±è¿˜æœ‰ä¸€ä¸ª Oneboxer çš„ wrapperï¼Œè¿™é‡Œä½¿ç”¨äº† Oneboxer.apply å’Œ Oneboxer.cache_onebox å‡½æ•°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ‹ lib/oneboxer.rbï¼š\n",
  "keywords": [
    
  ],
  "articleBody": "ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem æˆ‘ä»¬ openSUSE ä¸­æ–‡è®ºå›ç”¨çš„æ˜¯ discourseï¼Œæœ‰ä¸€å¤©ç»™ç”¨æˆ·è´´äº†ä¸€ä¸ª OBS çš„é“¾æ¥ï¼Œçªç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯å¯ä»¥è®©å®ƒä¹Ÿèƒ½åƒ github ä¸€æ ·æœ‰ä¸€ä¸ªæ¼‚äº®çš„é¢„è§ˆå°çª—å£ ğŸ¤“ äºæ˜¯è¯´å¹²å°±å¹²ï¼šdiscourse-openbuildservice-onebox æ’ä»¶ã€‚\nä»¥ä¸‹æ˜¯æ•™ç¨‹ï¼Œç”±äºæ¶‰åŠåˆ°ç›®å‰æœ€å¤§çš„ Ruby on Rails ç¨‹åº discourseï¼Œä¼šåˆ†æˆå‡ éƒ¨åˆ†æ¥è®²è§£ã€‚ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è¯•ç€ç†è§£ä¸€ä¸‹ discourse å‡ºå“çš„ onebox gemã€‚\nRuby ä½œä¸ºä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œæ‰€æœ‰å¯¹è±¡çš„æ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™ã€‚å­¦åå«åš Meta Programmingã€‚è¿™æ˜¯ç†è§£ onebox gem çš„åŸºç¡€ã€‚\næˆ‘ä»¬ä¸‹é¢æ¥çœ‹ discourse æ˜¯æ€ä¹ˆä½¿ç”¨ onebox gem çš„ï¼Œä¸‹é¢æ˜¯ app/models/post_analyzer.rb çš„ cook å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠä½ è¾“å…¥çš„æ–‡å­—è½¬ä¸º html ä¿å­˜åœ¨ postgresql æ•°æ®åº“ï¼Œæ˜¯æœ€åŸºç¡€çš„å‡½æ•°ä¹‹ä¸€ï¼š\ndef cook(raw, opts = {}) [...] result = Oneboxer.apply(cooked) do |url| @onebox_urls \u003c\u003c url if opts[:invalidate_oneboxes] Oneboxer.invalidate(url) InlineOneboxer.invalidate(url) end onebox = Oneboxer.cached_onebox(url) @found_oneboxes = true if onebox.present? onebox end cooked = result.to_html if result.changed? cooked end å¯ä»¥çœ‹åˆ° discourse è‡ªå·±è¿˜æœ‰ä¸€ä¸ª Oneboxer çš„ wrapperï¼Œè¿™é‡Œä½¿ç”¨äº† Oneboxer.apply å’Œ Oneboxer.cache_onebox å‡½æ•°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ‹ lib/oneboxer.rbï¼š\ndef self.apply(string_or_doc, extra_paths: nil) doc = string_or_doc doc = Nokogiri::HTML5::fragment(doc) if doc.is_a?(String) changed = false each_onebox_link(doc, extra_paths: extra_paths) do |url, element| onebox, _ = yield(url, element) if onebox parsed_onebox = Nokogiri::HTML5::fragment(onebox) next unless parsed_onebox.children.count \u003e 0 if element\u0026.parent\u0026.node_name\u0026.downcase == \"p\" \u0026\u0026 element.parent.children.count == 1 \u0026\u0026 HTML5_BLOCK_ELEMENTS.include?(parsed_onebox.children[0].node_name.downcase) element = element.parent end changed = true element.swap parsed_onebox.to_html end end # strip empty elements doc.css(\"p\").each do |p| if p.children.empty? \u0026\u0026 doc.children.count \u003e 1 p.remove end end Result.new(doc, changed) end è¿™æ®µå…¶å®æ²¡å•¥ç”¨ï¼Œç®€å•è§£é‡Šä¸‹å°±æ˜¯å–åˆ° cooked è¿™ä¸ª html é‡Œéœ€è¦ onebox åŒ–çš„ URL nodeã€‚ç„¶å invalidate ä¹‹åå– cached_oneboxã€‚cached_onebox ä¸å®é™…è¿›è¡Œ onebox åŒ–é‡Œé¢æœ‰å¤ªå¤šçš„åˆ¤æ–­ä»£ç ï¼ˆonebox_raw)ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ Oneboxer çš„è¿™ä¸ªå‡½æ•°å°±å¤Ÿäº†ï¼š\ndef self.external_onebox(url) Discourse.cache.fetch(onebox_cache_key(url), expires_in: 1.day) do fd = FinalDestination.new(url, ignore_redirects: ignore_redirects, ignore_hostnames: blocked_domains, force_get_hosts: force_get_hosts, force_custom_user_agent_hosts: force_custom_user_agent_hosts, preserve_fragment_url_hosts: preserve_fragment_url_hosts) uri = fd.resolve if fd.status != :resolved args = { link: url } if fd.status == :invalid_address args[:error_message] = I18n.t(\"errors.onebox.invalid_address\", hostname: fd.hostname) elsif fd.status_code args[:error_message] = I18n.t(\"errors.onebox.error_response\", status_code: fd.status_code) end error_box = blank_onebox error_box[:preview] = preview_error_onebox(args) return error_box end return blank_onebox if uri.blank? || blocked_domains.map { |hostname| uri.hostname.match?(hostname) }.any? options = { max_width: 695, sanitize_config: Onebox::DiscourseOneboxSanitizeConfig::Config::DISCOURSE_ONEBOX, allowed_iframe_origins: allowed_iframe_origins, hostname: GlobalSetting.hostname, facebook_app_access_token: SiteSetting.facebook_app_access_token, } options[:cookie] = fd.cookie if fd.cookie r = Onebox.preview(uri.to_s, options) result = { onebox: r.to_s, preview: r\u0026.placeholder_html.to_s } # NOTE: Call r.errors after calling placeholder_html if r.errors.any? missing_attributes = r.errors.keys.map(\u0026:to_s).sort.join(I18n.t(\"word_connector.comma\")) error_message = I18n.t(\"errors.onebox.missing_data\", missing_attributes: missing_attributes, count: r.errors.keys.size) args = r.data.merge(error_message: error_message) if result[:preview].blank? result[:preview] = preview_error_onebox(args) else doc = Nokogiri::HTML5::fragment(result[:preview]) aside = doc.at('aside') if aside # Add an error message to the preview that was returned error_fragment = preview_error_onebox_fragment(args) aside.add_child(error_fragment) result[:preview] = doc.to_html end end end result end end è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼š\nr = Onebox.preview(uri.to_s, options) result = { onebox: r.to_s, preview: r\u0026.placeholder_html.to_s } è¿™æ®µæ˜¯æœ€ä¸»è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Onebox è¿™ä¸ª gem æ˜¯é€šè¿‡å®ƒçš„ preview å‡½æ•°æ¥ä¸ discourse è¿›è¡Œäº¤äº’çš„ã€‚discourse ä»£ç çœ‹åˆ°è¿™é‡Œå°±å¤Ÿäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ onebox ä»£ç ã€‚\nä¸€ä¸ª rubygem æœ€é‡è¦çš„æ˜¯å®ƒçš„ lib æ–‡ä»¶å¤¹ã€‚æˆ‘ä»¬å…ˆä» lib/onebox.rb çœ‹èµ·ï¼š\ndef self.preview(url, options = Onebox.options) # onebox does not have native caching unless Onebox::Helpers.blank?(options[:cache]) warn \"Onebox no longer has inbuilt caching so `cache` option will be ignored.\" end Preview.new(url, options) end è¿™å°±æ˜¯ä¸Šé¢çš„ Onebox.preview çš„æ¥æºã€‚æœ€é‡è¦çš„æ˜¯ Preview è¿™ä¸ª classã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€çœ‹ lib/onebox/preview.rbï¼š\nmodule Onebox class Preview # see https://bugs.ruby-lang.org/issues/14688 client_exception = defined?(Net::HTTPClientException) ? Net::HTTPClientException : Net::HTTPServerException WEB_EXCEPTIONS ||= [client_exception, OpenURI::HTTPError, Timeout::Error, Net::HTTPError, Errno::ECONNREFUSED] def initialize(link, options = Onebox.options) @url = link @options = options.dup allowed_origins = @options[:allowed_iframe_origins] || Onebox::Engine.all_iframe_origins @options[:allowed_iframe_regexes] = Engine.origins_to_regexes(allowed_origins) @engine_class = Matcher.new(@url, @options).oneboxed end end end å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ®µä»£ç çš„æ„æ€æ˜¯è¯´æ ¹æ® Matcher æ¥åŒ¹é… URL ä»è€Œå– oneboxed çš„ç»“æœã€‚æ¥ç€çœ‹ lib/onebox/matcher.rbï¼š\nmodule Onebox class Matcher def initialize(link, options = {}) @url = link @options = options end def ordered_engines @ordered_engines ||= Engine.engines.sort_by do |e| e.respond_to?(:priority) ? e.priority : 100 end end def oneboxed uri = URI(@url) return unless uri.port.nil? || Onebox.options.allowed_ports.include?(uri.port) return unless uri.scheme.nil? || Onebox.options.allowed_schemes.include?(uri.scheme) ordered_engines.find { |engine| engine === uri \u0026\u0026 has_allowed_iframe_origins?(engine) } rescue URI::InvalidURIError nil end end end è¿™æ®µä»£ç çš„æ„æ€æ˜¯ä» ordered_engines é‡Œæ‰¾åˆ°åŒ¹é… uri çš„ engineã€‚è¿”å›è¿™ä¸ª engineã€‚è€Œ ordered_engines æ¥è‡ª Engine.enginesã€‚æˆ‘ä»¬æ¥çœ‹æœ€é‡è¦çš„ lib/onebox/engine.rbï¼š\nmodule Onebox module Engine def self.included(object) object.extend(ClassMethods) end def self.engines constants.select do |constant| constant.to_s =~ /Onebox$/ end.map(\u0026method(:const_get)) end end end require_relative \"helpers\" require_relative \"layout_support\" require_relative \"file_type_finder\" require_relative \"engine/standard_embed\" require_relative \"engine/html\" require_relative \"engine/json\" require_relative \"engine/amazon_onebox\" require_relative \"engine/github_issue_onebox\" require_relative \"engine/github_blob_onebox\" [...] è¿™é‡Œçš„ included å‡½æ•°å…¶å®æ˜¯ä¸€ä¸ªè¢«é‡å†™çš„å†…ç½®å‡½æ•°ã€‚å®ƒæ˜¯ ruby çš„ module å‡½æ•°ï¼Œæ„æ€æ˜¯è¿™ä¸ª module è¢« included åˆ°åˆ«çš„ Object é‡Œçš„æ—¶å€™ä¼šåšä»€ä¹ˆã€‚ä¹Ÿå°±æ˜¯è¯´ module Engine è¿™ä¸ªæ¨¡å—è¢«åˆ«çš„ Class/Module è¿™æ · include çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼š\nmodule A include Engine end è¿™é‡Œæ‰€æœ‰ include äº† module Engine çš„ Class éƒ½ä¼šè‡ªåŠ¨è·å¾— ClassMethods çš„ç±»æ–¹æ³•ï¼ŒClassMethods æ¨¡å—åœ¨åé¢ä¸€ç‚¹çš„åœ°æ–¹ï¼š\nmodule ClassMethods def ===(other) if other.kind_of?(URI) !!(other.to_s =~ class_variable_get(:@@matcher)) else super end end def priority 100 end def matches_regexp(r) class_variable_set :@@matcher, r end def requires_iframe_origins(*origins) class_variable_set :@@iframe_origins, origins end def iframe_origins class_variable_defined?(:@@iframe_origins) ? class_variable_get(:@@iframe_origins) : [] end # calculates a name for onebox using the class name of engine def onebox_name name.split(\"::\").last.downcase.gsub(/onebox/, \"\") end def always_https @https = true end def always_https? @https end end ä¸¾ä¸ªä¾‹å­ï¼š\nmodule Onebox module Engine class YoukuOnebox include Engine include HTML matches_regexp(/^(https?:\\/\\/)?([\\da-z\\.-]+)(youku.com\\/)(.)+\\/?$/) requires_iframe_origins \"https://player.youku.com\" è¿™æ˜¯ lib/onebox/engine/youku_onebox.rbã€‚å› ä¸º include Engineï¼Œæ‰€ä»¥è‡ªåŠ¨è·å¾— matches_regexp è¿™ä¸ªç±»æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨ï¼š\nmatches_regexp(/^(https?:\\/\\/)?([\\da-z\\.-]+)(youku.com\\/)(.)+\\/?$/) æ¥å°† YoukuOnebox è¿™ä¸ª Class çš„ç±»å…¨å±€å˜é‡ @@matcher è®¾ç½®ä¸ºä¸Šé¢çš„ regexpã€‚é€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘ä»¬åº”è¯¥å¤§æ¦‚å¯ä»¥æ˜ç™½ä¸ºä»€ä¹ˆèƒ½å¤Ÿåˆšå®šä¹‰ä¸€ä¸ªæ–°ç±»å°±æ‹¥æœ‰é‚£ä¹ˆå¤šçš„ç±»æ–¹æ³•äº†ã€‚åŒæ ·åŠŸæ•ˆçš„è¿˜æœ‰ include HTMLï¼Œinclude JSONç­‰ç­‰ã€‚ä¸‹ä¸€ç¯‡ç”¨çš„çš„æ—¶å€™å†ç»™å¤§å®¶çœ‹ä»£ç ã€‚\nä¸‹é¢æ¥çœ‹ç¬¬äºŒä¸ªæ–¹æ³•ï¼š\ndef self.engines constants.select do |constant| constant.to_s =~ /Onebox$/ end.map(\u0026method(:const_get)) end å¾ˆå¤šæ–°æ‰‹è¿™æ—¶å€™å°±æ— æ³•ç†è§£äº†ã€‚constants æ˜¯ä»€ä¹ˆï¼Ÿå®ƒå…¶å® ruby çš„ä¸€ä¸ª Module æ–¹æ³•ã€‚è¿”å›è¿™ä¸ª module çš„æ‰€æœ‰å¸¸é‡ï¼Œå®šä¹‰åœ¨ Module å†…éƒ¨çš„ Class ä¹Ÿæ˜¯å¸¸é‡ï¼Œç»™æ®µæµ‹è¯•ä»£ç ï¼š\nmodule A class B end end module C include A def self.test p constants end end C.test ä¸Šé¢è¿è¡Œ C.test çš„ç»“æœæ˜¯ [:B]ã€‚ç±»å B æ˜¯ C çš„å¸¸é‡ã€‚é‚£ä¹ˆ self.engines è¿™ä¸ªå‡½æ•°å…¶å®å°±å¥½ç†è§£äº†ã€‚ä» Engine module çš„å…¨éƒ¨ç±»ä¸­æ‰¾åˆ°ä»¥ Onebox ç»“å°¾çš„ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚ä¸Šé¢ Youku çš„é‚£ä¸ªä¾‹å­æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ï¼Œæ‰€æœ‰çš„è‡ªå®šä¹‰ Engine éƒ½æ˜¯è¿™ä¸ªç»“æ„ï¼š\nmodule Onebox module Engine class YoukuOnebox ç›®çš„å°±æ˜¯è®© self.engines å‡½æ•°èƒ½å¤ŸçŸ¥é“å®ƒçš„å­˜åœ¨ã€‚\næˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ï¼š\ndef initialize(link, timeout = nil) @errors = {} @options = DEFAULT class_name = self.class.name.split(\"::\").last.to_s # Set the engine options extracted from global options. self.options = Onebox.options[class_name] || {} @url = link @uri = URI(link) if always_https? @uri.scheme = 'https' @url = @uri.to_s end @timeout = timeout || Onebox.options.timeout end æ˜¯ä¸æ˜¯å¾ˆæœ‰æ„æ€ï¼Œä¸€ä¸ª Module å±…ç„¶æœ‰ initialize å‡½æ•°ï¼ä»–çš„ä½œç”¨æ˜¯ï¼Œinclude å®ƒçš„ class çš„ new instance ç”Ÿæˆçš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ª class æœ¬èº«æ²¡æœ‰å†™ initialize å‡½æ•°ï¼Œé‚£ä¹ˆè¿è¡Œ module å¸¦çš„ã€‚è¦æ˜¯å†™äº†ï¼Œåœ¨ class çš„ initialize å‡½æ•°é‡Œå¯ä»¥è¿è¡Œ super æ¥è¿è¡Œ module å¸¦çš„ã€‚æˆ‘ä»¬çœ‹ engine æ–‡ä»¶å¤¹é‡Œæ‰€æœ‰çš„è‡ªå®šä¹‰å¼•æ“éƒ½æ²¡æœ‰å†™è‡ªå·±çš„ initialize å‡½æ•°ï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œå†™äº†ã€‚\nè¿™é‡Œå®šä¹‰äº†ä¸€äº›å®ä¾‹å˜é‡ï¼Œè¿™äº›å˜é‡æ˜¯å†™è‡ªå®šä¹‰å¼•æ“çš„æ—¶å€™å¯ä»¥ç›´æ¥ç”¨çš„ã€‚\næ¥ç€å¾€ä¸‹çœ‹ï¼š\n# raises error if not defined in onebox engine. # This is the output method for an engine. def to_html fail NoMethodError, \"Engines need to implement this method\" end è¿™ç§å‡½æ•°çœ‹èµ·æ¥å¾ˆå¥‡æ€ªå¯¹ä¸å¯¹ï¼Ÿç›´æ¥æŠ›é”™è¯¯ã€‚å› ä¸º Ruby æ˜¯å¯ä»¥é‡å†™æ–¹æ³•çš„ã€‚ä¸Šé¢ YoukuOnebox çš„ä¾‹å­é‡Œï¼š\ndef to_html \u003c\u003c~HTML \u003ciframe src=\"https://player.youku.com/embed/#{video_id}\" width=\"640\" height=\"430\" frameborder='0' allowfullscreen\u003e \u003c/iframe\u003e HTML end å°±é‡å†™äº†è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ · Engine module è°ƒç”¨æ–¹æ³•çš„æ—¶å€™å®é™…ä¸Šæ˜¯ä¸ç©ºçš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥æ‹ä¸€ä¸‹ Onebox.preview(url, options) çš„æµç¨‹ï¼š\nOnebox.preview è°ƒç”¨Preview.new(url,options),åè€…è°ƒç”¨ Matcher.new(@url, @options).oneboxed, Matcher æ˜¯è·å–å…¨éƒ¨è‡ªå®šä¹‰å¼•æ“åé€šè¿‡åˆ¤æ–­ engine == uriæ¥æ‰¾å‡ºå¯¹åº”å¼•æ“ã€‚\nä¸Šé¢çš„ç†è§£äº†æˆ‘ä»¬å°±å¯ä»¥æ¥ç€ç†è§£ engine == uri äº†ã€‚æˆ‘ä»¬å‰é¢å·²ç»è¯´äº†ï¼Œæ‰€æœ‰çš„è‡ªå®šä¹‰å¼•æ“éƒ½ include Engineäº†ï¼Œå¾—åˆ°äº†ClassMethodsçš„ç±»æ–¹æ³•ï¼Œæœ‰ä¸€ä¸ªç±»æ–¹æ³•å°±æ˜¯è¿™ä¸ªï¼š\ndef ===(other) if other.kind_of?(URI) !!(other.to_s =~ class_variable_get(:@@matcher)) else super end end å¦‚æœæ˜¯æ‹¿ URI æ¥åˆ¤æ–­çš„è¯ï¼Œå…ˆæŠŠå®ƒè½¬æˆå­—ç¬¦ä¸²ï¼Œç„¶åä¸è‡ªå®šä¹‰å¼•æ“çš„ç±»å˜é‡ @@matcher åšæ­£åˆ™åŒ¹é…ï¼Œå°±èƒ½å¤Ÿç¡®ä¿å¼•æ“çš„å”¯ä¸€æ€§ã€‚\nä¸Šé¢ä¹Ÿè¯´äº†ï¼ŒOnebox.preview æœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯ Engine module é‡Œé¢çš„ä¸€ä¸ªè‡ªå®šä¹‰ Classã€‚é‚£ä¹ˆ discourse æ˜¯æ€ä¹ˆä½¿ç”¨è¿™ä¸ª engine çš„å‘¢ï¼Ÿ\nr = Onebox.preview(uri.to_s, options) result = { onebox: r.to_s, preview: r\u0026.placeholder_html.to_s } æˆ‘ä»¬å†æŠŠ discourse çš„è¿™æ®µä»£ç æ‹¿å›æ¥ç†è§£ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ª hashã€‚å…¶ä¸­ onebox æ˜¯è¿™ä¸ªè‡ªå®šä¹‰ class çš„ to_sï¼Œå¼•æ“æ€ä¹ˆè½¬å­—ç¬¦ä¸²å‘¢ï¼Ÿåœ¨ lib/onebox/preview.rb é‡Œé¢ï¼š\ndef to_s return \"\" unless engine sanitize process_html engine_html rescue *WEB_EXCEPTIONS \"\" end å¯¹æˆ‘ä»¬ç”¨å¤„ä¸å¤§ï¼Œç•¥ã€‚é‚£ä¹ˆ preview æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯è°ƒç”¨äº†å¼•æ“çš„ placeholder_html æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ engine.rb é‡Œé¢ã€‚\ndef placeholder_html to_html end å®ƒè°ƒç”¨äº†é»˜è®¤æŠ›é”™è¯¯çš„é‚£ä¸ª to_html æ–¹æ³•ï¼Œè€Œå½“æœ‰äº†ç¡®å®šçš„å¼•æ“åï¼Œto_html æ–¹æ³•æ˜¯è‡ªå®šä¹‰å¼•æ“å®ç°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæƒ³è¦å†™ä¸€ä¸ªè‡ªå®šä¹‰å¼•æ“ï¼Œæœ€æœ€é‡è¦çš„æ–¹æ³•æ˜¯ matches_regexpå’Œto_htmlã€‚\nå¯¹äº Onebox gem çš„ç†è§£åˆ°è¿™é‡Œå°±å¯ä»¥äº†ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†è¦çœŸæ­£å¼€å§‹å†™æˆ‘ä»¬çš„æ’ä»¶ã€‚\n",
  "wordCount" : "1018",
  "inLanguage": "en",
  "datePublished": "2020-11-28T14:59:00+08:00",
  "dateModified": "2020-11-28T14:59:00+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Marguerite Su: Golang/Ruby Programmer, openSUSE Member",
    "logo": {
      "@type": "ImageObject",
      "url": "https://marguerite.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://marguerite.github.io/" accesskey="h" title="Marguerite Su: Golang/Ruby Programmer, openSUSE Member (Alt + H)">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem
    </h1>
    <div class="post-meta"><span title='2020-11-28 14:59:00 +0800 CST'>November 28, 2020</span>

</div>
  </header> 
  <div class="post-content"><h2 id="ä¸º-discourse-å¼€å‘ä¸€ä¸ª-onebox-æ’ä»¶ä¸€ç†è§£-onebox-gem">ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem<a hidden class="anchor" aria-hidden="true" href="#ä¸º-discourse-å¼€å‘ä¸€ä¸ª-onebox-æ’ä»¶ä¸€ç†è§£-onebox-gem">#</a></h2>
<p>æˆ‘ä»¬ <a href="https://forum.suse.org.cn">openSUSE ä¸­æ–‡è®ºå›</a>ç”¨çš„æ˜¯ <a href="https://github.com/discourse/discourse">discourse</a>ï¼Œæœ‰ä¸€å¤©ç»™ç”¨æˆ·è´´äº†ä¸€ä¸ª <a href="http://build.opensuse.org/">OBS</a> çš„é“¾æ¥ï¼Œçªç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯å¯ä»¥è®©å®ƒä¹Ÿèƒ½åƒ github ä¸€æ ·æœ‰ä¸€ä¸ªæ¼‚äº®çš„é¢„è§ˆå°çª—å£ ğŸ¤“ äºæ˜¯è¯´å¹²å°±å¹²ï¼š<a href="https://github.com/openSUSE-zh/discourse-openbuildservice-onebox">discourse-openbuildservice-onebox</a> æ’ä»¶ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æ•™ç¨‹ï¼Œç”±äºæ¶‰åŠåˆ°ç›®å‰æœ€å¤§çš„ Ruby on Rails ç¨‹åº discourseï¼Œä¼šåˆ†æˆå‡ éƒ¨åˆ†æ¥è®²è§£ã€‚ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è¯•ç€ç†è§£ä¸€ä¸‹ discourse å‡ºå“çš„ <a href="https://github.com/discourse/onebox">onebox</a> gemã€‚</p>
<p>Ruby ä½œä¸ºä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œ<strong>æ‰€æœ‰å¯¹è±¡çš„æ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™</strong>ã€‚å­¦åå«åš Meta Programmingã€‚è¿™æ˜¯ç†è§£ onebox gem çš„åŸºç¡€ã€‚</p>
<p>æˆ‘ä»¬ä¸‹é¢æ¥çœ‹ discourse æ˜¯æ€ä¹ˆä½¿ç”¨ onebox gem çš„ï¼Œä¸‹é¢æ˜¯ <a href="https://github.com/discourse/discourse/blob/master/app/models/post_analyzer.rb">app/models/post_analyzer.rb</a> çš„ cook å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠä½ è¾“å…¥çš„æ–‡å­—è½¬ä¸º html ä¿å­˜åœ¨ postgresql æ•°æ®åº“ï¼Œæ˜¯æœ€åŸºç¡€çš„å‡½æ•°ä¹‹ä¸€ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cook</span>(raw, opts <span style="color:#f92672">=</span> {})
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[...]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#66d9ef">Oneboxer</span><span style="color:#f92672">.</span>apply(cooked) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>url<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      @onebox_urls <span style="color:#f92672">&lt;&lt;</span> url
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> opts<span style="color:#f92672">[</span><span style="color:#e6db74">:invalidate_oneboxes</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">Oneboxer</span><span style="color:#f92672">.</span>invalidate(url)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">InlineOneboxer</span><span style="color:#f92672">.</span>invalidate(url)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      onebox <span style="color:#f92672">=</span> <span style="color:#66d9ef">Oneboxer</span><span style="color:#f92672">.</span>cached_onebox(url)
</span></span><span style="display:flex;"><span>      @found_oneboxes <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">if</span> onebox<span style="color:#f92672">.</span>present?
</span></span><span style="display:flex;"><span>      onebox
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cooked <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>to_html <span style="color:#66d9ef">if</span> result<span style="color:#f92672">.</span>changed?
</span></span><span style="display:flex;"><span>    cooked
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ° discourse è‡ªå·±è¿˜æœ‰ä¸€ä¸ª Oneboxer çš„ wrapperï¼Œè¿™é‡Œä½¿ç”¨äº† Oneboxer.apply å’Œ Oneboxer.cache_onebox å‡½æ•°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ‹ <a href="https://github.com/discourse/discourse/blob/master/lib/oneboxer.rb">lib/oneboxer.rb</a>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span>(string_or_doc, <span style="color:#e6db74">extra_paths</span>: <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    doc <span style="color:#f92672">=</span> string_or_doc
</span></span><span style="display:flex;"><span>    doc <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nokogiri</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTML5</span><span style="color:#f92672">::</span>fragment(doc) <span style="color:#66d9ef">if</span> doc<span style="color:#f92672">.</span>is_a?(String)
</span></span><span style="display:flex;"><span>    changed <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    each_onebox_link(doc, <span style="color:#e6db74">extra_paths</span>: extra_paths) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>url, element<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      onebox, _ <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span>(url, element)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> onebox
</span></span><span style="display:flex;"><span>        parsed_onebox <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nokogiri</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTML5</span><span style="color:#f92672">::</span>fragment(onebox)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">next</span> <span style="color:#66d9ef">unless</span> parsed_onebox<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> element<span style="color:#f92672">&amp;.</span>parent<span style="color:#f92672">&amp;.</span>node_name<span style="color:#f92672">&amp;.</span>downcase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;p&#34;</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>           element<span style="color:#f92672">.</span>parent<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>count <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">HTML5_BLOCK_ELEMENTS</span><span style="color:#f92672">.</span>include?(parsed_onebox<span style="color:#f92672">.</span>children<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">].</span>node_name<span style="color:#f92672">.</span>downcase)
</span></span><span style="display:flex;"><span>          element <span style="color:#f92672">=</span> element<span style="color:#f92672">.</span>parent
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        changed <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        element<span style="color:#f92672">.</span>swap parsed_onebox<span style="color:#f92672">.</span>to_html
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># strip empty &lt;p&gt; elements</span>
</span></span><span style="display:flex;"><span>    doc<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#34;p&#34;</span>)<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>p<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> p<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>empty? <span style="color:#f92672">&amp;&amp;</span> doc<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>remove
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Result</span><span style="color:#f92672">.</span>new(doc, changed)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>è¿™æ®µå…¶å®æ²¡å•¥ç”¨ï¼Œç®€å•è§£é‡Šä¸‹å°±æ˜¯å–åˆ° cooked è¿™ä¸ª html é‡Œéœ€è¦ onebox åŒ–çš„ URL nodeã€‚ç„¶å invalidate ä¹‹åå– cached_oneboxã€‚cached_onebox ä¸å®é™…è¿›è¡Œ onebox åŒ–é‡Œé¢æœ‰å¤ªå¤šçš„åˆ¤æ–­ä»£ç ï¼ˆonebox_raw)ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ Oneboxer çš„è¿™ä¸ªå‡½æ•°å°±å¤Ÿäº†ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">external_onebox</span>(url)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Discourse</span><span style="color:#f92672">.</span>cache<span style="color:#f92672">.</span>fetch(onebox_cache_key(url), <span style="color:#e6db74">expires_in</span>: <span style="color:#ae81ff">1</span><span style="color:#f92672">.</span>day) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      fd <span style="color:#f92672">=</span> <span style="color:#66d9ef">FinalDestination</span><span style="color:#f92672">.</span>new(url,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">ignore_redirects</span>: ignore_redirects,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">ignore_hostnames</span>: blocked_domains,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">force_get_hosts</span>: force_get_hosts,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">force_custom_user_agent_hosts</span>: force_custom_user_agent_hosts,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">preserve_fragment_url_hosts</span>: preserve_fragment_url_hosts)
</span></span><span style="display:flex;"><span>      uri <span style="color:#f92672">=</span> fd<span style="color:#f92672">.</span>resolve
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> fd<span style="color:#f92672">.</span>status <span style="color:#f92672">!=</span> <span style="color:#e6db74">:resolved</span>
</span></span><span style="display:flex;"><span>        args <span style="color:#f92672">=</span> { <span style="color:#e6db74">link</span>: url }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> fd<span style="color:#f92672">.</span>status <span style="color:#f92672">==</span> <span style="color:#e6db74">:invalid_address</span>
</span></span><span style="display:flex;"><span>          args<span style="color:#f92672">[</span><span style="color:#e6db74">:error_message</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">I18n</span><span style="color:#f92672">.</span>t(<span style="color:#e6db74">&#34;errors.onebox.invalid_address&#34;</span>, <span style="color:#e6db74">hostname</span>: fd<span style="color:#f92672">.</span>hostname)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elsif</span> fd<span style="color:#f92672">.</span>status_code
</span></span><span style="display:flex;"><span>          args<span style="color:#f92672">[</span><span style="color:#e6db74">:error_message</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">I18n</span><span style="color:#f92672">.</span>t(<span style="color:#e6db74">&#34;errors.onebox.error_response&#34;</span>, <span style="color:#e6db74">status_code</span>: fd<span style="color:#f92672">.</span>status_code)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        error_box <span style="color:#f92672">=</span> blank_onebox
</span></span><span style="display:flex;"><span>        error_box<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> preview_error_onebox(args)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> error_box
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> blank_onebox <span style="color:#66d9ef">if</span> uri<span style="color:#f92672">.</span>blank? <span style="color:#f92672">||</span> blocked_domains<span style="color:#f92672">.</span>map { <span style="color:#f92672">|</span>hostname<span style="color:#f92672">|</span> uri<span style="color:#f92672">.</span>hostname<span style="color:#f92672">.</span>match?(hostname) }<span style="color:#f92672">.</span>any?
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      options <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">max_width</span>: <span style="color:#ae81ff">695</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">sanitize_config</span>: <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">::</span><span style="color:#66d9ef">DiscourseOneboxSanitizeConfig</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Config</span><span style="color:#f92672">::</span><span style="color:#66d9ef">DISCOURSE_ONEBOX</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">allowed_iframe_origins</span>: allowed_iframe_origins,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">hostname</span>: <span style="color:#66d9ef">GlobalSetting</span><span style="color:#f92672">.</span>hostname,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">facebook_app_access_token</span>: <span style="color:#66d9ef">SiteSetting</span><span style="color:#f92672">.</span>facebook_app_access_token,
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      options<span style="color:#f92672">[</span><span style="color:#e6db74">:cookie</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> fd<span style="color:#f92672">.</span>cookie <span style="color:#66d9ef">if</span> fd<span style="color:#f92672">.</span>cookie
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      r <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>preview(uri<span style="color:#f92672">.</span>to_s, options)
</span></span><span style="display:flex;"><span>      result <span style="color:#f92672">=</span> { <span style="color:#e6db74">onebox</span>: r<span style="color:#f92672">.</span>to_s, <span style="color:#e6db74">preview</span>: r<span style="color:#f92672">&amp;.</span>placeholder_html<span style="color:#f92672">.</span>to_s }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># NOTE: Call r.errors after calling placeholder_html</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>any?
</span></span><span style="display:flex;"><span>        missing_attributes <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>map(<span style="color:#f92672">&amp;</span><span style="color:#e6db74">:to_s</span>)<span style="color:#f92672">.</span>sort<span style="color:#f92672">.</span>join(<span style="color:#66d9ef">I18n</span><span style="color:#f92672">.</span>t(<span style="color:#e6db74">&#34;word_connector.comma&#34;</span>))
</span></span><span style="display:flex;"><span>        error_message <span style="color:#f92672">=</span> <span style="color:#66d9ef">I18n</span><span style="color:#f92672">.</span>t(<span style="color:#e6db74">&#34;errors.onebox.missing_data&#34;</span>, <span style="color:#e6db74">missing_attributes</span>: missing_attributes, <span style="color:#e6db74">count</span>: r<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>size)
</span></span><span style="display:flex;"><span>        args <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>merge(<span style="color:#e6db74">error_message</span>: error_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> result<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">].</span>blank?
</span></span><span style="display:flex;"><span>          result<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> preview_error_onebox(args)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          doc <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nokogiri</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTML5</span><span style="color:#f92672">::</span>fragment(result<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">]</span>)
</span></span><span style="display:flex;"><span>          aside <span style="color:#f92672">=</span> doc<span style="color:#f92672">.</span>at(<span style="color:#e6db74">&#39;aside&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> aside
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Add an error message to the preview that was returned</span>
</span></span><span style="display:flex;"><span>            error_fragment <span style="color:#f92672">=</span> preview_error_onebox_fragment(args)
</span></span><span style="display:flex;"><span>            aside<span style="color:#f92672">.</span>add_child(error_fragment)
</span></span><span style="display:flex;"><span>            result<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> doc<span style="color:#f92672">.</span>to_html
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      result
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>preview(uri<span style="color:#f92672">.</span>to_s, options)
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> { <span style="color:#e6db74">onebox</span>: r<span style="color:#f92672">.</span>to_s, <span style="color:#e6db74">preview</span>: r<span style="color:#f92672">&amp;.</span>placeholder_html<span style="color:#f92672">.</span>to_s }
</span></span></code></pre></div><p>è¿™æ®µæ˜¯æœ€ä¸»è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Onebox è¿™ä¸ª gem æ˜¯é€šè¿‡å®ƒçš„ preview å‡½æ•°æ¥ä¸ discourse è¿›è¡Œäº¤äº’çš„ã€‚discourse ä»£ç çœ‹åˆ°è¿™é‡Œå°±å¤Ÿäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ onebox ä»£ç ã€‚</p>
<p>ä¸€ä¸ª rubygem æœ€é‡è¦çš„æ˜¯å®ƒçš„ lib æ–‡ä»¶å¤¹ã€‚æˆ‘ä»¬å…ˆä» <a href="https://github.com/discourse/onebox/blob/master/lib/onebox.rb">lib/onebox.rb</a> çœ‹èµ·ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">preview</span>(url, options <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># onebox does not have native caching</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unless</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Helpers</span><span style="color:#f92672">.</span>blank?(options<span style="color:#f92672">[</span><span style="color:#e6db74">:cache</span><span style="color:#f92672">]</span>)
</span></span><span style="display:flex;"><span>      warn <span style="color:#e6db74">&#34;Onebox no longer has inbuilt caching so `cache` option will be ignored.&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Preview</span><span style="color:#f92672">.</span>new(url, options)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>è¿™å°±æ˜¯ä¸Šé¢çš„ <code>Onebox.preview</code> çš„æ¥æºã€‚æœ€é‡è¦çš„æ˜¯ Preview è¿™ä¸ª classã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€çœ‹ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/preview.rb">lib/onebox/preview.rb</a>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Preview</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># see https://bugs.ruby-lang.org/issues/14688</span>
</span></span><span style="display:flex;"><span>    client_exception <span style="color:#f92672">=</span> defined?(<span style="color:#66d9ef">Net</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPClientException</span>) ? <span style="color:#66d9ef">Net</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPClientException</span> : <span style="color:#66d9ef">Net</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPServerException</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">WEB_EXCEPTIONS</span> <span style="color:#f92672">||=</span> <span style="color:#f92672">[</span>client_exception, <span style="color:#66d9ef">OpenURI</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPError</span>, <span style="color:#66d9ef">Timeout</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Error</span>, <span style="color:#66d9ef">Net</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPError</span>, <span style="color:#66d9ef">Errno</span><span style="color:#f92672">::</span><span style="color:#66d9ef">ECONNREFUSED</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(link, options <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options)
</span></span><span style="display:flex;"><span>      @url <span style="color:#f92672">=</span> link
</span></span><span style="display:flex;"><span>      @options <span style="color:#f92672">=</span> options<span style="color:#f92672">.</span>dup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      allowed_origins <span style="color:#f92672">=</span> @options<span style="color:#f92672">[</span><span style="color:#e6db74">:allowed_iframe_origins</span><span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Engine</span><span style="color:#f92672">.</span>all_iframe_origins
</span></span><span style="display:flex;"><span>      @options<span style="color:#f92672">[</span><span style="color:#e6db74">:allowed_iframe_regexes</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Engine</span><span style="color:#f92672">.</span>origins_to_regexes(allowed_origins)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      @engine_class <span style="color:#f92672">=</span> <span style="color:#66d9ef">Matcher</span><span style="color:#f92672">.</span>new(@url, @options)<span style="color:#f92672">.</span>oneboxed
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ®µä»£ç çš„æ„æ€æ˜¯è¯´æ ¹æ® Matcher æ¥åŒ¹é… URL ä»è€Œå– oneboxed çš„ç»“æœã€‚æ¥ç€çœ‹ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/matcher.rb">lib/onebox/matcher.rb</a>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Matcher</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(link, options <span style="color:#f92672">=</span> {})
</span></span><span style="display:flex;"><span>      @url <span style="color:#f92672">=</span> link
</span></span><span style="display:flex;"><span>      @options <span style="color:#f92672">=</span> options
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ordered_engines</span>
</span></span><span style="display:flex;"><span>      @ordered_engines <span style="color:#f92672">||=</span> <span style="color:#66d9ef">Engine</span><span style="color:#f92672">.</span>engines<span style="color:#f92672">.</span>sort_by <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>e<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span>respond_to?(<span style="color:#e6db74">:priority</span>) ? e<span style="color:#f92672">.</span>priority : <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">oneboxed</span>
</span></span><span style="display:flex;"><span>      uri <span style="color:#f92672">=</span> <span style="color:#66d9ef">URI</span>(@url)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">unless</span> uri<span style="color:#f92672">.</span>port<span style="color:#f92672">.</span>nil? <span style="color:#f92672">||</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>allowed_ports<span style="color:#f92672">.</span>include?(uri<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">unless</span> uri<span style="color:#f92672">.</span>scheme<span style="color:#f92672">.</span>nil? <span style="color:#f92672">||</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>allowed_schemes<span style="color:#f92672">.</span>include?(uri<span style="color:#f92672">.</span>scheme)
</span></span><span style="display:flex;"><span>      ordered_engines<span style="color:#f92672">.</span>find { <span style="color:#f92672">|</span>engine<span style="color:#f92672">|</span> engine <span style="color:#f92672">===</span> uri <span style="color:#f92672">&amp;&amp;</span> has_allowed_iframe_origins?(engine) }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rescue</span> <span style="color:#66d9ef">URI</span><span style="color:#f92672">::</span><span style="color:#66d9ef">InvalidURIError</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>è¿™æ®µä»£ç çš„æ„æ€æ˜¯ä» <code>ordered_engines</code> é‡Œæ‰¾åˆ°åŒ¹é… uri çš„ engineã€‚è¿”å›è¿™ä¸ª engineã€‚è€Œ <code>ordered_engines</code> æ¥è‡ª <code>Engine.engines</code>ã€‚æˆ‘ä»¬æ¥çœ‹æœ€é‡è¦çš„ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/engine.rb">lib/onebox/engine.rb</a>ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">module</span> Engine
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">included</span>(object)
</span></span><span style="display:flex;"><span>      object<span style="color:#f92672">.</span>extend(<span style="color:#66d9ef">ClassMethods</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">engines</span>
</span></span><span style="display:flex;"><span>      constants<span style="color:#f92672">.</span>select <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>constant<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        constant<span style="color:#f92672">.</span>to_s <span style="color:#f92672">=~</span> <span style="color:#e6db74">/Onebox$/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span><span style="color:#f92672">.</span>map(<span style="color:#f92672">&amp;</span>method(<span style="color:#e6db74">:const_get</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;helpers&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;layout_support&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;file_type_finder&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/standard_embed&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/html&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/json&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/amazon_onebox&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/github_issue_onebox&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/github_blob_onebox&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[...]</span>
</span></span></code></pre></div><p>è¿™é‡Œçš„ included å‡½æ•°å…¶å®æ˜¯ä¸€ä¸ªè¢«é‡å†™çš„å†…ç½®å‡½æ•°ã€‚å®ƒæ˜¯ ruby çš„ module å‡½æ•°ï¼Œæ„æ€æ˜¯è¿™ä¸ª module è¢« included åˆ°åˆ«çš„ Object é‡Œçš„æ—¶å€™ä¼šåšä»€ä¹ˆã€‚ä¹Ÿå°±æ˜¯è¯´ <code>module Engine</code> è¿™ä¸ªæ¨¡å—è¢«åˆ«çš„ Class/Module è¿™æ · include çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> A
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Engine</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>è¿™é‡Œæ‰€æœ‰ include äº† module Engine çš„ Class éƒ½ä¼šè‡ªåŠ¨è·å¾— ClassMethods çš„ç±»æ–¹æ³•ï¼ŒClassMethods æ¨¡å—åœ¨åé¢ä¸€ç‚¹çš„åœ°æ–¹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">module</span> ClassMethods
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">===</span>(other)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> other<span style="color:#f92672">.</span>kind_of?(<span style="color:#66d9ef">URI</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">!!</span>(other<span style="color:#f92672">.</span>to_s <span style="color:#f92672">=~</span> class_variable_get(<span style="color:#e6db74">:@@matcher</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">super</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">priority</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">matches_regexp</span>(r)
</span></span><span style="display:flex;"><span>        class_variable_set <span style="color:#e6db74">:@@matcher</span>, r
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">requires_iframe_origins</span>(<span style="color:#f92672">*</span>origins)
</span></span><span style="display:flex;"><span>        class_variable_set <span style="color:#e6db74">:@@iframe_origins</span>, origins
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iframe_origins</span>
</span></span><span style="display:flex;"><span>        class_variable_defined?(<span style="color:#e6db74">:@@iframe_origins</span>) ? class_variable_get(<span style="color:#e6db74">:@@iframe_origins</span>) : <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># calculates a name for onebox using the class name of engine</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onebox_name</span>
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;::&#34;</span>)<span style="color:#f92672">.</span>last<span style="color:#f92672">.</span>downcase<span style="color:#f92672">.</span>gsub(<span style="color:#e6db74">/onebox/</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">always_https</span>
</span></span><span style="display:flex;"><span>        @https <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">always_https?</span>
</span></span><span style="display:flex;"><span>        @https
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">module</span> Engine
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">YoukuOnebox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Engine</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">HTML</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      matches_regexp(<span style="color:#e6db74">/^(https?:\/\/)?([\da-z\.-]+)(youku.com\/)(.)+\/?$/</span>)
</span></span><span style="display:flex;"><span>      requires_iframe_origins <span style="color:#e6db74">&#34;https://player.youku.com&#34;</span>
</span></span></code></pre></div><p>è¿™æ˜¯ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/engine/youku_onebox.rb">lib/onebox/engine/youku_onebox.rb</a>ã€‚å› ä¸º <code>include Engine</code>ï¼Œæ‰€ä»¥è‡ªåŠ¨è·å¾— matches_regexp è¿™ä¸ªç±»æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>matches_regexp(<span style="color:#e6db74">/^(https?:\/\/)?([\da-z\.-]+)(youku.com\/)(.)+\/?$/</span>)
</span></span></code></pre></div><p>æ¥å°† YoukuOnebox è¿™ä¸ª Class çš„ç±»å…¨å±€å˜é‡ <code>@@matcher</code> è®¾ç½®ä¸ºä¸Šé¢çš„ regexpã€‚é€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘ä»¬åº”è¯¥å¤§æ¦‚å¯ä»¥æ˜ç™½ä¸ºä»€ä¹ˆèƒ½å¤Ÿåˆšå®šä¹‰ä¸€ä¸ªæ–°ç±»å°±æ‹¥æœ‰é‚£ä¹ˆå¤šçš„ç±»æ–¹æ³•äº†ã€‚åŒæ ·åŠŸæ•ˆçš„è¿˜æœ‰ <code>include HTML</code>ï¼Œ<code>include JSON</code>ç­‰ç­‰ã€‚ä¸‹ä¸€ç¯‡ç”¨çš„çš„æ—¶å€™å†ç»™å¤§å®¶çœ‹ä»£ç ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹ç¬¬äºŒä¸ªæ–¹æ³•ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">engines</span>
</span></span><span style="display:flex;"><span>      constants<span style="color:#f92672">.</span>select <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>constant<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        constant<span style="color:#f92672">.</span>to_s <span style="color:#f92672">=~</span> <span style="color:#e6db74">/Onebox$/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span><span style="color:#f92672">.</span>map(<span style="color:#f92672">&amp;</span>method(<span style="color:#e6db74">:const_get</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>å¾ˆå¤šæ–°æ‰‹è¿™æ—¶å€™å°±æ— æ³•ç†è§£äº†ã€‚<a href="https://apidock.com/ruby/Module/constants">constants</a> æ˜¯ä»€ä¹ˆï¼Ÿå®ƒå…¶å® ruby çš„ä¸€ä¸ª Module æ–¹æ³•ã€‚è¿”å›è¿™ä¸ª module çš„æ‰€æœ‰å¸¸é‡ï¼Œå®šä¹‰åœ¨ Module å†…éƒ¨çš„ Class ä¹Ÿæ˜¯å¸¸é‡ï¼Œç»™æ®µæµ‹è¯•ä»£ç ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> A
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> C
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">include</span> A
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">test</span>
</span></span><span style="display:flex;"><span>   p constants
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>C<span style="color:#f92672">.</span>test
</span></span></code></pre></div><p>ä¸Šé¢è¿è¡Œ C.test çš„ç»“æœæ˜¯ <code>[:B]</code>ã€‚ç±»å B æ˜¯ C çš„å¸¸é‡ã€‚é‚£ä¹ˆ <code>self.engines</code> è¿™ä¸ªå‡½æ•°å…¶å®å°±å¥½ç†è§£äº†ã€‚ä» Engine module çš„å…¨éƒ¨ç±»ä¸­æ‰¾åˆ°ä»¥ <code>Onebox</code> ç»“å°¾çš„ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚ä¸Šé¢ Youku çš„é‚£ä¸ªä¾‹å­æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ï¼Œæ‰€æœ‰çš„è‡ªå®šä¹‰ Engine éƒ½æ˜¯è¿™ä¸ªç»“æ„ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">module</span> Engine
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">YoukuOnebox</span>
</span></span></code></pre></div><p>ç›®çš„å°±æ˜¯è®© <code>self.engines</code> å‡½æ•°èƒ½å¤ŸçŸ¥é“å®ƒçš„å­˜åœ¨ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(link, timeout <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>      @errors <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>      @options <span style="color:#f92672">=</span> <span style="color:#66d9ef">DEFAULT</span>
</span></span><span style="display:flex;"><span>      class_name <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>class<span style="color:#f92672">.</span>name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;::&#34;</span>)<span style="color:#f92672">.</span>last<span style="color:#f92672">.</span>to_s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Set the engine options extracted from global options.</span>
</span></span><span style="display:flex;"><span>      self<span style="color:#f92672">.</span>options <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options<span style="color:#f92672">[</span>class_name<span style="color:#f92672">]</span> <span style="color:#f92672">||</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      @url <span style="color:#f92672">=</span> link
</span></span><span style="display:flex;"><span>      @uri <span style="color:#f92672">=</span> <span style="color:#66d9ef">URI</span>(link)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> always_https?
</span></span><span style="display:flex;"><span>        @uri<span style="color:#f92672">.</span>scheme <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https&#39;</span>
</span></span><span style="display:flex;"><span>        @url <span style="color:#f92672">=</span> @uri<span style="color:#f92672">.</span>to_s
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      @timeout <span style="color:#f92672">=</span> timeout <span style="color:#f92672">||</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>timeout
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>æ˜¯ä¸æ˜¯å¾ˆæœ‰æ„æ€ï¼Œä¸€ä¸ª Module å±…ç„¶æœ‰ initialize å‡½æ•°ï¼ä»–çš„ä½œç”¨æ˜¯ï¼Œinclude å®ƒçš„ class çš„ new instance ç”Ÿæˆçš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ª class æœ¬èº«æ²¡æœ‰å†™ initialize å‡½æ•°ï¼Œé‚£ä¹ˆè¿è¡Œ module å¸¦çš„ã€‚è¦æ˜¯å†™äº†ï¼Œåœ¨ class çš„ initialize å‡½æ•°é‡Œå¯ä»¥è¿è¡Œ super æ¥è¿è¡Œ module å¸¦çš„ã€‚æˆ‘ä»¬çœ‹ engine æ–‡ä»¶å¤¹é‡Œæ‰€æœ‰çš„è‡ªå®šä¹‰å¼•æ“éƒ½æ²¡æœ‰å†™è‡ªå·±çš„ initialize å‡½æ•°ï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œå†™äº†ã€‚</p>
<p>è¿™é‡Œå®šä¹‰äº†ä¸€äº›å®ä¾‹å˜é‡ï¼Œè¿™äº›å˜é‡æ˜¯å†™è‡ªå®šä¹‰å¼•æ“çš„æ—¶å€™å¯ä»¥ç›´æ¥ç”¨çš„ã€‚</p>
<p>æ¥ç€å¾€ä¸‹çœ‹ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#75715e"># raises error if not defined in onebox engine.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This is the output method for an engine.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_html</span>
</span></span><span style="display:flex;"><span>      fail <span style="color:#66d9ef">NoMethodError</span>, <span style="color:#e6db74">&#34;Engines need to implement this method&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>è¿™ç§å‡½æ•°çœ‹èµ·æ¥å¾ˆå¥‡æ€ªå¯¹ä¸å¯¹ï¼Ÿç›´æ¥æŠ›é”™è¯¯ã€‚å› ä¸º Ruby æ˜¯å¯ä»¥é‡å†™æ–¹æ³•çš„ã€‚ä¸Šé¢ YoukuOnebox çš„ä¾‹å­é‡Œï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;&lt;~</span><span style="color:#66d9ef">HTML</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;</span>iframe src<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://player.youku.com/embed/</span><span style="color:#e6db74">#{</span>video_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                  width<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;640&#34;</span>
</span></span><span style="display:flex;"><span>                  height<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;430&#34;</span>
</span></span><span style="display:flex;"><span>                  frameborder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>                  allowfullscreen<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;</span><span style="color:#e6db74">/iframe&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        HTML
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      end
</span></span></span></code></pre></div><p>å°±é‡å†™äº†è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ · Engine module è°ƒç”¨æ–¹æ³•çš„æ—¶å€™å®é™…ä¸Šæ˜¯ä¸ç©ºçš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥æ‹ä¸€ä¸‹ <code>Onebox.preview(url, options)</code> çš„æµç¨‹ï¼š</p>
<p><code>Onebox.preview</code> è°ƒç”¨<code>Preview.new(url,options)</code>,åè€…è°ƒç”¨ <code>Matcher.new(@url, @options).oneboxed</code>, Matcher æ˜¯è·å–å…¨éƒ¨è‡ªå®šä¹‰å¼•æ“åé€šè¿‡åˆ¤æ–­ <code>engine == uri</code>æ¥æ‰¾å‡ºå¯¹åº”å¼•æ“ã€‚</p>
<p>ä¸Šé¢çš„ç†è§£äº†æˆ‘ä»¬å°±å¯ä»¥æ¥ç€ç†è§£ <code>engine == uri</code> äº†ã€‚æˆ‘ä»¬å‰é¢å·²ç»è¯´äº†ï¼Œæ‰€æœ‰çš„è‡ªå®šä¹‰å¼•æ“éƒ½ <code>include Engine</code>äº†ï¼Œå¾—åˆ°äº†<code>ClassMethods</code>çš„ç±»æ–¹æ³•ï¼Œæœ‰ä¸€ä¸ªç±»æ–¹æ³•å°±æ˜¯è¿™ä¸ªï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">===</span>(other)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> other<span style="color:#f92672">.</span>kind_of?(<span style="color:#66d9ef">URI</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">!!</span>(other<span style="color:#f92672">.</span>to_s <span style="color:#f92672">=~</span> class_variable_get(<span style="color:#e6db74">:@@matcher</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">super</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>å¦‚æœæ˜¯æ‹¿ URI æ¥åˆ¤æ–­çš„è¯ï¼Œå…ˆæŠŠå®ƒè½¬æˆå­—ç¬¦ä¸²ï¼Œç„¶åä¸è‡ªå®šä¹‰å¼•æ“çš„ç±»å˜é‡ <code>@@matcher</code> åšæ­£åˆ™åŒ¹é…ï¼Œå°±èƒ½å¤Ÿç¡®ä¿å¼•æ“çš„å”¯ä¸€æ€§ã€‚</p>
<p>ä¸Šé¢ä¹Ÿè¯´äº†ï¼ŒOnebox.preview æœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯ Engine module é‡Œé¢çš„ä¸€ä¸ªè‡ªå®šä¹‰ Classã€‚é‚£ä¹ˆ discourse æ˜¯æ€ä¹ˆä½¿ç”¨è¿™ä¸ª engine çš„å‘¢ï¼Ÿ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>preview(uri<span style="color:#f92672">.</span>to_s, options)
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> { <span style="color:#e6db74">onebox</span>: r<span style="color:#f92672">.</span>to_s, <span style="color:#e6db74">preview</span>: r<span style="color:#f92672">&amp;.</span>placeholder_html<span style="color:#f92672">.</span>to_s }
</span></span></code></pre></div><p>æˆ‘ä»¬å†æŠŠ discourse çš„è¿™æ®µä»£ç æ‹¿å›æ¥ç†è§£ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ª hashã€‚å…¶ä¸­ onebox æ˜¯è¿™ä¸ªè‡ªå®šä¹‰ class çš„ to_sï¼Œå¼•æ“æ€ä¹ˆè½¬å­—ç¬¦ä¸²å‘¢ï¼Ÿåœ¨ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/preview.rb">lib/onebox/preview.rb</a> é‡Œé¢ï¼š</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#66d9ef">unless</span> engine
</span></span><span style="display:flex;"><span>      sanitize process_html engine_html
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rescue</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">WEB_EXCEPTIONS</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>å¯¹æˆ‘ä»¬ç”¨å¤„ä¸å¤§ï¼Œç•¥ã€‚é‚£ä¹ˆ preview æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯è°ƒç”¨äº†å¼•æ“çš„ placeholder_html æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ engine.rb é‡Œé¢ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">placeholder_html</span>
</span></span><span style="display:flex;"><span>      to_html
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>å®ƒè°ƒç”¨äº†é»˜è®¤æŠ›é”™è¯¯çš„é‚£ä¸ª to_html æ–¹æ³•ï¼Œè€Œå½“æœ‰äº†ç¡®å®šçš„å¼•æ“åï¼Œto_html æ–¹æ³•æ˜¯è‡ªå®šä¹‰å¼•æ“å®ç°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæƒ³è¦å†™ä¸€ä¸ªè‡ªå®šä¹‰å¼•æ“ï¼Œæœ€æœ€é‡è¦çš„æ–¹æ³•æ˜¯ <code>matches_regexp</code>å’Œ<code>to_html</code>ã€‚</p>
<p>å¯¹äº Onebox gem çš„ç†è§£åˆ°è¿™é‡Œå°±å¯ä»¥äº†ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†è¦çœŸæ­£å¼€å§‹å†™æˆ‘ä»¬çš„æ’ä»¶ã€‚</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="marguerite/marguerite.github.io"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://marguerite.github.io/">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a></span> Â· 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>

<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
</head>
<body>
	<header>
	<a href="https://marguerite.github.io">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a>
	
</header>

	
	<main>
		<article>
			<h1>ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem</h1>
			<time>28.11.2020 14:59</time>
			<div>
				<h2 id="ä¸º-discourse-å¼€å‘ä¸€ä¸ª-onebox-æ’ä»¶ä¸€ç†è§£-onebox-gem">ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem</h2>
<p>æˆ‘ä»¬ <a href="https://forum.suse.org.cn">openSUSE ä¸­æ–‡è®ºå›</a>ç”¨çš„æ˜¯ <a href="https://github.com/discourse/discourse">discourse</a>ï¼Œæœ‰ä¸€å¤©ç»™ç”¨æˆ·è´´äº†ä¸€ä¸ª <a href="http://build.opensuse.org/">OBS</a> çš„é“¾æ¥ï¼Œçªç„¶æƒ³åˆ°æ˜¯ä¸æ˜¯å¯ä»¥è®©å®ƒä¹Ÿèƒ½åƒ github ä¸€æ ·æœ‰ä¸€ä¸ªæ¼‚äº®çš„é¢„è§ˆå°çª—å£ ğŸ¤“ äºæ˜¯è¯´å¹²å°±å¹²ï¼š<a href="https://github.com/openSUSE-zh/discourse-openbuildservice-onebox">discourse-openbuildservice-onebox</a> æ’ä»¶ã€‚</p>
<p>ä»¥ä¸‹æ˜¯æ•™ç¨‹ï¼Œç”±äºæ¶‰åŠåˆ°ç›®å‰æœ€å¤§çš„ Ruby on Rails ç¨‹åº discourseï¼Œä¼šåˆ†æˆå‡ éƒ¨åˆ†æ¥è®²è§£ã€‚ç¬¬ä¸€éƒ¨åˆ†æˆ‘ä»¬æ¥è¯•ç€ç†è§£ä¸€ä¸‹ discourse å‡ºå“çš„ <a href="https://github.com/discourse/onebox">onebox</a> gemã€‚</p>
<p>Ruby ä½œä¸ºä¸€é—¨è„šæœ¬è¯­è¨€ï¼Œ<strong>æ‰€æœ‰å¯¹è±¡çš„æ–¹æ³•éƒ½å¯ä»¥è¢«é‡å†™</strong>ã€‚å­¦åå«åš Meta Programmingã€‚è¿™æ˜¯ç†è§£ onebox gem çš„åŸºç¡€ã€‚</p>
<p>æˆ‘ä»¬ä¸‹é¢æ¥çœ‹ discourse æ˜¯æ€ä¹ˆä½¿ç”¨ onebox gem çš„ï¼Œä¸‹é¢æ˜¯ <a href="https://github.com/discourse/discourse/blob/master/app/models/post_analyzer.rb">app/models/post_analyzer.rb</a> çš„ cook å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æŠŠä½ è¾“å…¥çš„æ–‡å­—è½¬ä¸º html ä¿å­˜åœ¨ postgresql æ•°æ®åº“ï¼Œæ˜¯æœ€åŸºç¡€çš„å‡½æ•°ä¹‹ä¸€ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">  <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">cook</span>(raw, opts <span style="color:#000;font-weight:bold">=</span> {})
    <span style="color:#000;font-weight:bold">[...]</span>

    result <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Oneboxer</span><span style="color:#000;font-weight:bold">.</span>apply(cooked) <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span>url<span style="color:#000;font-weight:bold">|</span>
      <span style="color:#008080">@onebox_urls</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> url
      <span style="color:#000;font-weight:bold">if</span> opts<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:invalidate_oneboxes</span><span style="color:#000;font-weight:bold">]</span>
        <span style="color:#008080">Oneboxer</span><span style="color:#000;font-weight:bold">.</span>invalidate(url)
        <span style="color:#008080">InlineOneboxer</span><span style="color:#000;font-weight:bold">.</span>invalidate(url)
      <span style="color:#000;font-weight:bold">end</span>
      onebox <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Oneboxer</span><span style="color:#000;font-weight:bold">.</span>cached_onebox(url)
      <span style="color:#008080">@found_oneboxes</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span> <span style="color:#000;font-weight:bold">if</span> onebox<span style="color:#000;font-weight:bold">.</span>present?
      onebox
    <span style="color:#000;font-weight:bold">end</span>

    cooked <span style="color:#000;font-weight:bold">=</span> result<span style="color:#000;font-weight:bold">.</span>to_html <span style="color:#000;font-weight:bold">if</span> result<span style="color:#000;font-weight:bold">.</span>changed?
    cooked
  <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ° discourse è‡ªå·±è¿˜æœ‰ä¸€ä¸ª Oneboxer çš„ wrapperï¼Œè¿™é‡Œä½¿ç”¨äº† Oneboxer.apply å’Œ Oneboxer.cache_onebox å‡½æ•°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ç€çœ‹ <a href="https://github.com/discourse/discourse/blob/master/lib/oneboxer.rb">lib/oneboxer.rb</a>ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">  <span style="color:#000;font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#900;font-weight:bold">apply</span>(string_or_doc, <span style="color:#990073">extra_paths</span>: <span style="color:#000;font-weight:bold">nil</span>)
    doc <span style="color:#000;font-weight:bold">=</span> string_or_doc
    doc <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Nokogiri</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">HTML5</span><span style="color:#000;font-weight:bold">::</span>fragment(doc) <span style="color:#000;font-weight:bold">if</span> doc<span style="color:#000;font-weight:bold">.</span>is_a?(<span style="color:#0086b3">String</span>)
    changed <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">false</span>

    each_onebox_link(doc, <span style="color:#990073">extra_paths</span>: extra_paths) <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span>url, element<span style="color:#000;font-weight:bold">|</span>
      onebox, _ <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">yield</span>(url, element)

      <span style="color:#000;font-weight:bold">if</span> onebox
        parsed_onebox <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Nokogiri</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">HTML5</span><span style="color:#000;font-weight:bold">::</span>fragment(onebox)
        <span style="color:#000;font-weight:bold">next</span> <span style="color:#000;font-weight:bold">unless</span> parsed_onebox<span style="color:#000;font-weight:bold">.</span>children<span style="color:#000;font-weight:bold">.</span>count <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">0</span>

        <span style="color:#000;font-weight:bold">if</span> element<span style="color:#000;font-weight:bold">&amp;.</span>parent<span style="color:#000;font-weight:bold">&amp;.</span>node_name<span style="color:#000;font-weight:bold">&amp;.</span>downcase <span style="color:#000;font-weight:bold">==</span> <span style="color:#d14">&#34;p&#34;</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span>
           element<span style="color:#000;font-weight:bold">.</span>parent<span style="color:#000;font-weight:bold">.</span>children<span style="color:#000;font-weight:bold">.</span>count <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">1</span> <span style="color:#000;font-weight:bold">&amp;&amp;</span>
           <span style="color:#008080">HTML5_BLOCK_ELEMENTS</span><span style="color:#000;font-weight:bold">.</span>include?(parsed_onebox<span style="color:#000;font-weight:bold">.</span>children<span style="color:#000;font-weight:bold">[</span><span style="color:#099">0</span><span style="color:#000;font-weight:bold">].</span>node_name<span style="color:#000;font-weight:bold">.</span>downcase)
          element <span style="color:#000;font-weight:bold">=</span> element<span style="color:#000;font-weight:bold">.</span>parent
        <span style="color:#000;font-weight:bold">end</span>

        changed <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span>
        element<span style="color:#000;font-weight:bold">.</span>swap parsed_onebox<span style="color:#000;font-weight:bold">.</span>to_html
      <span style="color:#000;font-weight:bold">end</span>
    <span style="color:#000;font-weight:bold">end</span>

    <span style="color:#998;font-style:italic"># strip empty &lt;p&gt; elements</span>
    doc<span style="color:#000;font-weight:bold">.</span>css(<span style="color:#d14">&#34;p&#34;</span>)<span style="color:#000;font-weight:bold">.</span>each <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span><span style="color:#0086b3">p</span><span style="color:#000;font-weight:bold">|</span>
      <span style="color:#000;font-weight:bold">if</span> <span style="color:#0086b3">p</span><span style="color:#000;font-weight:bold">.</span>children<span style="color:#000;font-weight:bold">.</span>empty? <span style="color:#000;font-weight:bold">&amp;&amp;</span> doc<span style="color:#000;font-weight:bold">.</span>children<span style="color:#000;font-weight:bold">.</span>count <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#099">1</span>
        <span style="color:#0086b3">p</span><span style="color:#000;font-weight:bold">.</span>remove
      <span style="color:#000;font-weight:bold">end</span>
    <span style="color:#000;font-weight:bold">end</span>

    <span style="color:#008080">Result</span><span style="color:#000;font-weight:bold">.</span>new(doc, changed)
  <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>è¿™æ®µå…¶å®æ²¡å•¥ç”¨ï¼Œç®€å•è§£é‡Šä¸‹å°±æ˜¯å–åˆ° cooked è¿™ä¸ª html é‡Œéœ€è¦ onebox åŒ–çš„ URL nodeã€‚ç„¶å invalidate ä¹‹åå– cached_oneboxã€‚cached_onebox ä¸å®é™…è¿›è¡Œ onebox åŒ–é‡Œé¢æœ‰å¤ªå¤šçš„åˆ¤æ–­ä»£ç ï¼ˆonebox_raw)ï¼Œæˆ‘ä»¬åªéœ€è¦å…³æ³¨ Oneboxer çš„è¿™ä¸ªå‡½æ•°å°±å¤Ÿäº†ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">  <span style="color:#000;font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#900;font-weight:bold">external_onebox</span>(url)
    <span style="color:#008080">Discourse</span><span style="color:#000;font-weight:bold">.</span>cache<span style="color:#000;font-weight:bold">.</span>fetch(onebox_cache_key(url), <span style="color:#990073">expires_in</span>: <span style="color:#099">1</span><span style="color:#000;font-weight:bold">.</span>day) <span style="color:#000;font-weight:bold">do</span>
      fd <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">FinalDestination</span><span style="color:#000;font-weight:bold">.</span>new(url,
                                <span style="color:#990073">ignore_redirects</span>: ignore_redirects,
                                <span style="color:#990073">ignore_hostnames</span>: blocked_domains,
                                <span style="color:#990073">force_get_hosts</span>: force_get_hosts,
                                <span style="color:#990073">force_custom_user_agent_hosts</span>: force_custom_user_agent_hosts,
                                <span style="color:#990073">preserve_fragment_url_hosts</span>: preserve_fragment_url_hosts)
      uri <span style="color:#000;font-weight:bold">=</span> fd<span style="color:#000;font-weight:bold">.</span>resolve

      <span style="color:#000;font-weight:bold">if</span> fd<span style="color:#000;font-weight:bold">.</span>status <span style="color:#000;font-weight:bold">!=</span> <span style="color:#990073">:resolved</span>
        args <span style="color:#000;font-weight:bold">=</span> { <span style="color:#990073">link</span>: url }
        <span style="color:#000;font-weight:bold">if</span> fd<span style="color:#000;font-weight:bold">.</span>status <span style="color:#000;font-weight:bold">==</span> <span style="color:#990073">:invalid_address</span>
          args<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:error_message</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">I18n</span><span style="color:#000;font-weight:bold">.</span>t(<span style="color:#d14">&#34;errors.onebox.invalid_address&#34;</span>, <span style="color:#990073">hostname</span>: fd<span style="color:#000;font-weight:bold">.</span>hostname)
        <span style="color:#000;font-weight:bold">elsif</span> fd<span style="color:#000;font-weight:bold">.</span>status_code
          args<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:error_message</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">I18n</span><span style="color:#000;font-weight:bold">.</span>t(<span style="color:#d14">&#34;errors.onebox.error_response&#34;</span>, <span style="color:#990073">status_code</span>: fd<span style="color:#000;font-weight:bold">.</span>status_code)
        <span style="color:#000;font-weight:bold">end</span>

        error_box <span style="color:#000;font-weight:bold">=</span> blank_onebox
        error_box<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:preview</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> preview_error_onebox(args)
        <span style="color:#000;font-weight:bold">return</span> error_box
      <span style="color:#000;font-weight:bold">end</span>

      <span style="color:#000;font-weight:bold">return</span> blank_onebox <span style="color:#000;font-weight:bold">if</span> uri<span style="color:#000;font-weight:bold">.</span>blank? <span style="color:#000;font-weight:bold">||</span> blocked_domains<span style="color:#000;font-weight:bold">.</span>map { <span style="color:#000;font-weight:bold">|</span>hostname<span style="color:#000;font-weight:bold">|</span> uri<span style="color:#000;font-weight:bold">.</span>hostname<span style="color:#000;font-weight:bold">.</span>match?(hostname) }<span style="color:#000;font-weight:bold">.</span>any?

      options <span style="color:#000;font-weight:bold">=</span> {
        <span style="color:#990073">max_width</span>: <span style="color:#099">695</span>,
        <span style="color:#990073">sanitize_config</span>: <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">DiscourseOneboxSanitizeConfig</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Config</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">DISCOURSE_ONEBOX</span>,
        <span style="color:#990073">allowed_iframe_origins</span>: allowed_iframe_origins,
        <span style="color:#990073">hostname</span>: <span style="color:#008080">GlobalSetting</span><span style="color:#000;font-weight:bold">.</span>hostname,
        <span style="color:#990073">facebook_app_access_token</span>: <span style="color:#008080">SiteSetting</span><span style="color:#000;font-weight:bold">.</span>facebook_app_access_token,
      }

      options<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:cookie</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> fd<span style="color:#000;font-weight:bold">.</span>cookie <span style="color:#000;font-weight:bold">if</span> fd<span style="color:#000;font-weight:bold">.</span>cookie

      r <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>preview(uri<span style="color:#000;font-weight:bold">.</span>to_s, options)
      result <span style="color:#000;font-weight:bold">=</span> { <span style="color:#990073">onebox</span>: r<span style="color:#000;font-weight:bold">.</span>to_s, <span style="color:#990073">preview</span>: r<span style="color:#000;font-weight:bold">&amp;.</span>placeholder_html<span style="color:#000;font-weight:bold">.</span>to_s }

      <span style="color:#998;font-style:italic"># NOTE: Call r.errors after calling placeholder_html</span>
      <span style="color:#000;font-weight:bold">if</span> r<span style="color:#000;font-weight:bold">.</span>errors<span style="color:#000;font-weight:bold">.</span>any?
        missing_attributes <span style="color:#000;font-weight:bold">=</span> r<span style="color:#000;font-weight:bold">.</span>errors<span style="color:#000;font-weight:bold">.</span>keys<span style="color:#000;font-weight:bold">.</span>map(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#990073">:to_s</span>)<span style="color:#000;font-weight:bold">.</span>sort<span style="color:#000;font-weight:bold">.</span>join(<span style="color:#008080">I18n</span><span style="color:#000;font-weight:bold">.</span>t(<span style="color:#d14">&#34;word_connector.comma&#34;</span>))
        error_message <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">I18n</span><span style="color:#000;font-weight:bold">.</span>t(<span style="color:#d14">&#34;errors.onebox.missing_data&#34;</span>, <span style="color:#990073">missing_attributes</span>: missing_attributes, <span style="color:#990073">count</span>: r<span style="color:#000;font-weight:bold">.</span>errors<span style="color:#000;font-weight:bold">.</span>keys<span style="color:#000;font-weight:bold">.</span>size)
        args <span style="color:#000;font-weight:bold">=</span> r<span style="color:#000;font-weight:bold">.</span>data<span style="color:#000;font-weight:bold">.</span>merge(<span style="color:#990073">error_message</span>: error_message)

        <span style="color:#000;font-weight:bold">if</span> result<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:preview</span><span style="color:#000;font-weight:bold">].</span>blank?
          result<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:preview</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> preview_error_onebox(args)
        <span style="color:#000;font-weight:bold">else</span>
          doc <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Nokogiri</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">HTML5</span><span style="color:#000;font-weight:bold">::</span>fragment(result<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:preview</span><span style="color:#000;font-weight:bold">]</span>)
          aside <span style="color:#000;font-weight:bold">=</span> doc<span style="color:#000;font-weight:bold">.</span>at(<span style="color:#d14">&#39;aside&#39;</span>)

          <span style="color:#000;font-weight:bold">if</span> aside
            <span style="color:#998;font-style:italic"># Add an error message to the preview that was returned</span>
            error_fragment <span style="color:#000;font-weight:bold">=</span> preview_error_onebox_fragment(args)
            aside<span style="color:#000;font-weight:bold">.</span>add_child(error_fragment)
            result<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:preview</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> doc<span style="color:#000;font-weight:bold">.</span>to_html
          <span style="color:#000;font-weight:bold">end</span>
        <span style="color:#000;font-weight:bold">end</span>
      <span style="color:#000;font-weight:bold">end</span>

      result
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    r <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>preview(uri<span style="color:#000;font-weight:bold">.</span>to_s, options)
    result <span style="color:#000;font-weight:bold">=</span> { <span style="color:#990073">onebox</span>: r<span style="color:#000;font-weight:bold">.</span>to_s, <span style="color:#990073">preview</span>: r<span style="color:#000;font-weight:bold">&amp;.</span>placeholder_html<span style="color:#000;font-weight:bold">.</span>to_s }
</code></pre></div><p>è¿™æ®µæ˜¯æœ€ä¸»è¦çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ Onebox è¿™ä¸ª gem æ˜¯é€šè¿‡å®ƒçš„ preview å‡½æ•°æ¥ä¸ discourse è¿›è¡Œäº¤äº’çš„ã€‚discourse ä»£ç çœ‹åˆ°è¿™é‡Œå°±å¤Ÿäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ onebox ä»£ç ã€‚</p>
<p>ä¸€ä¸ª rubygem æœ€é‡è¦çš„æ˜¯å®ƒçš„ lib æ–‡ä»¶å¤¹ã€‚æˆ‘ä»¬å…ˆä» <a href="https://github.com/discourse/onebox/blob/master/lib/onebox.rb">lib/onebox.rb</a> çœ‹èµ·ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">  <span style="color:#000;font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#900;font-weight:bold">preview</span>(url, options <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>options)
    <span style="color:#998;font-style:italic"># onebox does not have native caching</span>
    <span style="color:#000;font-weight:bold">unless</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Helpers</span><span style="color:#000;font-weight:bold">.</span>blank?(options<span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:cache</span><span style="color:#000;font-weight:bold">]</span>)
      <span style="color:#0086b3">warn</span> <span style="color:#d14">&#34;Onebox no longer has inbuilt caching so `cache` option will be ignored.&#34;</span>
    <span style="color:#000;font-weight:bold">end</span>

    <span style="color:#008080">Preview</span><span style="color:#000;font-weight:bold">.</span>new(url, options)
  <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>è¿™å°±æ˜¯ä¸Šé¢çš„ <code>Onebox.preview</code> çš„æ¥æºã€‚æœ€é‡è¦çš„æ˜¯ Preview è¿™ä¸ª classã€‚ä¸‹é¢æˆ‘ä»¬æ¥ç€çœ‹ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/preview.rb">lib/onebox/preview.rb</a>ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Onebox</span>
  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Preview</span>

    <span style="color:#998;font-style:italic"># see https://bugs.ruby-lang.org/issues/14688</span>
    client_exception <span style="color:#000;font-weight:bold">=</span> defined?(<span style="color:#008080">Net</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">HTTPClientException</span>) ? <span style="color:#008080">Net</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">HTTPClientException</span> : <span style="color:#008080">Net</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">HTTPServerException</span>
    <span style="color:#008080">WEB_EXCEPTIONS</span> <span style="color:#000;font-weight:bold">||=</span> <span style="color:#000;font-weight:bold">[</span>client_exception, <span style="color:#008080">OpenURI</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">HTTPError</span>, <span style="color:#008080">Timeout</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Error</span>, <span style="color:#008080">Net</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">HTTPError</span>, <span style="color:#008080">Errno</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">ECONNREFUSED</span><span style="color:#000;font-weight:bold">]</span>

    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">initialize</span>(link, options <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>options)
      <span style="color:#008080">@url</span> <span style="color:#000;font-weight:bold">=</span> link
      <span style="color:#008080">@options</span> <span style="color:#000;font-weight:bold">=</span> options<span style="color:#000;font-weight:bold">.</span>dup

      allowed_origins <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">@options</span><span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:allowed_iframe_origins</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">Engine</span><span style="color:#000;font-weight:bold">.</span>all_iframe_origins
      <span style="color:#008080">@options</span><span style="color:#000;font-weight:bold">[</span><span style="color:#990073">:allowed_iframe_regexes</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Engine</span><span style="color:#000;font-weight:bold">.</span>origins_to_regexes(allowed_origins)

      <span style="color:#008080">@engine_class</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Matcher</span><span style="color:#000;font-weight:bold">.</span>new(<span style="color:#008080">@url</span>, <span style="color:#008080">@options</span>)<span style="color:#000;font-weight:bold">.</span>oneboxed
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™æ®µä»£ç çš„æ„æ€æ˜¯è¯´æ ¹æ® Matcher æ¥åŒ¹é… URL ä»è€Œå– oneboxed çš„ç»“æœã€‚æ¥ç€çœ‹ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/matcher.rb">lib/onebox/matcher.rb</a>ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Onebox</span>
  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">Matcher</span>
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">initialize</span>(link, options <span style="color:#000;font-weight:bold">=</span> {})
      <span style="color:#008080">@url</span> <span style="color:#000;font-weight:bold">=</span> link
      <span style="color:#008080">@options</span> <span style="color:#000;font-weight:bold">=</span> options
    <span style="color:#000;font-weight:bold">end</span>

    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">ordered_engines</span>
      <span style="color:#008080">@ordered_engines</span> <span style="color:#000;font-weight:bold">||=</span> <span style="color:#008080">Engine</span><span style="color:#000;font-weight:bold">.</span>engines<span style="color:#000;font-weight:bold">.</span>sort_by <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span>e<span style="color:#000;font-weight:bold">|</span>
        e<span style="color:#000;font-weight:bold">.</span>respond_to?(<span style="color:#990073">:priority</span>) ? e<span style="color:#000;font-weight:bold">.</span>priority : <span style="color:#099">100</span>
      <span style="color:#000;font-weight:bold">end</span>
    <span style="color:#000;font-weight:bold">end</span>

    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">oneboxed</span>
      uri <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">URI</span>(<span style="color:#008080">@url</span>)
      <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">unless</span> uri<span style="color:#000;font-weight:bold">.</span>port<span style="color:#000;font-weight:bold">.</span>nil? <span style="color:#000;font-weight:bold">||</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>options<span style="color:#000;font-weight:bold">.</span>allowed_ports<span style="color:#000;font-weight:bold">.</span>include?(uri<span style="color:#000;font-weight:bold">.</span>port)
      <span style="color:#000;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">unless</span> uri<span style="color:#000;font-weight:bold">.</span>scheme<span style="color:#000;font-weight:bold">.</span>nil? <span style="color:#000;font-weight:bold">||</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>options<span style="color:#000;font-weight:bold">.</span>allowed_schemes<span style="color:#000;font-weight:bold">.</span>include?(uri<span style="color:#000;font-weight:bold">.</span>scheme)
      ordered_engines<span style="color:#000;font-weight:bold">.</span>find { <span style="color:#000;font-weight:bold">|</span>engine<span style="color:#000;font-weight:bold">|</span> engine <span style="color:#000;font-weight:bold">===</span> uri <span style="color:#000;font-weight:bold">&amp;&amp;</span> has_allowed_iframe_origins?(engine) }
    <span style="color:#000;font-weight:bold">rescue</span> <span style="color:#008080">URI</span><span style="color:#000;font-weight:bold">::</span><span style="color:#008080">InvalidURIError</span>
      <span style="color:#000;font-weight:bold">nil</span>
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>è¿™æ®µä»£ç çš„æ„æ€æ˜¯ä» <code>ordered_engines</code> é‡Œæ‰¾åˆ°åŒ¹é… uri çš„ engineã€‚è¿”å›è¿™ä¸ª engineã€‚è€Œ <code>ordered_engines</code> æ¥è‡ª <code>Engine.engines</code>ã€‚æˆ‘ä»¬æ¥çœ‹æœ€é‡è¦çš„ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/engine.rb">lib/onebox/engine.rb</a>ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Onebox</span>
  <span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Engine</span>
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#900;font-weight:bold">included</span>(object)
      object<span style="color:#000;font-weight:bold">.</span>extend(<span style="color:#008080">ClassMethods</span>)
    <span style="color:#000;font-weight:bold">end</span>

    <span style="color:#000;font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#900;font-weight:bold">engines</span>
      <span style="color:#0086b3">constants</span><span style="color:#000;font-weight:bold">.</span>select <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span>constant<span style="color:#000;font-weight:bold">|</span>
        constant<span style="color:#000;font-weight:bold">.</span>to_s <span style="color:#000;font-weight:bold">=~</span> <span style="color:#009926">/Onebox$/</span>
      <span style="color:#000;font-weight:bold">end</span><span style="color:#000;font-weight:bold">.</span>map(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0086b3">method</span>(<span style="color:#990073">:const_get</span>))
    <span style="color:#000;font-weight:bold">end</span>
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>

require_relative <span style="color:#d14">&#34;helpers&#34;</span>
require_relative <span style="color:#d14">&#34;layout_support&#34;</span>
require_relative <span style="color:#d14">&#34;file_type_finder&#34;</span>
require_relative <span style="color:#d14">&#34;engine/standard_embed&#34;</span>
require_relative <span style="color:#d14">&#34;engine/html&#34;</span>
require_relative <span style="color:#d14">&#34;engine/json&#34;</span>
require_relative <span style="color:#d14">&#34;engine/amazon_onebox&#34;</span>
require_relative <span style="color:#d14">&#34;engine/github_issue_onebox&#34;</span>
require_relative <span style="color:#d14">&#34;engine/github_blob_onebox&#34;</span>
<span style="color:#000;font-weight:bold">[...]</span>
</code></pre></div><p>è¿™é‡Œçš„ included å‡½æ•°å…¶å®æ˜¯ä¸€ä¸ªè¢«é‡å†™çš„å†…ç½®å‡½æ•°ã€‚å®ƒæ˜¯ ruby çš„ module å‡½æ•°ï¼Œæ„æ€æ˜¯è¿™ä¸ª module è¢« included åˆ°åˆ«çš„ Object é‡Œçš„æ—¶å€™ä¼šåšä»€ä¹ˆã€‚ä¹Ÿå°±æ˜¯è¯´ <code>module Engine</code> è¿™ä¸ªæ¨¡å—è¢«åˆ«çš„ Class/Module è¿™æ · include çš„æ—¶å€™ä¼šå‘ç”Ÿä»€ä¹ˆï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">A</span>
    <span style="color:#000;font-weight:bold">include</span> <span style="color:#008080">Engine</span>
<span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>è¿™é‡Œæ‰€æœ‰ include äº† module Engine çš„ Class éƒ½ä¼šè‡ªåŠ¨è·å¾— ClassMethods çš„ç±»æ–¹æ³•ï¼ŒClassMethods æ¨¡å—åœ¨åé¢ä¸€ç‚¹çš„åœ°æ–¹ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    <span style="color:#000;font-weight:bold">module</span> <span style="color:#555">ClassMethods</span>
      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">===</span>(other)
        <span style="color:#000;font-weight:bold">if</span> other<span style="color:#000;font-weight:bold">.</span>kind_of?(<span style="color:#008080">URI</span>)
          <span style="color:#000;font-weight:bold">!!</span>(other<span style="color:#000;font-weight:bold">.</span>to_s <span style="color:#000;font-weight:bold">=~</span> class_variable_get(<span style="color:#990073">:@@matcher</span>))
        <span style="color:#000;font-weight:bold">else</span>
          <span style="color:#000;font-weight:bold">super</span>
        <span style="color:#000;font-weight:bold">end</span>
      <span style="color:#000;font-weight:bold">end</span>

      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">priority</span>
        <span style="color:#099">100</span>
      <span style="color:#000;font-weight:bold">end</span>

      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">matches_regexp</span>(r)
        class_variable_set <span style="color:#990073">:@@matcher</span>, r
      <span style="color:#000;font-weight:bold">end</span>

      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">requires_iframe_origins</span>(<span style="color:#000;font-weight:bold">*</span>origins)
        class_variable_set <span style="color:#990073">:@@iframe_origins</span>, origins
      <span style="color:#000;font-weight:bold">end</span>

      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">iframe_origins</span>
        class_variable_defined?(<span style="color:#990073">:@@iframe_origins</span>) ? class_variable_get(<span style="color:#990073">:@@iframe_origins</span>) : <span style="color:#000;font-weight:bold">[]</span>
      <span style="color:#000;font-weight:bold">end</span>

      <span style="color:#998;font-style:italic"># calculates a name for onebox using the class name of engine</span>
      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">onebox_name</span>
        <span style="color:#0086b3">name</span><span style="color:#000;font-weight:bold">.</span>split(<span style="color:#d14">&#34;::&#34;</span>)<span style="color:#000;font-weight:bold">.</span>last<span style="color:#000;font-weight:bold">.</span>downcase<span style="color:#000;font-weight:bold">.</span>gsub(<span style="color:#009926">/onebox/</span>, <span style="color:#d14">&#34;&#34;</span>)
      <span style="color:#000;font-weight:bold">end</span>

      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">always_https</span>
        <span style="color:#008080">@https</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">true</span>
      <span style="color:#000;font-weight:bold">end</span>

      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">always_https?</span>
        <span style="color:#008080">@https</span>
      <span style="color:#000;font-weight:bold">end</span>
    <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>ä¸¾ä¸ªä¾‹å­ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Onebox</span>
  <span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Engine</span>
    <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">YoukuOnebox</span>
      <span style="color:#000;font-weight:bold">include</span> <span style="color:#008080">Engine</span>
      <span style="color:#000;font-weight:bold">include</span> <span style="color:#008080">HTML</span>

      matches_regexp(<span style="color:#009926">/^(https?:\/\/)?([\da-z\.-]+)(youku.com\/)(.)+\/?$/</span>)
      requires_iframe_origins <span style="color:#d14">&#34;https://player.youku.com&#34;</span>
</code></pre></div><p>è¿™æ˜¯ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/engine/youku_onebox.rb">lib/onebox/engine/youku_onebox.rb</a>ã€‚å› ä¸º <code>include Engine</code>ï¼Œæ‰€ä»¥è‡ªåŠ¨è·å¾— matches_regexp è¿™ä¸ªç±»æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">matches_regexp(<span style="color:#009926">/^(https?:\/\/)?([\da-z\.-]+)(youku.com\/)(.)+\/?$/</span>)
</code></pre></div><p>æ¥å°† YoukuOnebox è¿™ä¸ª Class çš„ç±»å…¨å±€å˜é‡ <code>@@matcher</code> è®¾ç½®ä¸ºä¸Šé¢çš„ regexpã€‚é€šè¿‡è¿™ä¸ªä¾‹å­æˆ‘ä»¬åº”è¯¥å¤§æ¦‚å¯ä»¥æ˜ç™½ä¸ºä»€ä¹ˆèƒ½å¤Ÿåˆšå®šä¹‰ä¸€ä¸ªæ–°ç±»å°±æ‹¥æœ‰é‚£ä¹ˆå¤šçš„ç±»æ–¹æ³•äº†ã€‚åŒæ ·åŠŸæ•ˆçš„è¿˜æœ‰ <code>include HTML</code>ï¼Œ<code>include JSON</code>ç­‰ç­‰ã€‚ä¸‹ä¸€ç¯‡ç”¨çš„çš„æ—¶å€™å†ç»™å¤§å®¶çœ‹ä»£ç ã€‚</p>
<p>ä¸‹é¢æ¥çœ‹ç¬¬äºŒä¸ªæ–¹æ³•ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    <span style="color:#000;font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#900;font-weight:bold">engines</span>
      <span style="color:#0086b3">constants</span><span style="color:#000;font-weight:bold">.</span>select <span style="color:#000;font-weight:bold">do</span> <span style="color:#000;font-weight:bold">|</span>constant<span style="color:#000;font-weight:bold">|</span>
        constant<span style="color:#000;font-weight:bold">.</span>to_s <span style="color:#000;font-weight:bold">=~</span> <span style="color:#009926">/Onebox$/</span>
      <span style="color:#000;font-weight:bold">end</span><span style="color:#000;font-weight:bold">.</span>map(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#0086b3">method</span>(<span style="color:#990073">:const_get</span>))
    <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>å¾ˆå¤šæ–°æ‰‹è¿™æ—¶å€™å°±æ— æ³•ç†è§£äº†ã€‚<a href="https://apidock.com/ruby/Module/constants">constants</a> æ˜¯ä»€ä¹ˆï¼Ÿå®ƒå…¶å® ruby çš„ä¸€ä¸ª Module æ–¹æ³•ã€‚è¿”å›è¿™ä¸ª module çš„æ‰€æœ‰å¸¸é‡ï¼Œå®šä¹‰åœ¨ Module å†…éƒ¨çš„ Class ä¹Ÿæ˜¯å¸¸é‡ï¼Œç»™æ®µæµ‹è¯•ä»£ç ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">A</span>
  <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">B</span>
  <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>

<span style="color:#000;font-weight:bold">module</span> <span style="color:#555">C</span>
 <span style="color:#000;font-weight:bold">include</span> A
 <span style="color:#000;font-weight:bold">def</span> <span style="color:#458;font-weight:bold">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#900;font-weight:bold">test</span>
   <span style="color:#0086b3">p</span> <span style="color:#0086b3">constants</span>
 <span style="color:#000;font-weight:bold">end</span>
<span style="color:#000;font-weight:bold">end</span>

C<span style="color:#000;font-weight:bold">.</span>test
</code></pre></div><p>ä¸Šé¢è¿è¡Œ C.test çš„ç»“æœæ˜¯ <code>[:B]</code>ã€‚ç±»å B æ˜¯ C çš„å¸¸é‡ã€‚é‚£ä¹ˆ <code>self.engines</code> è¿™ä¸ªå‡½æ•°å…¶å®å°±å¥½ç†è§£äº†ã€‚ä» Engine module çš„å…¨éƒ¨ç±»ä¸­æ‰¾åˆ°ä»¥ <code>Onebox</code> ç»“å°¾çš„ï¼Œå¹¶ä¸”è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ã€‚ä¸Šé¢ Youku çš„é‚£ä¸ªä¾‹å­æˆ‘ä»¬å·²ç»çœ‹åˆ°äº†ï¼Œæ‰€æœ‰çš„è‡ªå®šä¹‰ Engine éƒ½æ˜¯è¿™ä¸ªç»“æ„ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby"><span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Onebox</span>
  <span style="color:#000;font-weight:bold">module</span> <span style="color:#555">Engine</span>
    <span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">YoukuOnebox</span>
</code></pre></div><p>ç›®çš„å°±æ˜¯è®© <code>self.engines</code> å‡½æ•°èƒ½å¤ŸçŸ¥é“å®ƒçš„å­˜åœ¨ã€‚</p>
<p>æˆ‘ä»¬æ¥ç€å¾€ä¸‹çœ‹ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">initialize</span>(link, timeout <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">nil</span>)
      <span style="color:#008080">@errors</span> <span style="color:#000;font-weight:bold">=</span> {}
      <span style="color:#008080">@options</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">DEFAULT</span>
      class_name <span style="color:#000;font-weight:bold">=</span> <span style="color:#0086b3">self</span><span style="color:#000;font-weight:bold">.</span>class<span style="color:#000;font-weight:bold">.</span>name<span style="color:#000;font-weight:bold">.</span>split(<span style="color:#d14">&#34;::&#34;</span>)<span style="color:#000;font-weight:bold">.</span>last<span style="color:#000;font-weight:bold">.</span>to_s

      <span style="color:#998;font-style:italic"># Set the engine options extracted from global options.</span>
      <span style="color:#0086b3">self</span><span style="color:#000;font-weight:bold">.</span>options <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>options<span style="color:#000;font-weight:bold">[</span>class_name<span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">||</span> {}

      <span style="color:#008080">@url</span> <span style="color:#000;font-weight:bold">=</span> link
      <span style="color:#008080">@uri</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">URI</span>(link)
      <span style="color:#000;font-weight:bold">if</span> always_https?
        <span style="color:#008080">@uri</span><span style="color:#000;font-weight:bold">.</span>scheme <span style="color:#000;font-weight:bold">=</span> <span style="color:#d14">&#39;https&#39;</span>
        <span style="color:#008080">@url</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">@uri</span><span style="color:#000;font-weight:bold">.</span>to_s
      <span style="color:#000;font-weight:bold">end</span>
      <span style="color:#008080">@timeout</span> <span style="color:#000;font-weight:bold">=</span> timeout <span style="color:#000;font-weight:bold">||</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>options<span style="color:#000;font-weight:bold">.</span>timeout
    <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>æ˜¯ä¸æ˜¯å¾ˆæœ‰æ„æ€ï¼Œä¸€ä¸ª Module å±…ç„¶æœ‰ initialize å‡½æ•°ï¼ä»–çš„ä½œç”¨æ˜¯ï¼Œinclude å®ƒçš„ class çš„ new instance ç”Ÿæˆçš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ª class æœ¬èº«æ²¡æœ‰å†™ initialize å‡½æ•°ï¼Œé‚£ä¹ˆè¿è¡Œ module å¸¦çš„ã€‚è¦æ˜¯å†™äº†ï¼Œåœ¨ class çš„ initialize å‡½æ•°é‡Œå¯ä»¥è¿è¡Œ super æ¥è¿è¡Œ module å¸¦çš„ã€‚æˆ‘ä»¬çœ‹ engine æ–‡ä»¶å¤¹é‡Œæ‰€æœ‰çš„è‡ªå®šä¹‰å¼•æ“éƒ½æ²¡æœ‰å†™è‡ªå·±çš„ initialize å‡½æ•°ï¼Œå°±æ˜¯å› ä¸ºè¿™é‡Œå†™äº†ã€‚</p>
<p>è¿™é‡Œå®šä¹‰äº†ä¸€äº›å®ä¾‹å˜é‡ï¼Œè¿™äº›å˜é‡æ˜¯å†™è‡ªå®šä¹‰å¼•æ“çš„æ—¶å€™å¯ä»¥ç›´æ¥ç”¨çš„ã€‚</p>
<p>æ¥ç€å¾€ä¸‹çœ‹ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    <span style="color:#998;font-style:italic"># raises error if not defined in onebox engine.</span>
    <span style="color:#998;font-style:italic"># This is the output method for an engine.</span>
    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">to_html</span>
      <span style="color:#0086b3">fail</span> <span style="color:#008080">NoMethodError</span>, <span style="color:#d14">&#34;Engines need to implement this method&#34;</span>
    <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>è¿™ç§å‡½æ•°çœ‹èµ·æ¥å¾ˆå¥‡æ€ªå¯¹ä¸å¯¹ï¼Ÿç›´æ¥æŠ›é”™è¯¯ã€‚å› ä¸º Ruby æ˜¯å¯ä»¥é‡å†™æ–¹æ³•çš„ã€‚ä¸Šé¢ YoukuOnebox çš„ä¾‹å­é‡Œï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">to_html</span>
        <span style="color:#000;font-weight:bold">&lt;&lt;~</span><span style="color:#008080">HTML</span>
          <span style="color:#000;font-weight:bold">&lt;</span>iframe src<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;https://player.youku.com/embed/</span><span style="color:#d14">#{</span>video_id<span style="color:#d14">}</span><span style="color:#d14">&#34;</span>
                  width<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;640&#34;</span>
                  height<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;430&#34;</span>
                  frameborder<span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#39;0&#39;</span>
                  allowfullscreen<span style="color:#000;font-weight:bold">&gt;</span>
          <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#009926">/iframe&gt;
</span><span style="color:#009926">        HTML
</span><span style="color:#009926">      end
</span></code></pre></div><p>å°±é‡å†™äº†è¿™ä¸ªæ–¹æ³•ã€‚è¿™æ · Engine module è°ƒç”¨æ–¹æ³•çš„æ—¶å€™å®é™…ä¸Šæ˜¯ä¸ç©ºçš„ã€‚ä¸‹é¢æˆ‘ä»¬æ¥æ‹ä¸€ä¸‹ <code>Onebox.preview(url, options)</code> çš„æµç¨‹ï¼š</p>
<p><code>Onebox.preview</code> è°ƒç”¨<code>Preview.new(url,options)</code>,åè€…è°ƒç”¨ <code>Matcher.new(@url, @options).oneboxed</code>, Matcher æ˜¯è·å–å…¨éƒ¨è‡ªå®šä¹‰å¼•æ“åé€šè¿‡åˆ¤æ–­ <code>engine == uri</code>æ¥æ‰¾å‡ºå¯¹åº”å¼•æ“ã€‚</p>
<p>ä¸Šé¢çš„ç†è§£äº†æˆ‘ä»¬å°±å¯ä»¥æ¥ç€ç†è§£ <code>engine == uri</code> äº†ã€‚æˆ‘ä»¬å‰é¢å·²ç»è¯´äº†ï¼Œæ‰€æœ‰çš„è‡ªå®šä¹‰å¼•æ“éƒ½ <code>include Engine</code>äº†ï¼Œå¾—åˆ°äº†<code>ClassMethods</code>çš„ç±»æ–¹æ³•ï¼Œæœ‰ä¸€ä¸ªç±»æ–¹æ³•å°±æ˜¯è¿™ä¸ªï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">      <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">===</span>(other)
        <span style="color:#000;font-weight:bold">if</span> other<span style="color:#000;font-weight:bold">.</span>kind_of?(<span style="color:#008080">URI</span>)
          <span style="color:#000;font-weight:bold">!!</span>(other<span style="color:#000;font-weight:bold">.</span>to_s <span style="color:#000;font-weight:bold">=~</span> class_variable_get(<span style="color:#990073">:@@matcher</span>))
        <span style="color:#000;font-weight:bold">else</span>
          <span style="color:#000;font-weight:bold">super</span>
        <span style="color:#000;font-weight:bold">end</span>
      <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>å¦‚æœæ˜¯æ‹¿ URI æ¥åˆ¤æ–­çš„è¯ï¼Œå…ˆæŠŠå®ƒè½¬æˆå­—ç¬¦ä¸²ï¼Œç„¶åä¸è‡ªå®šä¹‰å¼•æ“çš„ç±»å˜é‡ <code>@@matcher</code> åšæ­£åˆ™åŒ¹é…ï¼Œå°±èƒ½å¤Ÿç¡®ä¿å¼•æ“çš„å”¯ä¸€æ€§ã€‚</p>
<p>ä¸Šé¢ä¹Ÿè¯´äº†ï¼ŒOnebox.preview æœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯ Engine module é‡Œé¢çš„ä¸€ä¸ªè‡ªå®šä¹‰ Classã€‚é‚£ä¹ˆ discourse æ˜¯æ€ä¹ˆä½¿ç”¨è¿™ä¸ª engine çš„å‘¢ï¼Ÿ</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    r <span style="color:#000;font-weight:bold">=</span> <span style="color:#008080">Onebox</span><span style="color:#000;font-weight:bold">.</span>preview(uri<span style="color:#000;font-weight:bold">.</span>to_s, options)
    result <span style="color:#000;font-weight:bold">=</span> { <span style="color:#990073">onebox</span>: r<span style="color:#000;font-weight:bold">.</span>to_s, <span style="color:#990073">preview</span>: r<span style="color:#000;font-weight:bold">&amp;.</span>placeholder_html<span style="color:#000;font-weight:bold">.</span>to_s }
</code></pre></div><p>æˆ‘ä»¬å†æŠŠ discourse çš„è¿™æ®µä»£ç æ‹¿å›æ¥ç†è§£ã€‚å®ƒå®šä¹‰äº†ä¸€ä¸ª hashã€‚å…¶ä¸­ onebox æ˜¯è¿™ä¸ªè‡ªå®šä¹‰ class çš„ to_sï¼Œå¼•æ“æ€ä¹ˆè½¬å­—ç¬¦ä¸²å‘¢ï¼Ÿåœ¨ <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/preview.rb">lib/onebox/preview.rb</a> é‡Œé¢ï¼š</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">to_s</span>
      <span style="color:#000;font-weight:bold">return</span> <span style="color:#d14">&#34;&#34;</span> <span style="color:#000;font-weight:bold">unless</span> engine
      sanitize process_html engine_html
    <span style="color:#000;font-weight:bold">rescue</span> <span style="color:#000;font-weight:bold">*</span><span style="color:#008080">WEB_EXCEPTIONS</span>
      <span style="color:#d14">&#34;&#34;</span>
    <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>å¯¹æˆ‘ä»¬ç”¨å¤„ä¸å¤§ï¼Œç•¥ã€‚é‚£ä¹ˆ preview æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ˜¯è°ƒç”¨äº†å¼•æ“çš„ placeholder_html æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨ engine.rb é‡Œé¢ã€‚</p>
<div class="highlight"><pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-ruby" data-lang="ruby">    <span style="color:#000;font-weight:bold">def</span> <span style="color:#900;font-weight:bold">placeholder_html</span>
      to_html
    <span style="color:#000;font-weight:bold">end</span>
</code></pre></div><p>å®ƒè°ƒç”¨äº†é»˜è®¤æŠ›é”™è¯¯çš„é‚£ä¸ª to_html æ–¹æ³•ï¼Œè€Œå½“æœ‰äº†ç¡®å®šçš„å¼•æ“åï¼Œto_html æ–¹æ³•æ˜¯è‡ªå®šä¹‰å¼•æ“å®ç°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæƒ³è¦å†™ä¸€ä¸ªè‡ªå®šä¹‰å¼•æ“ï¼Œæœ€æœ€é‡è¦çš„æ–¹æ³•æ˜¯ <code>matches_regexp</code>å’Œ<code>to_html</code>ã€‚</p>
<p>å¯¹äº Onebox gem çš„ç†è§£åˆ°è¿™é‡Œå°±å¯ä»¥äº†ã€‚ä¸‹ä¸€ç¯‡æˆ‘ä»¬å°†è¦çœŸæ­£å¼€å§‹å†™æˆ‘ä»¬çš„æ’ä»¶ã€‚</p>

			</div>
			
			<div>
				<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "innamoramento" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/%E4%BD%BF%E7%94%A8_google_%E7%9A%84_fontmake_%E5%A4%8D%E6%B4%BB%E6%96%87%E6%B3%89%E9%A9%BF%E9%A1%B9%E7%9B%AE/">ä½¿ç”¨ google çš„ fontmake å¤æ´»æ–‡æ³‰é©¿é¡¹ç›®</a></li>
				
				<li><a href="/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%89%E5%8E%BB%E6%8E%89-watir-%E4%BE%9D%E8%B5%96/">ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸‰ï¼‰å»æ‰ watir ä¾èµ–</a></li>
				
				<li><a href="/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%BA%8C%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E6%8F%92%E4%BB%B6/">ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆäºŒï¼‰ä»é›¶å¼€å§‹å†™ custom engine</a></li>
				
				<li><a href="/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/">ä¸º Discourse å¼€å‘ä¸€ä¸ª Onebox æ’ä»¶ï¼ˆä¸€ï¼‰ç†è§£ Onebox gem</a></li>
				
				<li><a href="/posts/color_emoji_in_opensuse/">Color Emoji in openSUSE</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2022 <a href="https://marguerite.github.io">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a></p>
</footer>

</body>
</html>

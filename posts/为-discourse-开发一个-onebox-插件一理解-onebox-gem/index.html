<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem | Marguerite Su: Golang/Ruby Programmer, openSUSE Member</title>
<meta name="keywords" content="">
<meta name="description" content="为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem
我们 openSUSE 中文论坛用的是 discourse，有一天给用户贴了一个 OBS 的链接，突然想到是不是可以让它也能像 github 一样有一个漂亮的预览小窗口 🤓 于是说干就干：discourse-openbuildservice-onebox 插件。
以下是教程，由于涉及到目前最大的 Ruby on Rails 程序 discourse，会分成几部分来讲解。第一部分我们来试着理解一下 discourse 出品的 onebox gem。
Ruby 作为一门脚本语言，所有对象的方法都可以被重写。学名叫做 Meta Programming。这是理解 onebox gem 的基础。
我们下面来看 discourse 是怎么使用 onebox gem 的，下面是 app/models/post_analyzer.rb 的 cook 函数，这个函数负责把你输入的文字转为 html 保存在 postgresql 数据库，是最基础的函数之一：
  def cook(raw, opts = {})
    [...]

    result = Oneboxer.apply(cooked) do |url|
      @onebox_urls &lt;&lt; url
      if opts[:invalidate_oneboxes]
        Oneboxer.invalidate(url)
        InlineOneboxer.invalidate(url)
      end
      onebox = Oneboxer.cached_onebox(url)
      @found_oneboxes = true if onebox.present?
      onebox
    end

    cooked = result.to_html if result.changed?
    cooked
  end
可以看到 discourse 自己还有一个 Oneboxer 的 wrapper，这里使用了 Oneboxer.apply 和 Oneboxer.cache_onebox 函数。接下来我们接着看 lib/oneboxer.rb：">
<meta name="author" content="">
<link rel="canonical" href="https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://marguerite.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://marguerite.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://marguerite.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://marguerite.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://marguerite.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.1/styles/github.min.css" integrity="sha512-7QTQ5Qsc/IL1k8UU2bkNFjpKTfwnvGuPYE6fzm6yeneWTEGiA3zspgjcTsSgln9m0cn3MgyE7EnDNkF1bB/uCw==" crossorigin="anonymous" /><meta property="og:url" content="https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/">
  <meta property="og:site_name" content="Marguerite Su: Golang/Ruby Programmer, openSUSE Member">
  <meta property="og:title" content="为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem">
  <meta property="og:description" content="为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem 我们 openSUSE 中文论坛用的是 discourse，有一天给用户贴了一个 OBS 的链接，突然想到是不是可以让它也能像 github 一样有一个漂亮的预览小窗口 🤓 于是说干就干：discourse-openbuildservice-onebox 插件。
以下是教程，由于涉及到目前最大的 Ruby on Rails 程序 discourse，会分成几部分来讲解。第一部分我们来试着理解一下 discourse 出品的 onebox gem。
Ruby 作为一门脚本语言，所有对象的方法都可以被重写。学名叫做 Meta Programming。这是理解 onebox gem 的基础。
我们下面来看 discourse 是怎么使用 onebox gem 的，下面是 app/models/post_analyzer.rb 的 cook 函数，这个函数负责把你输入的文字转为 html 保存在 postgresql 数据库，是最基础的函数之一：
def cook(raw, opts = {}) [...] result = Oneboxer.apply(cooked) do |url| @onebox_urls &lt;&lt; url if opts[:invalidate_oneboxes] Oneboxer.invalidate(url) InlineOneboxer.invalidate(url) end onebox = Oneboxer.cached_onebox(url) @found_oneboxes = true if onebox.present? onebox end cooked = result.to_html if result.changed? cooked end 可以看到 discourse 自己还有一个 Oneboxer 的 wrapper，这里使用了 Oneboxer.apply 和 Oneboxer.cache_onebox 函数。接下来我们接着看 lib/oneboxer.rb：">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2020-11-28T14:59:00+08:00">
    <meta property="article:modified_time" content="2020-11-28T14:59:00+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem">
<meta name="twitter:description" content="为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem
我们 openSUSE 中文论坛用的是 discourse，有一天给用户贴了一个 OBS 的链接，突然想到是不是可以让它也能像 github 一样有一个漂亮的预览小窗口 🤓 于是说干就干：discourse-openbuildservice-onebox 插件。
以下是教程，由于涉及到目前最大的 Ruby on Rails 程序 discourse，会分成几部分来讲解。第一部分我们来试着理解一下 discourse 出品的 onebox gem。
Ruby 作为一门脚本语言，所有对象的方法都可以被重写。学名叫做 Meta Programming。这是理解 onebox gem 的基础。
我们下面来看 discourse 是怎么使用 onebox gem 的，下面是 app/models/post_analyzer.rb 的 cook 函数，这个函数负责把你输入的文字转为 html 保存在 postgresql 数据库，是最基础的函数之一：
  def cook(raw, opts = {})
    [...]

    result = Oneboxer.apply(cooked) do |url|
      @onebox_urls &lt;&lt; url
      if opts[:invalidate_oneboxes]
        Oneboxer.invalidate(url)
        InlineOneboxer.invalidate(url)
      end
      onebox = Oneboxer.cached_onebox(url)
      @found_oneboxes = true if onebox.present?
      onebox
    end

    cooked = result.to_html if result.changed?
    cooked
  end
可以看到 discourse 自己还有一个 Oneboxer 的 wrapper，这里使用了 Oneboxer.apply 和 Oneboxer.cache_onebox 函数。接下来我们接着看 lib/oneboxer.rb：">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://marguerite.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem",
      "item": "https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem",
  "name": "为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem",
  "description": "为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem 我们 openSUSE 中文论坛用的是 discourse，有一天给用户贴了一个 OBS 的链接，突然想到是不是可以让它也能像 github 一样有一个漂亮的预览小窗口 🤓 于是说干就干：discourse-openbuildservice-onebox 插件。\n以下是教程，由于涉及到目前最大的 Ruby on Rails 程序 discourse，会分成几部分来讲解。第一部分我们来试着理解一下 discourse 出品的 onebox gem。\nRuby 作为一门脚本语言，所有对象的方法都可以被重写。学名叫做 Meta Programming。这是理解 onebox gem 的基础。\n我们下面来看 discourse 是怎么使用 onebox gem 的，下面是 app/models/post_analyzer.rb 的 cook 函数，这个函数负责把你输入的文字转为 html 保存在 postgresql 数据库，是最基础的函数之一：\ndef cook(raw, opts = {}) [...] result = Oneboxer.apply(cooked) do |url| @onebox_urls \u0026lt;\u0026lt; url if opts[:invalidate_oneboxes] Oneboxer.invalidate(url) InlineOneboxer.invalidate(url) end onebox = Oneboxer.cached_onebox(url) @found_oneboxes = true if onebox.present? onebox end cooked = result.to_html if result.changed? cooked end 可以看到 discourse 自己还有一个 Oneboxer 的 wrapper，这里使用了 Oneboxer.apply 和 Oneboxer.cache_onebox 函数。接下来我们接着看 lib/oneboxer.rb：\n",
  "keywords": [
    
  ],
  "articleBody": "为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem 我们 openSUSE 中文论坛用的是 discourse，有一天给用户贴了一个 OBS 的链接，突然想到是不是可以让它也能像 github 一样有一个漂亮的预览小窗口 🤓 于是说干就干：discourse-openbuildservice-onebox 插件。\n以下是教程，由于涉及到目前最大的 Ruby on Rails 程序 discourse，会分成几部分来讲解。第一部分我们来试着理解一下 discourse 出品的 onebox gem。\nRuby 作为一门脚本语言，所有对象的方法都可以被重写。学名叫做 Meta Programming。这是理解 onebox gem 的基础。\n我们下面来看 discourse 是怎么使用 onebox gem 的，下面是 app/models/post_analyzer.rb 的 cook 函数，这个函数负责把你输入的文字转为 html 保存在 postgresql 数据库，是最基础的函数之一：\ndef cook(raw, opts = {}) [...] result = Oneboxer.apply(cooked) do |url| @onebox_urls \u003c\u003c url if opts[:invalidate_oneboxes] Oneboxer.invalidate(url) InlineOneboxer.invalidate(url) end onebox = Oneboxer.cached_onebox(url) @found_oneboxes = true if onebox.present? onebox end cooked = result.to_html if result.changed? cooked end 可以看到 discourse 自己还有一个 Oneboxer 的 wrapper，这里使用了 Oneboxer.apply 和 Oneboxer.cache_onebox 函数。接下来我们接着看 lib/oneboxer.rb：\ndef self.apply(string_or_doc, extra_paths: nil) doc = string_or_doc doc = Nokogiri::HTML5::fragment(doc) if doc.is_a?(String) changed = false each_onebox_link(doc, extra_paths: extra_paths) do |url, element| onebox, _ = yield(url, element) if onebox parsed_onebox = Nokogiri::HTML5::fragment(onebox) next unless parsed_onebox.children.count \u003e 0 if element\u0026.parent\u0026.node_name\u0026.downcase == \"p\" \u0026\u0026 element.parent.children.count == 1 \u0026\u0026 HTML5_BLOCK_ELEMENTS.include?(parsed_onebox.children[0].node_name.downcase) element = element.parent end changed = true element.swap parsed_onebox.to_html end end # strip empty elements doc.css(\"p\").each do |p| if p.children.empty? \u0026\u0026 doc.children.count \u003e 1 p.remove end end Result.new(doc, changed) end 这段其实没啥用，简单解释下就是取到 cooked 这个 html 里需要 onebox 化的 URL node。然后 invalidate 之后取 cached_onebox。cached_onebox 与实际进行 onebox 化里面有太多的判断代码（onebox_raw)，我们只需要关注 Oneboxer 的这个函数就够了：\ndef self.external_onebox(url) Discourse.cache.fetch(onebox_cache_key(url), expires_in: 1.day) do fd = FinalDestination.new(url, ignore_redirects: ignore_redirects, ignore_hostnames: blocked_domains, force_get_hosts: force_get_hosts, force_custom_user_agent_hosts: force_custom_user_agent_hosts, preserve_fragment_url_hosts: preserve_fragment_url_hosts) uri = fd.resolve if fd.status != :resolved args = { link: url } if fd.status == :invalid_address args[:error_message] = I18n.t(\"errors.onebox.invalid_address\", hostname: fd.hostname) elsif fd.status_code args[:error_message] = I18n.t(\"errors.onebox.error_response\", status_code: fd.status_code) end error_box = blank_onebox error_box[:preview] = preview_error_onebox(args) return error_box end return blank_onebox if uri.blank? || blocked_domains.map { |hostname| uri.hostname.match?(hostname) }.any? options = { max_width: 695, sanitize_config: Onebox::DiscourseOneboxSanitizeConfig::Config::DISCOURSE_ONEBOX, allowed_iframe_origins: allowed_iframe_origins, hostname: GlobalSetting.hostname, facebook_app_access_token: SiteSetting.facebook_app_access_token, } options[:cookie] = fd.cookie if fd.cookie r = Onebox.preview(uri.to_s, options) result = { onebox: r.to_s, preview: r\u0026.placeholder_html.to_s } # NOTE: Call r.errors after calling placeholder_html if r.errors.any? missing_attributes = r.errors.keys.map(\u0026:to_s).sort.join(I18n.t(\"word_connector.comma\")) error_message = I18n.t(\"errors.onebox.missing_data\", missing_attributes: missing_attributes, count: r.errors.keys.size) args = r.data.merge(error_message: error_message) if result[:preview].blank? result[:preview] = preview_error_onebox(args) else doc = Nokogiri::HTML5::fragment(result[:preview]) aside = doc.at('aside') if aside # Add an error message to the preview that was returned error_fragment = preview_error_onebox_fragment(args) aside.add_child(error_fragment) result[:preview] = doc.to_html end end end result end end 这里可以看到：\nr = Onebox.preview(uri.to_s, options) result = { onebox: r.to_s, preview: r\u0026.placeholder_html.to_s } 这段是最主要的，也就是说 Onebox 这个 gem 是通过它的 preview 函数来与 discourse 进行交互的。discourse 代码看到这里就够了，下面我们来看 onebox 代码。\n一个 rubygem 最重要的是它的 lib 文件夹。我们先从 lib/onebox.rb 看起：\ndef self.preview(url, options = Onebox.options) # onebox does not have native caching unless Onebox::Helpers.blank?(options[:cache]) warn \"Onebox no longer has inbuilt caching so `cache` option will be ignored.\" end Preview.new(url, options) end 这就是上面的 Onebox.preview 的来源。最重要的是 Preview 这个 class。下面我们接着看 lib/onebox/preview.rb：\nmodule Onebox class Preview # see https://bugs.ruby-lang.org/issues/14688 client_exception = defined?(Net::HTTPClientException) ? Net::HTTPClientException : Net::HTTPServerException WEB_EXCEPTIONS ||= [client_exception, OpenURI::HTTPError, Timeout::Error, Net::HTTPError, Errno::ECONNREFUSED] def initialize(link, options = Onebox.options) @url = link @options = options.dup allowed_origins = @options[:allowed_iframe_origins] || Onebox::Engine.all_iframe_origins @options[:allowed_iframe_regexes] = Engine.origins_to_regexes(allowed_origins) @engine_class = Matcher.new(@url, @options).oneboxed end end end 可以看到，这段代码的意思是说根据 Matcher 来匹配 URL 从而取 oneboxed 的结果。接着看 lib/onebox/matcher.rb：\nmodule Onebox class Matcher def initialize(link, options = {}) @url = link @options = options end def ordered_engines @ordered_engines ||= Engine.engines.sort_by do |e| e.respond_to?(:priority) ? e.priority : 100 end end def oneboxed uri = URI(@url) return unless uri.port.nil? || Onebox.options.allowed_ports.include?(uri.port) return unless uri.scheme.nil? || Onebox.options.allowed_schemes.include?(uri.scheme) ordered_engines.find { |engine| engine === uri \u0026\u0026 has_allowed_iframe_origins?(engine) } rescue URI::InvalidURIError nil end end end 这段代码的意思是从 ordered_engines 里找到匹配 uri 的 engine。返回这个 engine。而 ordered_engines 来自 Engine.engines。我们来看最重要的 lib/onebox/engine.rb：\nmodule Onebox module Engine def self.included(object) object.extend(ClassMethods) end def self.engines constants.select do |constant| constant.to_s =~ /Onebox$/ end.map(\u0026method(:const_get)) end end end require_relative \"helpers\" require_relative \"layout_support\" require_relative \"file_type_finder\" require_relative \"engine/standard_embed\" require_relative \"engine/html\" require_relative \"engine/json\" require_relative \"engine/amazon_onebox\" require_relative \"engine/github_issue_onebox\" require_relative \"engine/github_blob_onebox\" [...] 这里的 included 函数其实是一个被重写的内置函数。它是 ruby 的 module 函数，意思是这个 module 被 included 到别的 Object 里的时候会做什么。也就是说 module Engine 这个模块被别的 Class/Module 这样 include 的时候会发生什么：\nmodule A include Engine end 这里所有 include 了 module Engine 的 Class 都会自动获得 ClassMethods 的类方法，ClassMethods 模块在后面一点的地方：\nmodule ClassMethods def ===(other) if other.kind_of?(URI) !!(other.to_s =~ class_variable_get(:@@matcher)) else super end end def priority 100 end def matches_regexp(r) class_variable_set :@@matcher, r end def requires_iframe_origins(*origins) class_variable_set :@@iframe_origins, origins end def iframe_origins class_variable_defined?(:@@iframe_origins) ? class_variable_get(:@@iframe_origins) : [] end # calculates a name for onebox using the class name of engine def onebox_name name.split(\"::\").last.downcase.gsub(/onebox/, \"\") end def always_https @https = true end def always_https? @https end end 举个例子：\nmodule Onebox module Engine class YoukuOnebox include Engine include HTML matches_regexp(/^(https?:\\/\\/)?([\\da-z\\.-]+)(youku.com\\/)(.)+\\/?$/) requires_iframe_origins \"https://player.youku.com\" 这是 lib/onebox/engine/youku_onebox.rb。因为 include Engine，所以自动获得 matches_regexp 这个类方法，所以可以调用：\nmatches_regexp(/^(https?:\\/\\/)?([\\da-z\\.-]+)(youku.com\\/)(.)+\\/?$/) 来将 YoukuOnebox 这个 Class 的类全局变量 @@matcher 设置为上面的 regexp。通过这个例子我们应该大概可以明白为什么能够刚定义一个新类就拥有那么多的类方法了。同样功效的还有 include HTML，include JSON等等。下一篇用的的时候再给大家看代码。\n下面来看第二个方法：\ndef self.engines constants.select do |constant| constant.to_s =~ /Onebox$/ end.map(\u0026method(:const_get)) end 很多新手这时候就无法理解了。constants 是什么？它其实 ruby 的一个 Module 方法。返回这个 module 的所有常量，定义在 Module 内部的 Class 也是常量，给段测试代码：\nmodule A class B end end module C include A def self.test p constants end end C.test 上面运行 C.test 的结果是 [:B]。类名 B 是 C 的常量。那么 self.engines 这个函数其实就好理解了。从 Engine module 的全部类中找到以 Onebox 结尾的，并且返回一个字符串数组。上面 Youku 的那个例子我们已经看到了，所有的自定义 Engine 都是这个结构：\nmodule Onebox module Engine class YoukuOnebox 目的就是让 self.engines 函数能够知道它的存在。\n我们接着往下看：\ndef initialize(link, timeout = nil) @errors = {} @options = DEFAULT class_name = self.class.name.split(\"::\").last.to_s # Set the engine options extracted from global options. self.options = Onebox.options[class_name] || {} @url = link @uri = URI(link) if always_https? @uri.scheme = 'https' @url = @uri.to_s end @timeout = timeout || Onebox.options.timeout end 是不是很有意思，一个 Module 居然有 initialize 函数！他的作用是，include 它的 class 的 new instance 生成的时候，如果这个 class 本身没有写 initialize 函数，那么运行 module 带的。要是写了，在 class 的 initialize 函数里可以运行 super 来运行 module 带的。我们看 engine 文件夹里所有的自定义引擎都没有写自己的 initialize 函数，就是因为这里写了。\n这里定义了一些实例变量，这些变量是写自定义引擎的时候可以直接用的。\n接着往下看：\n# raises error if not defined in onebox engine. # This is the output method for an engine. def to_html fail NoMethodError, \"Engines need to implement this method\" end 这种函数看起来很奇怪对不对？直接抛错误。因为 Ruby 是可以重写方法的。上面 YoukuOnebox 的例子里：\ndef to_html \u003c\u003c~HTML \u003ciframe src=\"https://player.youku.com/embed/#{video_id}\" width=\"640\" height=\"430\" frameborder='0' allowfullscreen\u003e \u003c/iframe\u003e HTML end 就重写了这个方法。这样 Engine module 调用方法的时候实际上是不空的。下面我们来捋一下 Onebox.preview(url, options) 的流程：\nOnebox.preview 调用Preview.new(url,options),后者调用 Matcher.new(@url, @options).oneboxed, Matcher 是获取全部自定义引擎后通过判断 engine == uri来找出对应引擎。\n上面的理解了我们就可以接着理解 engine == uri 了。我们前面已经说了，所有的自定义引擎都 include Engine了，得到了ClassMethods的类方法，有一个类方法就是这个：\ndef ===(other) if other.kind_of?(URI) !!(other.to_s =~ class_variable_get(:@@matcher)) else super end end 如果是拿 URI 来判断的话，先把它转成字符串，然后与自定义引擎的类变量 @@matcher 做正则匹配，就能够确保引擎的唯一性。\n上面也说了，Onebox.preview 最终得到的结果是 Engine module 里面的一个自定义 Class。那么 discourse 是怎么使用这个 engine 的呢？\nr = Onebox.preview(uri.to_s, options) result = { onebox: r.to_s, preview: r\u0026.placeholder_html.to_s } 我们再把 discourse 的这段代码拿回来理解。它定义了一个 hash。其中 onebox 是这个自定义 class 的 to_s，引擎怎么转字符串呢？在 lib/onebox/preview.rb 里面：\ndef to_s return \"\" unless engine sanitize process_html engine_html rescue *WEB_EXCEPTIONS \"\" end 对我们用处不大，略。那么 preview 是什么呢？是调用了引擎的 placeholder_html 方法，这个方法在 engine.rb 里面。\ndef placeholder_html to_html end 它调用了默认抛错误的那个 to_html 方法，而当有了确定的引擎后，to_html 方法是自定义引擎实现的。也就是说，想要写一个自定义引擎，最最重要的方法是 matches_regexp和to_html。\n对于 Onebox gem 的理解到这里就可以了。下一篇我们将要真正开始写我们的插件。\n",
  "wordCount" : "1018",
  "inLanguage": "en",
  "datePublished": "2020-11-28T14:59:00+08:00",
  "dateModified": "2020-11-28T14:59:00+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://marguerite.github.io/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Marguerite Su: Golang/Ruby Programmer, openSUSE Member",
    "logo": {
      "@type": "ImageObject",
      "url": "https://marguerite.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://marguerite.github.io/" accesskey="h" title="Marguerite Su: Golang/Ruby Programmer, openSUSE Member (Alt + H)">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem
    </h1>
    <div class="post-meta"><span title='2020-11-28 14:59:00 +0800 CST'>November 28, 2020</span>

</div>
  </header> 
  <div class="post-content"><h2 id="为-discourse-开发一个-onebox-插件一理解-onebox-gem">为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem<a hidden class="anchor" aria-hidden="true" href="#为-discourse-开发一个-onebox-插件一理解-onebox-gem">#</a></h2>
<p>我们 <a href="https://forum.suse.org.cn">openSUSE 中文论坛</a>用的是 <a href="https://github.com/discourse/discourse">discourse</a>，有一天给用户贴了一个 <a href="http://build.opensuse.org/">OBS</a> 的链接，突然想到是不是可以让它也能像 github 一样有一个漂亮的预览小窗口 🤓 于是说干就干：<a href="https://github.com/openSUSE-zh/discourse-openbuildservice-onebox">discourse-openbuildservice-onebox</a> 插件。</p>
<p>以下是教程，由于涉及到目前最大的 Ruby on Rails 程序 discourse，会分成几部分来讲解。第一部分我们来试着理解一下 discourse 出品的 <a href="https://github.com/discourse/onebox">onebox</a> gem。</p>
<p>Ruby 作为一门脚本语言，<strong>所有对象的方法都可以被重写</strong>。学名叫做 Meta Programming。这是理解 onebox gem 的基础。</p>
<p>我们下面来看 discourse 是怎么使用 onebox gem 的，下面是 <a href="https://github.com/discourse/discourse/blob/master/app/models/post_analyzer.rb">app/models/post_analyzer.rb</a> 的 cook 函数，这个函数负责把你输入的文字转为 html 保存在 postgresql 数据库，是最基础的函数之一：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cook</span>(raw, opts <span style="color:#f92672">=</span> {})
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[...]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> <span style="color:#66d9ef">Oneboxer</span><span style="color:#f92672">.</span>apply(cooked) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>url<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      @onebox_urls <span style="color:#f92672">&lt;&lt;</span> url
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> opts<span style="color:#f92672">[</span><span style="color:#e6db74">:invalidate_oneboxes</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">Oneboxer</span><span style="color:#f92672">.</span>invalidate(url)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">InlineOneboxer</span><span style="color:#f92672">.</span>invalidate(url)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      onebox <span style="color:#f92672">=</span> <span style="color:#66d9ef">Oneboxer</span><span style="color:#f92672">.</span>cached_onebox(url)
</span></span><span style="display:flex;"><span>      @found_oneboxes <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">if</span> onebox<span style="color:#f92672">.</span>present?
</span></span><span style="display:flex;"><span>      onebox
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cooked <span style="color:#f92672">=</span> result<span style="color:#f92672">.</span>to_html <span style="color:#66d9ef">if</span> result<span style="color:#f92672">.</span>changed?
</span></span><span style="display:flex;"><span>    cooked
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>可以看到 discourse 自己还有一个 Oneboxer 的 wrapper，这里使用了 Oneboxer.apply 和 Oneboxer.cache_onebox 函数。接下来我们接着看 <a href="https://github.com/discourse/discourse/blob/master/lib/oneboxer.rb">lib/oneboxer.rb</a>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">apply</span>(string_or_doc, <span style="color:#e6db74">extra_paths</span>: <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    doc <span style="color:#f92672">=</span> string_or_doc
</span></span><span style="display:flex;"><span>    doc <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nokogiri</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTML5</span><span style="color:#f92672">::</span>fragment(doc) <span style="color:#66d9ef">if</span> doc<span style="color:#f92672">.</span>is_a?(String)
</span></span><span style="display:flex;"><span>    changed <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    each_onebox_link(doc, <span style="color:#e6db74">extra_paths</span>: extra_paths) <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>url, element<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      onebox, _ <span style="color:#f92672">=</span> <span style="color:#66d9ef">yield</span>(url, element)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> onebox
</span></span><span style="display:flex;"><span>        parsed_onebox <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nokogiri</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTML5</span><span style="color:#f92672">::</span>fragment(onebox)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">next</span> <span style="color:#66d9ef">unless</span> parsed_onebox<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> element<span style="color:#f92672">&amp;.</span>parent<span style="color:#f92672">&amp;.</span>node_name<span style="color:#f92672">&amp;.</span>downcase <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;p&#34;</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>           element<span style="color:#f92672">.</span>parent<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>count <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;&amp;</span>
</span></span><span style="display:flex;"><span>           <span style="color:#66d9ef">HTML5_BLOCK_ELEMENTS</span><span style="color:#f92672">.</span>include?(parsed_onebox<span style="color:#f92672">.</span>children<span style="color:#f92672">[</span><span style="color:#ae81ff">0</span><span style="color:#f92672">].</span>node_name<span style="color:#f92672">.</span>downcase)
</span></span><span style="display:flex;"><span>          element <span style="color:#f92672">=</span> element<span style="color:#f92672">.</span>parent
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        changed <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        element<span style="color:#f92672">.</span>swap parsed_onebox<span style="color:#f92672">.</span>to_html
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># strip empty &lt;p&gt; elements</span>
</span></span><span style="display:flex;"><span>    doc<span style="color:#f92672">.</span>css(<span style="color:#e6db74">&#34;p&#34;</span>)<span style="color:#f92672">.</span>each <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>p<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> p<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>empty? <span style="color:#f92672">&amp;&amp;</span> doc<span style="color:#f92672">.</span>children<span style="color:#f92672">.</span>count <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>        p<span style="color:#f92672">.</span>remove
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Result</span><span style="color:#f92672">.</span>new(doc, changed)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>这段其实没啥用，简单解释下就是取到 cooked 这个 html 里需要 onebox 化的 URL node。然后 invalidate 之后取 cached_onebox。cached_onebox 与实际进行 onebox 化里面有太多的判断代码（onebox_raw)，我们只需要关注 Oneboxer 的这个函数就够了：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">external_onebox</span>(url)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Discourse</span><span style="color:#f92672">.</span>cache<span style="color:#f92672">.</span>fetch(onebox_cache_key(url), <span style="color:#e6db74">expires_in</span>: <span style="color:#ae81ff">1</span><span style="color:#f92672">.</span>day) <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>      fd <span style="color:#f92672">=</span> <span style="color:#66d9ef">FinalDestination</span><span style="color:#f92672">.</span>new(url,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">ignore_redirects</span>: ignore_redirects,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">ignore_hostnames</span>: blocked_domains,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">force_get_hosts</span>: force_get_hosts,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">force_custom_user_agent_hosts</span>: force_custom_user_agent_hosts,
</span></span><span style="display:flex;"><span>                                <span style="color:#e6db74">preserve_fragment_url_hosts</span>: preserve_fragment_url_hosts)
</span></span><span style="display:flex;"><span>      uri <span style="color:#f92672">=</span> fd<span style="color:#f92672">.</span>resolve
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> fd<span style="color:#f92672">.</span>status <span style="color:#f92672">!=</span> <span style="color:#e6db74">:resolved</span>
</span></span><span style="display:flex;"><span>        args <span style="color:#f92672">=</span> { <span style="color:#e6db74">link</span>: url }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> fd<span style="color:#f92672">.</span>status <span style="color:#f92672">==</span> <span style="color:#e6db74">:invalid_address</span>
</span></span><span style="display:flex;"><span>          args<span style="color:#f92672">[</span><span style="color:#e6db74">:error_message</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">I18n</span><span style="color:#f92672">.</span>t(<span style="color:#e6db74">&#34;errors.onebox.invalid_address&#34;</span>, <span style="color:#e6db74">hostname</span>: fd<span style="color:#f92672">.</span>hostname)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elsif</span> fd<span style="color:#f92672">.</span>status_code
</span></span><span style="display:flex;"><span>          args<span style="color:#f92672">[</span><span style="color:#e6db74">:error_message</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">I18n</span><span style="color:#f92672">.</span>t(<span style="color:#e6db74">&#34;errors.onebox.error_response&#34;</span>, <span style="color:#e6db74">status_code</span>: fd<span style="color:#f92672">.</span>status_code)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        error_box <span style="color:#f92672">=</span> blank_onebox
</span></span><span style="display:flex;"><span>        error_box<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> preview_error_onebox(args)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> error_box
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> blank_onebox <span style="color:#66d9ef">if</span> uri<span style="color:#f92672">.</span>blank? <span style="color:#f92672">||</span> blocked_domains<span style="color:#f92672">.</span>map { <span style="color:#f92672">|</span>hostname<span style="color:#f92672">|</span> uri<span style="color:#f92672">.</span>hostname<span style="color:#f92672">.</span>match?(hostname) }<span style="color:#f92672">.</span>any?
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      options <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">max_width</span>: <span style="color:#ae81ff">695</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">sanitize_config</span>: <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">::</span><span style="color:#66d9ef">DiscourseOneboxSanitizeConfig</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Config</span><span style="color:#f92672">::</span><span style="color:#66d9ef">DISCOURSE_ONEBOX</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">allowed_iframe_origins</span>: allowed_iframe_origins,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">hostname</span>: <span style="color:#66d9ef">GlobalSetting</span><span style="color:#f92672">.</span>hostname,
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">facebook_app_access_token</span>: <span style="color:#66d9ef">SiteSetting</span><span style="color:#f92672">.</span>facebook_app_access_token,
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      options<span style="color:#f92672">[</span><span style="color:#e6db74">:cookie</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> fd<span style="color:#f92672">.</span>cookie <span style="color:#66d9ef">if</span> fd<span style="color:#f92672">.</span>cookie
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      r <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>preview(uri<span style="color:#f92672">.</span>to_s, options)
</span></span><span style="display:flex;"><span>      result <span style="color:#f92672">=</span> { <span style="color:#e6db74">onebox</span>: r<span style="color:#f92672">.</span>to_s, <span style="color:#e6db74">preview</span>: r<span style="color:#f92672">&amp;.</span>placeholder_html<span style="color:#f92672">.</span>to_s }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># NOTE: Call r.errors after calling placeholder_html</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> r<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>any?
</span></span><span style="display:flex;"><span>        missing_attributes <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>map(<span style="color:#f92672">&amp;</span><span style="color:#e6db74">:to_s</span>)<span style="color:#f92672">.</span>sort<span style="color:#f92672">.</span>join(<span style="color:#66d9ef">I18n</span><span style="color:#f92672">.</span>t(<span style="color:#e6db74">&#34;word_connector.comma&#34;</span>))
</span></span><span style="display:flex;"><span>        error_message <span style="color:#f92672">=</span> <span style="color:#66d9ef">I18n</span><span style="color:#f92672">.</span>t(<span style="color:#e6db74">&#34;errors.onebox.missing_data&#34;</span>, <span style="color:#e6db74">missing_attributes</span>: missing_attributes, <span style="color:#e6db74">count</span>: r<span style="color:#f92672">.</span>errors<span style="color:#f92672">.</span>keys<span style="color:#f92672">.</span>size)
</span></span><span style="display:flex;"><span>        args <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>data<span style="color:#f92672">.</span>merge(<span style="color:#e6db74">error_message</span>: error_message)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> result<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">].</span>blank?
</span></span><span style="display:flex;"><span>          result<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> preview_error_onebox(args)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          doc <span style="color:#f92672">=</span> <span style="color:#66d9ef">Nokogiri</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTML5</span><span style="color:#f92672">::</span>fragment(result<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">]</span>)
</span></span><span style="display:flex;"><span>          aside <span style="color:#f92672">=</span> doc<span style="color:#f92672">.</span>at(<span style="color:#e6db74">&#39;aside&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">if</span> aside
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Add an error message to the preview that was returned</span>
</span></span><span style="display:flex;"><span>            error_fragment <span style="color:#f92672">=</span> preview_error_onebox_fragment(args)
</span></span><span style="display:flex;"><span>            aside<span style="color:#f92672">.</span>add_child(error_fragment)
</span></span><span style="display:flex;"><span>            result<span style="color:#f92672">[</span><span style="color:#e6db74">:preview</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> doc<span style="color:#f92672">.</span>to_html
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      result
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>这里可以看到：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>preview(uri<span style="color:#f92672">.</span>to_s, options)
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> { <span style="color:#e6db74">onebox</span>: r<span style="color:#f92672">.</span>to_s, <span style="color:#e6db74">preview</span>: r<span style="color:#f92672">&amp;.</span>placeholder_html<span style="color:#f92672">.</span>to_s }
</span></span></code></pre></div><p>这段是最主要的，也就是说 Onebox 这个 gem 是通过它的 preview 函数来与 discourse 进行交互的。discourse 代码看到这里就够了，下面我们来看 onebox 代码。</p>
<p>一个 rubygem 最重要的是它的 lib 文件夹。我们先从 <a href="https://github.com/discourse/onebox/blob/master/lib/onebox.rb">lib/onebox.rb</a> 看起：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>  <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">preview</span>(url, options <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># onebox does not have native caching</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unless</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Helpers</span><span style="color:#f92672">.</span>blank?(options<span style="color:#f92672">[</span><span style="color:#e6db74">:cache</span><span style="color:#f92672">]</span>)
</span></span><span style="display:flex;"><span>      warn <span style="color:#e6db74">&#34;Onebox no longer has inbuilt caching so `cache` option will be ignored.&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">Preview</span><span style="color:#f92672">.</span>new(url, options)
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>这就是上面的 <code>Onebox.preview</code> 的来源。最重要的是 Preview 这个 class。下面我们接着看 <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/preview.rb">lib/onebox/preview.rb</a>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Preview</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># see https://bugs.ruby-lang.org/issues/14688</span>
</span></span><span style="display:flex;"><span>    client_exception <span style="color:#f92672">=</span> defined?(<span style="color:#66d9ef">Net</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPClientException</span>) ? <span style="color:#66d9ef">Net</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPClientException</span> : <span style="color:#66d9ef">Net</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPServerException</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">WEB_EXCEPTIONS</span> <span style="color:#f92672">||=</span> <span style="color:#f92672">[</span>client_exception, <span style="color:#66d9ef">OpenURI</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPError</span>, <span style="color:#66d9ef">Timeout</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Error</span>, <span style="color:#66d9ef">Net</span><span style="color:#f92672">::</span><span style="color:#66d9ef">HTTPError</span>, <span style="color:#66d9ef">Errno</span><span style="color:#f92672">::</span><span style="color:#66d9ef">ECONNREFUSED</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(link, options <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options)
</span></span><span style="display:flex;"><span>      @url <span style="color:#f92672">=</span> link
</span></span><span style="display:flex;"><span>      @options <span style="color:#f92672">=</span> options<span style="color:#f92672">.</span>dup
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      allowed_origins <span style="color:#f92672">=</span> @options<span style="color:#f92672">[</span><span style="color:#e6db74">:allowed_iframe_origins</span><span style="color:#f92672">]</span> <span style="color:#f92672">||</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Engine</span><span style="color:#f92672">.</span>all_iframe_origins
</span></span><span style="display:flex;"><span>      @options<span style="color:#f92672">[</span><span style="color:#e6db74">:allowed_iframe_regexes</span><span style="color:#f92672">]</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">Engine</span><span style="color:#f92672">.</span>origins_to_regexes(allowed_origins)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      @engine_class <span style="color:#f92672">=</span> <span style="color:#66d9ef">Matcher</span><span style="color:#f92672">.</span>new(@url, @options)<span style="color:#f92672">.</span>oneboxed
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>可以看到，这段代码的意思是说根据 Matcher 来匹配 URL 从而取 oneboxed 的结果。接着看 <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/matcher.rb">lib/onebox/matcher.rb</a>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Matcher</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(link, options <span style="color:#f92672">=</span> {})
</span></span><span style="display:flex;"><span>      @url <span style="color:#f92672">=</span> link
</span></span><span style="display:flex;"><span>      @options <span style="color:#f92672">=</span> options
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">ordered_engines</span>
</span></span><span style="display:flex;"><span>      @ordered_engines <span style="color:#f92672">||=</span> <span style="color:#66d9ef">Engine</span><span style="color:#f92672">.</span>engines<span style="color:#f92672">.</span>sort_by <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>e<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        e<span style="color:#f92672">.</span>respond_to?(<span style="color:#e6db74">:priority</span>) ? e<span style="color:#f92672">.</span>priority : <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">oneboxed</span>
</span></span><span style="display:flex;"><span>      uri <span style="color:#f92672">=</span> <span style="color:#66d9ef">URI</span>(@url)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">unless</span> uri<span style="color:#f92672">.</span>port<span style="color:#f92672">.</span>nil? <span style="color:#f92672">||</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>allowed_ports<span style="color:#f92672">.</span>include?(uri<span style="color:#f92672">.</span>port)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">unless</span> uri<span style="color:#f92672">.</span>scheme<span style="color:#f92672">.</span>nil? <span style="color:#f92672">||</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>allowed_schemes<span style="color:#f92672">.</span>include?(uri<span style="color:#f92672">.</span>scheme)
</span></span><span style="display:flex;"><span>      ordered_engines<span style="color:#f92672">.</span>find { <span style="color:#f92672">|</span>engine<span style="color:#f92672">|</span> engine <span style="color:#f92672">===</span> uri <span style="color:#f92672">&amp;&amp;</span> has_allowed_iframe_origins?(engine) }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rescue</span> <span style="color:#66d9ef">URI</span><span style="color:#f92672">::</span><span style="color:#66d9ef">InvalidURIError</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>这段代码的意思是从 <code>ordered_engines</code> 里找到匹配 uri 的 engine。返回这个 engine。而 <code>ordered_engines</code> 来自 <code>Engine.engines</code>。我们来看最重要的 <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/engine.rb">lib/onebox/engine.rb</a>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">module</span> Engine
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">included</span>(object)
</span></span><span style="display:flex;"><span>      object<span style="color:#f92672">.</span>extend(<span style="color:#66d9ef">ClassMethods</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">engines</span>
</span></span><span style="display:flex;"><span>      constants<span style="color:#f92672">.</span>select <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>constant<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        constant<span style="color:#f92672">.</span>to_s <span style="color:#f92672">=~</span> <span style="color:#e6db74">/Onebox$/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span><span style="color:#f92672">.</span>map(<span style="color:#f92672">&amp;</span>method(<span style="color:#e6db74">:const_get</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;helpers&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;layout_support&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;file_type_finder&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/standard_embed&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/html&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/json&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/amazon_onebox&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/github_issue_onebox&#34;</span>
</span></span><span style="display:flex;"><span>require_relative <span style="color:#e6db74">&#34;engine/github_blob_onebox&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[...]</span>
</span></span></code></pre></div><p>这里的 included 函数其实是一个被重写的内置函数。它是 ruby 的 module 函数，意思是这个 module 被 included 到别的 Object 里的时候会做什么。也就是说 <code>module Engine</code> 这个模块被别的 Class/Module 这样 include 的时候会发生什么：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> A
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Engine</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>这里所有 include 了 module Engine 的 Class 都会自动获得 ClassMethods 的类方法，ClassMethods 模块在后面一点的地方：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">module</span> ClassMethods
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">===</span>(other)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> other<span style="color:#f92672">.</span>kind_of?(<span style="color:#66d9ef">URI</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">!!</span>(other<span style="color:#f92672">.</span>to_s <span style="color:#f92672">=~</span> class_variable_get(<span style="color:#e6db74">:@@matcher</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">super</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">priority</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">100</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">matches_regexp</span>(r)
</span></span><span style="display:flex;"><span>        class_variable_set <span style="color:#e6db74">:@@matcher</span>, r
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">requires_iframe_origins</span>(<span style="color:#f92672">*</span>origins)
</span></span><span style="display:flex;"><span>        class_variable_set <span style="color:#e6db74">:@@iframe_origins</span>, origins
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iframe_origins</span>
</span></span><span style="display:flex;"><span>        class_variable_defined?(<span style="color:#e6db74">:@@iframe_origins</span>) ? class_variable_get(<span style="color:#e6db74">:@@iframe_origins</span>) : <span style="color:#f92672">[]</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># calculates a name for onebox using the class name of engine</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">onebox_name</span>
</span></span><span style="display:flex;"><span>        name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;::&#34;</span>)<span style="color:#f92672">.</span>last<span style="color:#f92672">.</span>downcase<span style="color:#f92672">.</span>gsub(<span style="color:#e6db74">/onebox/</span>, <span style="color:#e6db74">&#34;&#34;</span>)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">always_https</span>
</span></span><span style="display:flex;"><span>        @https <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">always_https?</span>
</span></span><span style="display:flex;"><span>        @https
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>举个例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">module</span> Engine
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">YoukuOnebox</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">Engine</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">include</span> <span style="color:#66d9ef">HTML</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      matches_regexp(<span style="color:#e6db74">/^(https?:\/\/)?([\da-z\.-]+)(youku.com\/)(.)+\/?$/</span>)
</span></span><span style="display:flex;"><span>      requires_iframe_origins <span style="color:#e6db74">&#34;https://player.youku.com&#34;</span>
</span></span></code></pre></div><p>这是 <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/engine/youku_onebox.rb">lib/onebox/engine/youku_onebox.rb</a>。因为 <code>include Engine</code>，所以自动获得 matches_regexp 这个类方法，所以可以调用：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>matches_regexp(<span style="color:#e6db74">/^(https?:\/\/)?([\da-z\.-]+)(youku.com\/)(.)+\/?$/</span>)
</span></span></code></pre></div><p>来将 YoukuOnebox 这个 Class 的类全局变量 <code>@@matcher</code> 设置为上面的 regexp。通过这个例子我们应该大概可以明白为什么能够刚定义一个新类就拥有那么多的类方法了。同样功效的还有 <code>include HTML</code>，<code>include JSON</code>等等。下一篇用的的时候再给大家看代码。</p>
<p>下面来看第二个方法：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">engines</span>
</span></span><span style="display:flex;"><span>      constants<span style="color:#f92672">.</span>select <span style="color:#66d9ef">do</span> <span style="color:#f92672">|</span>constant<span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>        constant<span style="color:#f92672">.</span>to_s <span style="color:#f92672">=~</span> <span style="color:#e6db74">/Onebox$/</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span><span style="color:#f92672">.</span>map(<span style="color:#f92672">&amp;</span>method(<span style="color:#e6db74">:const_get</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>很多新手这时候就无法理解了。<a href="https://apidock.com/ruby/Module/constants">constants</a> 是什么？它其实 ruby 的一个 Module 方法。返回这个 module 的所有常量，定义在 Module 内部的 Class 也是常量，给段测试代码：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> A
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">B</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> C
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">include</span> A
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">self</span><span style="color:#f92672">.</span><span style="color:#a6e22e">test</span>
</span></span><span style="display:flex;"><span>   p constants
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>C<span style="color:#f92672">.</span>test
</span></span></code></pre></div><p>上面运行 C.test 的结果是 <code>[:B]</code>。类名 B 是 C 的常量。那么 <code>self.engines</code> 这个函数其实就好理解了。从 Engine module 的全部类中找到以 <code>Onebox</code> 结尾的，并且返回一个字符串数组。上面 Youku 的那个例子我们已经看到了，所有的自定义 Engine 都是这个结构：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Onebox
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">module</span> Engine
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">YoukuOnebox</span>
</span></span></code></pre></div><p>目的就是让 <code>self.engines</code> 函数能够知道它的存在。</p>
<p>我们接着往下看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">initialize</span>(link, timeout <span style="color:#f92672">=</span> <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>      @errors <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>      @options <span style="color:#f92672">=</span> <span style="color:#66d9ef">DEFAULT</span>
</span></span><span style="display:flex;"><span>      class_name <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>class<span style="color:#f92672">.</span>name<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#34;::&#34;</span>)<span style="color:#f92672">.</span>last<span style="color:#f92672">.</span>to_s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      <span style="color:#75715e"># Set the engine options extracted from global options.</span>
</span></span><span style="display:flex;"><span>      self<span style="color:#f92672">.</span>options <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options<span style="color:#f92672">[</span>class_name<span style="color:#f92672">]</span> <span style="color:#f92672">||</span> {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>      @url <span style="color:#f92672">=</span> link
</span></span><span style="display:flex;"><span>      @uri <span style="color:#f92672">=</span> <span style="color:#66d9ef">URI</span>(link)
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> always_https?
</span></span><span style="display:flex;"><span>        @uri<span style="color:#f92672">.</span>scheme <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https&#39;</span>
</span></span><span style="display:flex;"><span>        @url <span style="color:#f92672">=</span> @uri<span style="color:#f92672">.</span>to_s
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      @timeout <span style="color:#f92672">=</span> timeout <span style="color:#f92672">||</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>options<span style="color:#f92672">.</span>timeout
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>是不是很有意思，一个 Module 居然有 initialize 函数！他的作用是，include 它的 class 的 new instance 生成的时候，如果这个 class 本身没有写 initialize 函数，那么运行 module 带的。要是写了，在 class 的 initialize 函数里可以运行 super 来运行 module 带的。我们看 engine 文件夹里所有的自定义引擎都没有写自己的 initialize 函数，就是因为这里写了。</p>
<p>这里定义了一些实例变量，这些变量是写自定义引擎的时候可以直接用的。</p>
<p>接着往下看：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#75715e"># raises error if not defined in onebox engine.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># This is the output method for an engine.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_html</span>
</span></span><span style="display:flex;"><span>      fail <span style="color:#66d9ef">NoMethodError</span>, <span style="color:#e6db74">&#34;Engines need to implement this method&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>这种函数看起来很奇怪对不对？直接抛错误。因为 Ruby 是可以重写方法的。上面 YoukuOnebox 的例子里：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_html</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;&lt;~</span><span style="color:#66d9ef">HTML</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;</span>iframe src<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://player.youku.com/embed/</span><span style="color:#e6db74">#{</span>video_id<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>                  width<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;640&#34;</span>
</span></span><span style="display:flex;"><span>                  height<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;430&#34;</span>
</span></span><span style="display:flex;"><span>                  frameborder<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;0&#39;</span>
</span></span><span style="display:flex;"><span>                  allowfullscreen<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">&lt;</span><span style="color:#e6db74">/iframe&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">        HTML
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">      end
</span></span></span></code></pre></div><p>就重写了这个方法。这样 Engine module 调用方法的时候实际上是不空的。下面我们来捋一下 <code>Onebox.preview(url, options)</code> 的流程：</p>
<p><code>Onebox.preview</code> 调用<code>Preview.new(url,options)</code>,后者调用 <code>Matcher.new(@url, @options).oneboxed</code>, Matcher 是获取全部自定义引擎后通过判断 <code>engine == uri</code>来找出对应引擎。</p>
<p>上面的理解了我们就可以接着理解 <code>engine == uri</code> 了。我们前面已经说了，所有的自定义引擎都 <code>include Engine</code>了，得到了<code>ClassMethods</code>的类方法，有一个类方法就是这个：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>      <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">===</span>(other)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> other<span style="color:#f92672">.</span>kind_of?(<span style="color:#66d9ef">URI</span>)
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">!!</span>(other<span style="color:#f92672">.</span>to_s <span style="color:#f92672">=~</span> class_variable_get(<span style="color:#e6db74">:@@matcher</span>))
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">super</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>如果是拿 URI 来判断的话，先把它转成字符串，然后与自定义引擎的类变量 <code>@@matcher</code> 做正则匹配，就能够确保引擎的唯一性。</p>
<p>上面也说了，Onebox.preview 最终得到的结果是 Engine module 里面的一个自定义 Class。那么 discourse 是怎么使用这个 engine 的呢？</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    r <span style="color:#f92672">=</span> <span style="color:#66d9ef">Onebox</span><span style="color:#f92672">.</span>preview(uri<span style="color:#f92672">.</span>to_s, options)
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> { <span style="color:#e6db74">onebox</span>: r<span style="color:#f92672">.</span>to_s, <span style="color:#e6db74">preview</span>: r<span style="color:#f92672">&amp;.</span>placeholder_html<span style="color:#f92672">.</span>to_s }
</span></span></code></pre></div><p>我们再把 discourse 的这段代码拿回来理解。它定义了一个 hash。其中 onebox 是这个自定义 class 的 to_s，引擎怎么转字符串呢？在 <a href="https://github.com/discourse/onebox/blob/master/lib/onebox/preview.rb">lib/onebox/preview.rb</a> 里面：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">to_s</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#66d9ef">unless</span> engine
</span></span><span style="display:flex;"><span>      sanitize process_html engine_html
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">rescue</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">WEB_EXCEPTIONS</span>
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>对我们用处不大，略。那么 preview 是什么呢？是调用了引擎的 placeholder_html 方法，这个方法在 engine.rb 里面。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">placeholder_html</span>
</span></span><span style="display:flex;"><span>      to_html
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">end</span>
</span></span></code></pre></div><p>它调用了默认抛错误的那个 to_html 方法，而当有了确定的引擎后，to_html 方法是自定义引擎实现的。也就是说，想要写一个自定义引擎，最最重要的方法是 <code>matches_regexp</code>和<code>to_html</code>。</p>
<p>对于 Onebox gem 的理解到这里就可以了。下一篇我们将要真正开始写我们的插件。</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer><script src="https://utteranc.es/client.js"
        repo="marguerite/marguerite.github.io"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://marguerite.github.io/">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>

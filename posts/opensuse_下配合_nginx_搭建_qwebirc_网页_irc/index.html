<!DOCTYPE html>
<html lang="zh-cn">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>openSUSE 下配合 Nginx 搭建 qwebirc 网页 IRC</title>
	
	
	<link rel="stylesheet" href="/css/style.css">
	
</head>
<body>
	<header>
	<a href="https://marguerite.github.io">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a>
	
</header>

	
	<main>
		<article>
			<h1>openSUSE 下配合 Nginx 搭建 qwebirc 网页 IRC</h1>
			<time>12.10.2013 00:00</time>
			<div>
				<p>做这个的初衷很简单：IRC 对小白太远了。</p>
<p>它不像论坛，打开网页就能刷; 不像 QQ/Gtalk，软件是人都能找到，装上就能上。它需要专用客户端（比如 konversation），而且装完你还不能上，还有一堆命令等着你，何况还有 20 年早期互联网流传下来的各种名词、礼仪。总之它是一整个与世隔绝的黑客生态圈。</p>
<p>但是吧，不学还不行，你看哪个开发者不会使用 IRC 的？于是我想先降低一下它对小白们的陌生感，做一个给蠢人用的玩意。（成功把自己从其它蠢人中分离开以示区别哦耶！）</p>
<p>于是最蠢的来了：qwebirc，是一个自由开源的网页 IRC 客户端，最早是给 QuakeNet 游戏网开发的。这是目前我能找到的唯一一个开源的。</p>
<p>看了下，发现它居然不支持多语言！好吧，硬 hack 出了一个繁体中文版（别问为什么不用简体，因为硬 hack 就是只能使用一种语言，没有动态切换，那简体用户繁体一样能看懂，自豪吧？）。</p>
<h4 id="安装依赖opensuse-下">安装依赖（openSUSE 下）</h4>
<pre><code>sudo zypper in nginx python-Twisted python-simplejson java-1_7_0-openjdk
</code></pre>
<h4 id="下载">下载</h4>
<p>然后随便找个文件夹，因为 qwebirc 和 HTTP 服务器的关系不是常规那样的，常规是在 /srv/www/htdocs（又叫 webroot）下面放一些 html/php 文件，然后 HTTP 服务器让那个文件夹下面的东西能被访问，但是 qwebirc 其实是自己跑起来了一个专用的 http 服务器，为什么呢？据说是通用 HTTP 服务器设计不是用来服务大量的、长期活动的连接的，它们可以处理的是大量的但是都是一次性的连接，这种基于线程或者多进程的服务器（Apache 被点名了）没办法处理太多的这种连接，到时候会把你的网站一起拽下线呦！</p>
<p>但 qwebirc 的专用服务器是开在 9090 端口的，你不想访问 yourircserver.com:9090 这种丑丑的链接吧？所以你需要一个反向代理，还不能用被怒黑的 Apache。。。也就 nginx 了吧？好在我们别的服务器也是用的 nginx，因为 openSUSE 社区穷 VPS 内存小。。。</p>
<p>言归正传。找到文件夹了吧？然后在命令行下载最新的稳定版 qwebirc：</p>
<pre><code>wget http://qwebirc.org/download-stable-zip
</code></pre>
<p>它没后缀但它是个 zip，解压：</p>
<pre><code>unzip download-stable-zip
</code></pre>
<p>进入文件夹：</p>
<pre><code>cd qwebirc-qwebirc-516de557ddc7
</code></pre>
<h4 id="配置">配置</h4>
<p>把 config.py.example 复制为 config.py：</p>
<pre><code>cp -r config.py.example config.py
</code></pre>
<p>打开</p>
<pre><code>vi config.py
</code></pre>
<p>要改的我都写好：</p>
<p>连接到的服务器:</p>
<pre><code>IRCSERVER, IRCPORT = &quot;chat.freenode.net&quot;, 6667
</code></pre>
<p>因为我们是网页客户端不是网页服务器端，我们要连一个服务器的…</p>
<p>REALNAME:</p>
<pre><code>REALNAME = &quot;http://irc.suse.org.cn/&quot;
</code></pre>
<p>你要提供服务的那个网址</p>
<p>BASE_URL:</p>
<pre><code>BASE_URL = &quot;http://irc.suse.org.cn/&quot;
</code></pre>
<p>同上</p>
<pre><code>NETWORK_NAME = “openSUSE 中文”
</code></pre>
<p>你的客户端显示给客户看的「你叫什么名」字段。这里需要注意，如果你要用中文，要在这个页面的最上面加上这两行：</p>
<pre><code>#!/usr/bin/python
# -*- coding: utf-8 -*-
</code></pre>
<p>因为它用 python2 写的，默认是英文编码…</p>
<p>Nginx 相关配置:</p>
<pre><code>FORWARDED_FOR_HEADER=&quot;x-forwarded-for&quot;
FORWARDED_FOR_IPS=[&quot;127.0.0.1&quot;]
ARGS = &quot;-i 127.0.0.1 -p 9090&quot;
</code></pre>
<p>简单说就是在你 VPS 上的 127.0.0.1:9090 开一个网页 IRC，然后 Nginx 后面干的事就是把对你的某个网址比如 irc.suse.org.cn 的访问全中转给 127.0.0.1:9090 上。我不太懂，但听起来像是挺安全的，因为我觉得 127.0.0.1 只有登录到那台 VPS 才能用的嘛。</p>
<p>当然你也可以试试把前两个的 # 号继续留着，然后直接：</p>
<pre><code>ARGS = &quot;-i 你的公网 IP -p 80&quot;
</code></pre>
<p>没试验哦，估计这样就能直接开在你的 80 端口了，也不用 nginx 了。但这样做最大的问题就是你的那个公网 IP 也只能做网页 IRC 了。因为不管你怎么做域名解析，通过浏览器过来的都默认跑 80 端口就来到这里了，如果别的还用（我不懂网络那些哦），可能就会出现我前面 nginx 重定向配置错误时的情况，时而打开网页 IRC，时而打开你别的网站…</p>
<p>而用 nginx 做反向代理的话，那个 IP 还可以干别的。（我说的是 IP 不是域名哦，你不可能 irc.suse.org.cn 又当 wordpress 博客又当网页 IRC 的）</p>
<p>剩下的配置就留默认就好</p>
<h4 id="编译和启动">编译和启动</h4>
<p>这里其实我有点不能理解，它编译应该是把 *.py 编译为 *.pyc/pyo 才对，但事实上，你在 javascript 里面的硬翻译，也是由编译来管的…我刚开始先架设了一个英文的，然后本地翻译完，上传，我想 js 应该刷新网页就好了吧，结果不行…debug 了好久，后来在官网 Installation 指南看到</p>
<pre><code>Run compile.py to &quot;compile the HTML/js/css&quot;
</code></pre>
<p>整个人都呆掉了…</p>
<p>开始编译：</p>
<pre><code>./compile.py
</code></pre>
<p>把它跑起来：</p>
<pre><code>./run.py
</code></pre>
<p>它写的就比较有节操，自己会 fork 自己到后台，不像我之前写的那些 openshift 跑 python 的教程里面的脚本都要使用 nohup 来跑…</p>
<p>qwebirc 就配置好了。</p>
<h4 id="nginx-反向代理">Nginx 反向代理</h4>
<pre><code>cd /etc/nginx
</code></pre>
<p>你是直接编辑 /etc/nginx/nginx.conf 还是建一个 /etc/nginx/vhosts.d/irc.suse.org.cn.conf 我管不着，反正里面是像这样的：</p>
<pre><code>server {
listen 80;
listen [::]:80;

server_name webchat.domain.tld;

access_log /var/log/qwebirc.access.log;
error_log /var/log/qwebirc.error.log;

proxy_set_header X-Real-IP $remote_addr;
proxy_set_header Host $host;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_buffering off;

location / {
    proxy_pass http://127.0.0.1:9090;
    }
}
</code></pre>
<p>它和 Nginx Wiki 上说的那个配置的唯一不同之处在于：</p>
<pre><code>listen 80;
listen [::]:80;
</code></pre>
<p>Wiki 上用的是：</p>
<pre><code>listen 127.0.0.1:80;
listen [::1]:80;
</code></pre>
<p>导致我在不明白其原理的时候狂刷 irc.suse.org.cn。。。。</p>
<p>后来才反应过来：Wiki 的教学的场景是说，你在本机（127.0.0.1）跑起来了一个 qwebirc，然后嫌用 127.0.0.1:9090 访问它比较的麻烦，于是做下反向代理让 127.0.0.1 可以直接访问到它。</p>
<p>但我们的场景是说，我在本机（127.0.0.1）跑起来了一个 qwebirc，然后想用 <a href="http://irc.suse.org.cn">http://irc.suse.org.cn</a> 直接访问它！127.0.0.1:9090 和我没一毛钱关系，因为我没在服务器上登录装图形界面开网页浏览器…</p>
<p>我们要让 Nginx 去监听对 irc.suse.org.cn 的 80 端口访问，然后把它扔给 VPS 上的 127.0.0.1:9090。。。所以直接监听 server_name 的 80 端口就好了嘛…</p>
<p>这个错误很难反应过来，尤其对我这种水货 SA！Nginx 还会正常跑，但你在 VPS 外面是访问不到它的：</p>
<p>qwebirc 提供的服务在 127.0.0.1 不是你的公网 IP，所以你用 xxx.xxx.xxx.xxx:9090 根本打不开…甚至 Nginx 也不知道你在干啥，因为别的配置是没有用 9090 端口的，连 Fallback 这种安慰奖都没有…</p>
<p>nginx 监听着你的内！网！IP！你访问 irc.suse.org.cn，是有这个配置，但是它找了一圈发现没有跟 irc.suse.org.cn: 有关的事啊，这个配置在管 127.0.0.1 呢…</p>
<p>还有注意：proxy_pass http://127.0.0.1:9090; 这个不要手贱把 127.0.0.1 改成 irc.suse.org.cn 了。。。因为那个域名的 A 记录是你的公网 IP，而 qwebirc 并没有对公网提供服务…血泪的教训！</p>
<p>接着重启下 Nginx 服务器：</p>
<pre><code>sudo systemctl restart nginx.service
</code></pre>
<p>就 OK 了！</p>
<p>PS：终于有个顺手的 IRC 去调戏 #kde-cn 的 BadGirl 了…</p>

			</div>
			
			<div>
				<div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "innamoramento" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
			</div>
		</article>
	</main>
<aside>
	<div>
		<div>
			<h3>LATEST POSTS</h3>
		</div>
		<div>
			<ul>
				
				<li><a href="/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%89%E5%8E%BB%E6%8E%89-watir-%E4%BE%9D%E8%B5%96/">为 Discourse 开发一个 Onebox 插件（三）去掉 watir 依赖</a></li>
				
				<li><a href="/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%BA%8C%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%86%99%E6%8F%92%E4%BB%B6/">为 Discourse 开发一个 Onebox 插件（二）从零开始写 custom engine</a></li>
				
				<li><a href="/posts/%E4%B8%BA-discourse-%E5%BC%80%E5%8F%91%E4%B8%80%E4%B8%AA-onebox-%E6%8F%92%E4%BB%B6%E4%B8%80%E7%90%86%E8%A7%A3-onebox-gem/">为 Discourse 开发一个 Onebox 插件（一）理解 Onebox gem</a></li>
				
				<li><a href="/posts/color_emoji_in_opensuse/">Color Emoji in openSUSE</a></li>
				
				<li><a href="/posts/fontconfig_%E5%87%A0%E4%B8%AA%E5%B8%B8%E8%A7%81%E7%9A%84%E5%9D%91/">fontconfig 几个常见的坑</a></li>
				
			</ul>
		</div>
	</div>
</aside>


	<footer>
	<p>&copy; 2020 <a href="https://marguerite.github.io">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a></p>
</footer>

</body>
</html>

<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>openshift 搭建和 IRC 频道互通的 Gtalk 群聊 | Marguerite Su: Golang/Ruby Programmer, openSUSE Member</title>
<meta name="keywords" content="">
<meta name="description" content="Long long ago，大概八九个月前，看到翁学天的 ikde 群居然能和 IRC 互通，感觉很惊艳，于是也想弄一个替代现在的 opensuse_zh@im.partych.at。
Party Chat 是一个很好的免折腾 Gtalk 群聊主机服务，架设在 Amazon 上面，但是有以下缺点：

不能和 IRC 互通。作为一个开源社区，要是没有利用上 IRC，总感觉少了点什么。
在线时间不能保证。也就是说你没有 schduled_maintenance 的权利，只能它在线你就聊，它离线你就歇息。
大于 300 人的群拒绝服务。也就是说你的群是顶着地雷的，到了 300 人整个群就会消失，因为 Party Chat 不能承担那些多出来的流量钱。你交钱也不给你提供额外服务。

所以几十个人的小社群还是可以应付的，但是人满了之后迁移成本特别大。所以就想着趁人少迁移到 ikde 那种高级群里去。
打听了一下，这种群聊是使用依云(@lilydjwg 写的两个软件在 VPS 上搭建的，分别是 xmpptalk 和 ircbindxmpp。
但问题出来了，我没有 VPS。当时 openshift 这种 PaaS 已经出现了，只是还比较新鲜，我不会用。于是去年 9 月的一次尝试就可耻地失败了。
当时（甚至至今）网上关于这两个软件的文章只有两篇：

依云自己的介绍性文章，但是太粗略了。
StarBrilliant 的稍微详细一些的文章，但是还是有点犯了程序员的通病：普通用户不知所云。如果你是一个已有 VPS 的博主，看了也得折腾一会儿，要是麻瓜的话，恐怕也就只能看个热闹了。

于是逼迫我们群里的 douglarek 写了一篇在 openshift 上折腾它们的文章给我：
Openshift 折腾 xmpptalk
但实际上这篇文章很水。反正看过就知道啦，到处都是「凑合」。实际上你看它也根本架设不起来（好多致命细节都没说）。
当时我就是在这种情况下开始折腾的。
首先我开了 Do it yourself 应用，然后进去编译，结果很悲剧，红帽给的内存太小，mongodb 编译不成功; 后来我使用 Build Service 模拟了一个 openshift 环境（一个 x86_64 的 RHEL），然后编译编译，我犯懒了…">
<meta name="author" content="">
<link rel="canonical" href="https://marguerite.github.io/posts/openshift_%E6%90%AD%E5%BB%BA%E5%92%8C_irc_%E9%A2%91%E9%81%93%E4%BA%92%E9%80%9A%E7%9A%84_gtalk_%E7%BE%A4%E8%81%8A/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://marguerite.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://marguerite.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://marguerite.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://marguerite.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://marguerite.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://marguerite.github.io/posts/openshift_%E6%90%AD%E5%BB%BA%E5%92%8C_irc_%E9%A2%91%E9%81%93%E4%BA%92%E9%80%9A%E7%9A%84_gtalk_%E7%BE%A4%E8%81%8A/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:url" content="https://marguerite.github.io/posts/openshift_%E6%90%AD%E5%BB%BA%E5%92%8C_irc_%E9%A2%91%E9%81%93%E4%BA%92%E9%80%9A%E7%9A%84_gtalk_%E7%BE%A4%E8%81%8A/">
  <meta property="og:site_name" content="Marguerite Su: Golang/Ruby Programmer, openSUSE Member">
  <meta property="og:title" content="openshift 搭建和 IRC 频道互通的 Gtalk 群聊">
  <meta property="og:description" content="Long long ago，大概八九个月前，看到翁学天的 ikde 群居然能和 IRC 互通，感觉很惊艳，于是也想弄一个替代现在的 opensuse_zh@im.partych.at。
Party Chat 是一个很好的免折腾 Gtalk 群聊主机服务，架设在 Amazon 上面，但是有以下缺点：
不能和 IRC 互通。作为一个开源社区，要是没有利用上 IRC，总感觉少了点什么。 在线时间不能保证。也就是说你没有 schduled_maintenance 的权利，只能它在线你就聊，它离线你就歇息。 大于 300 人的群拒绝服务。也就是说你的群是顶着地雷的，到了 300 人整个群就会消失，因为 Party Chat 不能承担那些多出来的流量钱。你交钱也不给你提供额外服务。 所以几十个人的小社群还是可以应付的，但是人满了之后迁移成本特别大。所以就想着趁人少迁移到 ikde 那种高级群里去。
打听了一下，这种群聊是使用依云(@lilydjwg 写的两个软件在 VPS 上搭建的，分别是 xmpptalk 和 ircbindxmpp。
但问题出来了，我没有 VPS。当时 openshift 这种 PaaS 已经出现了，只是还比较新鲜，我不会用。于是去年 9 月的一次尝试就可耻地失败了。
当时（甚至至今）网上关于这两个软件的文章只有两篇：
依云自己的介绍性文章，但是太粗略了。 StarBrilliant 的稍微详细一些的文章，但是还是有点犯了程序员的通病：普通用户不知所云。如果你是一个已有 VPS 的博主，看了也得折腾一会儿，要是麻瓜的话，恐怕也就只能看个热闹了。 于是逼迫我们群里的 douglarek 写了一篇在 openshift 上折腾它们的文章给我：
Openshift 折腾 xmpptalk
但实际上这篇文章很水。反正看过就知道啦，到处都是「凑合」。实际上你看它也根本架设不起来（好多致命细节都没说）。
当时我就是在这种情况下开始折腾的。
首先我开了 Do it yourself 应用，然后进去编译，结果很悲剧，红帽给的内存太小，mongodb 编译不成功; 后来我使用 Build Service 模拟了一个 openshift 环境（一个 x86_64 的 RHEL），然后编译编译，我犯懒了…">
  <meta property="og:locale" content="zh-cn">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2013-03-17T00:00:00+08:00">
    <meta property="article:modified_time" content="2013-03-17T00:00:00+08:00">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="openshift 搭建和 IRC 频道互通的 Gtalk 群聊">
<meta name="twitter:description" content="Long long ago，大概八九个月前，看到翁学天的 ikde 群居然能和 IRC 互通，感觉很惊艳，于是也想弄一个替代现在的 opensuse_zh@im.partych.at。
Party Chat 是一个很好的免折腾 Gtalk 群聊主机服务，架设在 Amazon 上面，但是有以下缺点：

不能和 IRC 互通。作为一个开源社区，要是没有利用上 IRC，总感觉少了点什么。
在线时间不能保证。也就是说你没有 schduled_maintenance 的权利，只能它在线你就聊，它离线你就歇息。
大于 300 人的群拒绝服务。也就是说你的群是顶着地雷的，到了 300 人整个群就会消失，因为 Party Chat 不能承担那些多出来的流量钱。你交钱也不给你提供额外服务。

所以几十个人的小社群还是可以应付的，但是人满了之后迁移成本特别大。所以就想着趁人少迁移到 ikde 那种高级群里去。
打听了一下，这种群聊是使用依云(@lilydjwg 写的两个软件在 VPS 上搭建的，分别是 xmpptalk 和 ircbindxmpp。
但问题出来了，我没有 VPS。当时 openshift 这种 PaaS 已经出现了，只是还比较新鲜，我不会用。于是去年 9 月的一次尝试就可耻地失败了。
当时（甚至至今）网上关于这两个软件的文章只有两篇：

依云自己的介绍性文章，但是太粗略了。
StarBrilliant 的稍微详细一些的文章，但是还是有点犯了程序员的通病：普通用户不知所云。如果你是一个已有 VPS 的博主，看了也得折腾一会儿，要是麻瓜的话，恐怕也就只能看个热闹了。

于是逼迫我们群里的 douglarek 写了一篇在 openshift 上折腾它们的文章给我：
Openshift 折腾 xmpptalk
但实际上这篇文章很水。反正看过就知道啦，到处都是「凑合」。实际上你看它也根本架设不起来（好多致命细节都没说）。
当时我就是在这种情况下开始折腾的。
首先我开了 Do it yourself 应用，然后进去编译，结果很悲剧，红帽给的内存太小，mongodb 编译不成功; 后来我使用 Build Service 模拟了一个 openshift 环境（一个 x86_64 的 RHEL），然后编译编译，我犯懒了…">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://marguerite.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "openshift 搭建和 IRC 频道互通的 Gtalk 群聊",
      "item": "https://marguerite.github.io/posts/openshift_%E6%90%AD%E5%BB%BA%E5%92%8C_irc_%E9%A2%91%E9%81%93%E4%BA%92%E9%80%9A%E7%9A%84_gtalk_%E7%BE%A4%E8%81%8A/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "openshift 搭建和 IRC 频道互通的 Gtalk 群聊",
  "name": "openshift 搭建和 IRC 频道互通的 Gtalk 群聊",
  "description": "Long long ago，大概八九个月前，看到翁学天的 ikde 群居然能和 IRC 互通，感觉很惊艳，于是也想弄一个替代现在的 opensuse_zh@im.partych.at。\nParty Chat 是一个很好的免折腾 Gtalk 群聊主机服务，架设在 Amazon 上面，但是有以下缺点：\n不能和 IRC 互通。作为一个开源社区，要是没有利用上 IRC，总感觉少了点什么。 在线时间不能保证。也就是说你没有 schduled_maintenance 的权利，只能它在线你就聊，它离线你就歇息。 大于 300 人的群拒绝服务。也就是说你的群是顶着地雷的，到了 300 人整个群就会消失，因为 Party Chat 不能承担那些多出来的流量钱。你交钱也不给你提供额外服务。 所以几十个人的小社群还是可以应付的，但是人满了之后迁移成本特别大。所以就想着趁人少迁移到 ikde 那种高级群里去。\n打听了一下，这种群聊是使用依云(@lilydjwg 写的两个软件在 VPS 上搭建的，分别是 xmpptalk 和 ircbindxmpp。\n但问题出来了，我没有 VPS。当时 openshift 这种 PaaS 已经出现了，只是还比较新鲜，我不会用。于是去年 9 月的一次尝试就可耻地失败了。\n当时（甚至至今）网上关于这两个软件的文章只有两篇：\n依云自己的介绍性文章，但是太粗略了。 StarBrilliant 的稍微详细一些的文章，但是还是有点犯了程序员的通病：普通用户不知所云。如果你是一个已有 VPS 的博主，看了也得折腾一会儿，要是麻瓜的话，恐怕也就只能看个热闹了。 于是逼迫我们群里的 douglarek 写了一篇在 openshift 上折腾它们的文章给我：\nOpenshift 折腾 xmpptalk\n但实际上这篇文章很水。反正看过就知道啦，到处都是「凑合」。实际上你看它也根本架设不起来（好多致命细节都没说）。\n当时我就是在这种情况下开始折腾的。\n首先我开了 Do it yourself 应用，然后进去编译，结果很悲剧，红帽给的内存太小，mongodb 编译不成功; 后来我使用 Build Service 模拟了一个 openshift 环境（一个 x86_64 的 RHEL），然后编译编译，我犯懒了…\n",
  "keywords": [
    
  ],
  "articleBody": "Long long ago，大概八九个月前，看到翁学天的 ikde 群居然能和 IRC 互通，感觉很惊艳，于是也想弄一个替代现在的 opensuse_zh@im.partych.at。\nParty Chat 是一个很好的免折腾 Gtalk 群聊主机服务，架设在 Amazon 上面，但是有以下缺点：\n不能和 IRC 互通。作为一个开源社区，要是没有利用上 IRC，总感觉少了点什么。 在线时间不能保证。也就是说你没有 schduled_maintenance 的权利，只能它在线你就聊，它离线你就歇息。 大于 300 人的群拒绝服务。也就是说你的群是顶着地雷的，到了 300 人整个群就会消失，因为 Party Chat 不能承担那些多出来的流量钱。你交钱也不给你提供额外服务。 所以几十个人的小社群还是可以应付的，但是人满了之后迁移成本特别大。所以就想着趁人少迁移到 ikde 那种高级群里去。\n打听了一下，这种群聊是使用依云(@lilydjwg 写的两个软件在 VPS 上搭建的，分别是 xmpptalk 和 ircbindxmpp。\n但问题出来了，我没有 VPS。当时 openshift 这种 PaaS 已经出现了，只是还比较新鲜，我不会用。于是去年 9 月的一次尝试就可耻地失败了。\n当时（甚至至今）网上关于这两个软件的文章只有两篇：\n依云自己的介绍性文章，但是太粗略了。 StarBrilliant 的稍微详细一些的文章，但是还是有点犯了程序员的通病：普通用户不知所云。如果你是一个已有 VPS 的博主，看了也得折腾一会儿，要是麻瓜的话，恐怕也就只能看个热闹了。 于是逼迫我们群里的 douglarek 写了一篇在 openshift 上折腾它们的文章给我：\nOpenshift 折腾 xmpptalk\n但实际上这篇文章很水。反正看过就知道啦，到处都是「凑合」。实际上你看它也根本架设不起来（好多致命细节都没说）。\n当时我就是在这种情况下开始折腾的。\n首先我开了 Do it yourself 应用，然后进去编译，结果很悲剧，红帽给的内存太小，mongodb 编译不成功; 后来我使用 Build Service 模拟了一个 openshift 环境（一个 x86_64 的 RHEL），然后编译编译，我犯懒了…\n今年三月份挖出了作者，又折腾了一个多礼拜，总算搞定了。下面是正文：\n注册一个 Do it yourself 应用 注册、配置 ssh 和怎么使用 ssh 登入服务器的教学见 douglarek 和我之前几篇讲 openshift 的教学，都是最基本的英文，基本能注册 GMail 的都会弄，不能注册 GMail 的基本你也不能在墙外看见我的文章。\n编译 基本的 Do it yourself 应用是带有以下部分的：Git，bz2/gz 的解压软件。所以你这些是不需要的。\nssh 进去之后，cd $OPENSHIFT_DATA_DIR，这个文件夹的完整位置是在 app-root/runtime/data，当然你也可以使用 echo $OPENSHIFT_DATA_DIR 看到它的完整路径。\n在这个文件夹里使用 wget URL 去下载源代码，git clone 捡出 git 仓库。这些我都假设你已经知道了。\n所有的编译过程都是源自依云的 scripts/quick_install.sh，但是我更新了一些东西，所以最好还是看我的。\n编译 Python 2.7 下载 python 2.7.3 和 3.3 的源代码（你看到这篇的文章的时候可能已经更新了，所以请去 python.org 下载最新版）。然后解压。\n编译 2.7.3 是因为后面我们有个程序要用 2to3 把针对 Python 2 gen 写的代码转义到 Python 3 gen。\nmkdir python2.7 (我们要把最终的 python 2.7 装进去，因为你没有权限往 /usr 装) cd Python-2.7.3 // 依云原版的多了个 `--with-computed-gotos`，但这个选项已经没有了，变默认了。另外一个 `--with-wide-unicode` 作废了，现在默认就是 long。 ./configure --enable-shared --with-threads --enable-ipv6 --with-system-expat --with-system-ffi --prefix=${OPENSHIFT_DATA_DIR}/python2.7/ make -j4 make install 这样 python2.7 里就有 python 了。\n编译 Python 3.3 这才是主依赖，因为依云的代码是基于 3.2 版 Python 写的。\nmkdir python3.3 cd Python-3.3 ./configure --enable-shared --with-threads --with-computed-gotos --enable-ipv6 --with-system-expat --with-system-ffi --prefix=${OPENSHIFT_DATA_DIR}/python3.3/ make -j4 make install 需要注意的就是：--prefix=${OPENSHIFT_DATA_DIR}/pythonX.X/ 一定要有，而且必须写在最后，否则不起作用。至于原因我也不知道，openshift 就是这样的。如果你看了 douglarek 的文章的话，你可能会知道一个 ${OPENSHIFT_RUNTIME_DIR}，这个也作废了。\n编译 python3-distribute 去 PYPI 下载 distribute。\n这时编译需要用我们前面刚制作好的 python 3.3 来编译它。所以我们需要修改一下系统的 PATH 和 LDLIBRARYPATH 让系统能够找到 python3\nexport PATH=${OPENSHIFT_DATA_DIR}/python3.3/bin:$PATH export LD_LIBRARY_PATH=${OPENSHIFT_DATA_DIR}/python3.3/lib:$LD_LIBRARY_PATH 这个 export 命令只对当前 Shell 有效，也就是说你 ssh logout 再登入，是要重新做的。\n编译：\ncd distribute-0.6.35 // 我们把所有的子模块都装到 python3.3 目录，下同 python3 setup.py install --prefix=${OPENSHIFT_DATA_DIR}/python3.3/ 编译 python3-dns 去 dnspython.org 下载 Python 3.x stable 对应的软件包。我这时是 1.10.0，解压用 unzip 命令。编译方法同 distribute。\n编译 pyxmpp2 要用依云修改的：\ngit clone https://github.com/lilydjwg/pyxmpp2.git 这时需要注意的是，最新版有问题，我们要使用 b3a01f03a10e319a833d2f57639bb696790c930e 这个 commit 的版本：\ngit checkout b3a01f03a10e319a833d2f57639bb696790c930e pyxmpp2 以后的编译方法同 distribute。\n编译 pymongo 下载在 PYPI。\n编译方法同 distribute。\n安装 mongodb 的预制包 前面已经说了，在 openshift 上编译的话内存会耗尽，所以我们用编译好的。下载在 mongodb.org，要下载 Linux 64-bit 的版本。\n然后解压，把 bin 目录下的所有东西都复制到 python3.3/bin 中去就可以了：\ncp -r mongodb-*/bin/* python3.3/bin/ 用 Python 2.7.3 安装 mongokit 下载 github.com/namlook/mongokit.git\ngit clone https://github.com/namlook/mongokit.git 因为要用 python 2.7.3 编译，所以我们要像前面一样把 python2.7/bin 和 python2.7/lib 导入到环境变量中去，具体方法见 distribute。\n编译：\n// 就这个不是 python3 python setup.py install --prefix=${OPENSHIFT_DATA_DIR}/python2.7/ 接着我们要做 2to3，方法是：\ncd python2.7/lib/python2.7/site-packages/mongokit-*-py2.7.egg/mongokit 2to3 -w . 然后把 mongokit-*-py2.7.egg 文件夹复制到 python3.3 的相应位置去：\ncp -r python2.7/lib/python2.7/site-packages/mongokit-*-py2.7.egg python3.3/lib/python3.3/site-packages/mongokit-*-py3.3.egg // * 的位置请自己补充 至此，xmpptalk 的依赖我们就安装完了。下面安装 ircbindxmpp 的。\n编译 tornado 捡出地址在 github.com/facebook/tornado。编译方法同 distribute。\n下面我们的操作都将在 python3.3/lib/python3.3/site-packages 下进行。 取得一些 winterpy 的小脚本\ngit clone https://github.com/lilydjwg/winterpy.git 然后把里面的 pylib/myutils.py 和 pylib/xmppbot.py 复制到 site-packages 目录下，winterpy 就可以删掉了。\n至此，ircbindxmpp 的依赖安装完毕。下面获取它们两个。\n在 site-packages 中捡出它们：\ngit clone https://github.com/lilydjwg/xmpptalk git clone https://github.com/lilydjwg/ircbindxmpp 一些清理 如果你不准备未来升级你的程序的依赖，那么你可以把 python3.3 下除了 bin 和 lib 的文件夹全部干掉节省空间。也可以不干掉。\n除了 python3.3 这个目录外的其它编译中间文件目录都可以 rm -rf 掉。\n准备配置 你需要两个 xmpp 账户，一个用来做 Gtalk 群聊，比如 talk@suse.org.cn，另一个用来转发 IRC 上的消息，比如 irc@suse.org.cn。xmpp 账户怎么来你可以看 StarBrilliant 的文章学习配置 prosody，也可以像我一样直接在我的 Google Apps 里新建两个账户（Google 的服务据说发送太多链接和说话太勤对方会收不到，但是目前我还没遇到）。所以我就用 Google Apps 为例了。怎么使用 prosody 我也不会，我的 bundle 里也没有 prosody 的依赖和主包，估计 openshift 在你不绑定域名（见我搭建 wordpress 那篇文章）的情况下也跑不起来（因为要设 SRV 记录，红帽提供的二级域名肯定没这功能）。\n注册 Google Apps，需要你有一个个人持有的域名。这个教学我省略了，因为太多了。只讲几个新建账户的注意事项：\n你建完账户是 temporary password，可以在该账户的明细里看到，首次登入是会要你改的，所以不要建完就去配置了，那样不会成功。一定要登入改密码。\n如果你用 Google Apps 弄过 Gtalk 就知道需要设置一个 DNS 的 SRV 记录，才能在非 Google 的客户端比如 Pidgin 上登入。但是这段 SRV 记录并不全，你之所以能在 Pidgin 上登入是你告诉了 Pidgin 我这就是 Google Talk。xmpptalk 是不知道的，它会一直 ping 你的域名的 A 记录，但那上面通常都是个博客或者别的什么，肯定不是 xmpp 服务器。所以你要多加下面一段 SRV 记录，和 Google 给的一起，加到你的 DNS 服务商比如 cloudns.net（不是每个 DNS 服务商都支持用 SRV 记录，至少我知道的免费的就这一个，反正你的域名注册商甚至共享主机商提供的 DNS 都不行），至于怎么改域名的 DNS 请自行搜索。\n_xmpp-client._tcp.你的域名. IN SRV 5 0 5222 xmpp-server.l.google.com. _xmpp-client._tcp.你的域名. IN SRV 20 0 5222 alt1.xmpp-server.l.google.com. _xmpp-client._tcp.你的域名. IN SRV 20 0 5222 alt2.xmpp-server.l.google.com. _xmpp-client._tcp.你的域名. IN SRV 20 0 5222 alt3.xmpp-server.l.google.com. _xmpp-client._tcp.你的域名. IN SRV 20 0 5222 alt4.xmpp-server.l.google.com. 至于各项的意思，搜索一下就能明白，反正 cloudns 是蛮简单的，就顺序填空…\n等 DNS 刷新好了之后，然后请把两个账户相互加为好友。不然到了 ircbindxmpp 的时候，由于不是好友，转发机器人没法把 IRC 说的话转发到 Gtalk 群聊里去。\n这样你的账户就准备好了。我们开始配置。\n开始配置 我们需要改两个配置文件：site-packages 中的 xmpptalk/config.py 和 ircbindxmpp/config.py。没有就把 config.py.example 复制一下：\ncp -r config.py.example config.py 下面先说 xmpptalk。\nTODO: your bot's JID： 这个是要写群聊机器人使用的账户，比如 talk@suse.org.cn/bot TODO: your JID：这个是管理员的 Gtalk 账户，比如我的 marguerite@opensuse.org TODO: type a random string below：这个需要一个随机字符串，可以用 cat /dev/urandom | tr -dc A-Za-z0-9_ | fold -w 12 | head -5 得到一堆。 nickchangeinterval = datetime.timedelta(days=10)：这个是群成员改昵称的间隔，默认是 10 天。 TODO: select a database：这里唯一需要改的是 host，不能用 localhost，可以用 echo $OPENSHIFT_INTERNAL_IP 得到一个 IP 地址，用它。 warnv105 = True：这个改成 False，不然用 Gtalk 105 版的就会持续收到警告说你的客户端不安全之类的，但问题我们群里有台湾地区的用户，我们面临的问题人家不需要。 TODO: the password of your bot：群聊机器人的密码。 这样就好了。其它的不用管（如果你用 Prosody 的话可能还需要管一个 # Which IP to connect?）。[Update] 依云酱说一般不需要，这个是给 Prosody 不支持 IPv6 准备的，一般填也填 IPv6 地址。\n然后你还需要新建一个 xmpptalk/mongodb.conf，指定数据库的存放位置和日志的存放位置，完整见下：\ndbpath=/var/lib/openshift/513c7ceb5973cab51b0002c5/app-root/runtime/data/openshift-xmpptalk-ircbindxmpp-bundle/data logpath=/var/lib/openshift/513c7ceb5973cab51b0002c5/app-root/runtime/data/openshift-xmpptalk-ircbindxmpp-bundle/log/mongodb.log logappend=true #auth = true smallfiles = true nojournal = true bind_ip = 127.5.76.1 其中 /var/lib/openshift/513c7ceb5973cab51b0002c5/app-root/runtime/data/ 就是 $OPENSHIFT_DATA_DIR，可以用 echo $OPENSHIFT_DATA_DIR 得到，openshift-xmpptalk-ircbindxmpp-bundle 是我预制的那个 bundle（在 git 上），data 和 log 是我自己建的。那个 bind_ip 就是前面刚讲的 $OPENSHIFT_INTERNAL_IP。在配置文件中是不能使用 openshfit 预定义的宏的，因为使用这个配置的程序读不出。\n然后新建一个 start_mongo.sh 来启动 mongod 的 daemon，内容如下：\nmongod --config ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/mongodb.conf --fork 那个 –config 跟的也是 mongodb.conf 所在的完整路径。\nircbindxmpp 的配置：\ntargetJID = JID('talk@suse.org.cn')：这是你的群聊机器人的账户 BotJID = JID('irc@suse.org.cn/bot')：这是你的转发机器人的账户 'channel': 'opensuse-cn',：你要互通的 IRC 频道 'nick': 'SuSE-Lady'：机器人在频道上的名字 'realname': 'Gtalk Bot'：机器人在频道说话时显示的名字，我们互通 Gtalk 自然叫 Gtalk password = ''：你的转发机器人的密码。 运行 export 环境变量（如果你已经登出了的话）。\n进入 xmpptalk 文件夹：\n// 启动数据库 chmod +x start_mongo.sh ./start_mongo.sh // 初始化数据库 python3 dbman.py // 运行群聊机器人 nohup python3 main.py \u003e ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/xmpptalk.log 2\u003e\u00261 \u0026 其中 nohup 是不让 python3 进程一直占用你的 shell，后面那一套是把返回在 shell 屏幕上的 runtime 日志给重定向到一个文件中去。不然的话，在你 ssh 退出之后，这些 python3 进程会被 openshift 杀死，你的群就掉线了。\n这时您就可以加群聊机器人与其它人通过机器人聊天了。\n进去 ircbindxmpp 文件夹：\n// 运行 IRC 转发机器人 nohup python3 ircbindxmpp \u003e ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/ircbindxmpp.log 2\u003e\u00261 \u0026 原理同上。这时您就可以在 IRC 频道里看到你的机器人上线了。\n停止机器人：\nkillall python3 简单粗暴但行之有效。\n你也可以做个重启脚本 restart.sh 放在根目录下面（一般 mongodb 跑起来就不用我们去管它了，所以不包括这个）：\nexport PATH=${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin:$PATH export LD_LIBRARY_PATH=${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib:$LD_LIBRARY_PATH killall python3 #killall mongod #mongod --config ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/mongodb.conf --fork nohup python3 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/main.py \u003e ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/xmpptalk.log 2\u003e\u00261 \u0026 nohup python3 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/ircbindxmpp/ircbindxmpp \u003e ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/ircbindxmpp.log 2\u003e\u00261 \u0026 uncomment mongod 那两行可以连 mongod 一起重启。\n特殊注意： 是不是以为万事大吉了？还没呢…红帽说了，后台程序（在网页访问不到的），两天就会被 idle。也就是说两天后两个机器人就都掉线了。怎么办呢？\nDo-it-yourself 应用的 Git（就是网页上让你 clone 的那个 URL）里面有一个 diy 文件夹，里面是一个 ruby 写的超小网页服务器，我们把那个跑起来，不就有一个非后台应用在跑了么？\ngit clone ssh://*************@talk-**********.rhcloud.com/~/git/talk.git/ 然后啥也不用干，直接 touch 个什么东西，提交回去就行了： [Update] 要改 ./openshift/action_hooks/{start,stop}，不然提交的时候会停掉服务器上正在跑的程序只跑一个 ruby 的网页服务器。\ncd talk/.openshift/action_hooks/ 在 start 尾部添加以下几行：\nexport PATH=${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin:$PATH export LD_LIBRARY_PATH=${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib:$LD_LIBRARY_PATH nohup python3 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/main.py \u003e ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/xmpptalk.log 2\u003e\u00261 \u0026 nohup python3 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/ircbindxmpp/ircbindxmpp \u003e ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/ircbindxmpp.log 2\u003e\u00261 \u0026 在 stop 里面的 exit 0 上面插入一行：\nkillall python3 然后提交：\ngit add . git commit -m \"initial commit\" git push 然后 .openshift/action_hooks/start 就会在服务器跑，就会把那个网页服务器跑起来了。\n额外 Prosody 这个确实不懂。不过需要提醒大家注意的一点是，如果你打算在 openshift 上编译并搭建它，你需要了解 openshift 不是每个端口都可以对外的。大部分你熟悉的端口都已经在内外两边都为官方应用保留了，内部你只可以用 15000 – 35530，对外只可以 bind 到 ${OPENSHIFT_INTERNAL_PORT} 也就是 8080，会通过 80 端口转发给外部。\n群日志 在 mongodb 数据库里。可以用 mongoexport 导出。\n[Update] 今天他们非要一个 IRC 日志，我就直接把日志做成 cron jobs 放到我们之前跑起来的那个 ruby 网页服务器上了。\n[Update1] 他们非要 HTML 格式的日志。好吧：https://talk-marguerite.rhcloud.com/index.html\n把以下内容保存为 log_to_web.sh，放在 .openshfit/cron/hourly 并 chmod +x 后提交：\n${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin/mongoexport --host ${OPENSHIFT_INTERNAL_IP}:27017 -d talk -c log --csv -f time,jid,msg -o ${OPENSHIFT_REPO_DIR}/diy/chat.txt ${OPENSHIFT_DATA_DIR}/text2html.sh ${OPENSHIFT_REPO_DIR}/diy/chat.txt \u003e ${OPENSHIFT_REPO_DIR}/diy/index.html rm -rf ${OPENSHIFT_REPO_DIR}/diy/chat.txt killall ruby nohup $OPENSHIFT_REPO_DIR/diy/testrubyserver.rb $OPENSHIFT_INTERNAL_IP $OPENSHIFT_REPO_DIR/diy \u003e $OPENSHIFT_HOMEDIR/diy-0.1/logs/diy_server.log 2\u003e\u00261 \u0026 解释下就是导出 log，转为 HTML，然后重启网页服务器生效。\n然后把以下内容保存为 text2html.sh，放在 $OPENSHIFT_DATA_DIR 下面然后 chmod +x。\n\" echo 'openSUSE 中文社團聊天記錄' echo \"`date -R`\" echo '' cat \"$1\" | while read p; do echo \"\" echo $p echo \"\n\" done echo ' 2013 版權所有 suse.ws。這是 openSUSE 中文社區的官方聊天室。 添加 talk@suse.ws 爲 Gtalk 好友或 IRC 加入 #opensuse-cn 頻道即可參與。 ' 备份方案 你当然可以使用我在之前搭建 wordpress 的文章里讲的 snapshot 方法。不过下面介绍一种自动的：使用 Dropbox-Uploader 配合 openshift 的 Cron Cartridge。\n首先在网页版的 My Applications 里点进去，然后进入你的 Do-it-yourself 应用，点 add cartridge，加一个 Cron 1.4 的 cartridge。\n然后 ssh 进你的应用程序：\ncd $OPENSHIFT_DATA_DIR git clone https://github.com/andreafabrizi/Dropbox-Uploader 然后把里面那个脚本复制到上级目录，文件夹可以删了。需要修改一个地方：\nsed -i \"s/CONFIG_FILE=~/CONFIG_FILE=\\./\" ./dropbox_uploader.sh 不然会提示权限不够。再：\nchmod +x dropbox_uploader.sh ./dropbox_uploader.sh 一次，跟随设置。这样以后你就可以 ./dropbox_uploader.sh upload 文件 了。\n先备份一下我们整个的 openshift-xmpptalk-ircbindxmpp-bundle 吧。注意，以下所有脚本都是在 ${OPENSHIFT_DATA_DIR} 运行的。这是 dump_all.sh 脚本的内容：\npushd ${OPENSHIFT_DATA_DIR} # 压缩整个 openshift-xmpptalk-ircbindxmpp-bundle 文件夹 tar -cjvf openshift-xmpptalk-ircbindxmpp-bundle-`date +%Y-%m-%d`.tar.bz2 openshift-xmpptalk-ircbindxmpp-bundle/ # 上传到 Dropbox ./dropbox_uploader.sh upload `ls | grep tar.bz2` # 删除 tar rm -rf openshift-xmpptalk-ircbindxmpp-bundle-*.tar.bz2 popd 然后我们编写一个 backup_data.sh 备份脚本，需要备份的有数据库，config.py，mongodb.conf，和 data 与 log 文件夹，以及 mongodump 导出的群消息日志：\n# 备份 mongodb ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin/mongodump --host ${OPENSHIFT_INTERNAL_IP}:27017 -d talk -o ${OPENSHIFT_DATA_DIR}/backup/database/ # 导出聊天记录 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin/mongoexport --host ${OPENSHIFT_INTERNAL_IP}:27017 -d talk -c log --csv -f time,jid,msg -o ${OPENSHIFT_DATA_DIR}/backup/chatlog.csv # 备份 config(s) mkdir -p ${OPENSHIFT_DATA_DIR}/backup/config/ cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/config.py ${OPENSHIFT_DATA_DIR}/backup/config/xmpptalk.config.py cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/ircbindxmpp/config.py ${OPENSHIFT_DATA_DIR}/backup/config/ircbindxmpp.config.py cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/mongodb.conf ${OPENSHIFT_DATA_DIR}/backup/config/ # 备份 log(s) mkdir -p ${OPENSHIFT_DATA_DIR}/backup/log/ cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/* ${OPENSHIFT_DATA_DIR}/backup/log/ # 备份裸数据库 mkdir -p ${OPENSHIFT_DATA_DIR}/backup/raw/ cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/data/* ${OPENSHIFT_DATA_DIR}/backup/raw/ # 改名 mv ${OPENSHIFT_DATA_DIR}/backup ${OPENSHIFT_DATA_DIR}/backup-`date +%Y-%m-%d-%H_%M_%S` pushd ${OPENSHIFT_DATA_DIR} tar -cjf `ls | grep backup-20`.tar.bz2 backup-*/ # 上传 ./dropbox_uploader.sh upload *.tar.bz2 # 清理 rm -rf backup-20* popd 现在是 cron 设置了。还记得刚才你弄的那个 talk 的 Git 吗？用那个去搞（以下命令是在本地的）：\ncd talk cd .openshift/cron 能够看到下面有 minutely 什么的这样的文件夹。openshift 的 cron 就是把脚本扔到这样的文件夹里，就会按照文件夹名所说的时间来跑。我们的 dump_all.sh 一个月执行一次就好了，而 backup_data.sh 可以每天执行一次。于是就把那两个脚本也放到相应的文件夹里去（服务器上的是给你手动跑的），不要忘记 chmod +x 哦！然后：\ngit add . git commit -m \"scheduled backup\" git push 完成，enjoy！ 呜谢\n依云酱 douglarek ",
  "wordCount" : "1199",
  "inLanguage": "en",
  "datePublished": "2013-03-17T00:00:00+08:00",
  "dateModified": "2013-03-17T00:00:00+08:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://marguerite.github.io/posts/openshift_%E6%90%AD%E5%BB%BA%E5%92%8C_irc_%E9%A2%91%E9%81%93%E4%BA%92%E9%80%9A%E7%9A%84_gtalk_%E7%BE%A4%E8%81%8A/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Marguerite Su: Golang/Ruby Programmer, openSUSE Member",
    "logo": {
      "@type": "ImageObject",
      "url": "https://marguerite.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://marguerite.github.io/" accesskey="h" title="Marguerite Su: Golang/Ruby Programmer, openSUSE Member (Alt + H)">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      openshift 搭建和 IRC 频道互通的 Gtalk 群聊
    </h1>
    <div class="post-meta"><span title='2013-03-17 00:00:00 +0800 CST'>March 17, 2013</span>

</div>
  </header> 
  <div class="post-content"><p>Long long ago，大概八九个月前，看到翁学天的 ikde 群居然能和 IRC 互通，感觉很惊艳，于是也想弄一个替代现在的 <a href="mailto:opensuse_zh@im.partych.at">opensuse_zh@im.partych.at</a>。</p>
<p>Party Chat 是一个很好的免折腾 Gtalk 群聊主机服务，架设在 Amazon 上面，但是有以下缺点：</p>
<ul>
<li>不能和 IRC 互通。作为一个开源社区，要是没有利用上 IRC，总感觉少了点什么。</li>
<li>在线时间不能保证。也就是说你没有 schduled_maintenance 的权利，只能它在线你就聊，它离线你就歇息。</li>
<li>大于 300 人的群拒绝服务。也就是说你的群是顶着地雷的，到了 300 人整个群就会消失，因为 Party Chat 不能承担那些多出来的流量钱。你交钱也不给你提供额外服务。</li>
</ul>
<p>所以几十个人的小社群还是可以应付的，但是人满了之后迁移成本特别大。所以就想着趁人少迁移到 ikde 那种高级群里去。</p>
<p>打听了一下，这种群聊是使用依云(<a href="http://lilydjwg.is-programmer.com/">@lilydjwg</a> 写的两个软件在 VPS 上搭建的，分别是 <a href="https://github.com/lilydjwg/xmpptalk">xmpptalk</a> 和 <a href="https://github.com/lilydjwg/ircbindxmpp">ircbindxmpp</a>。</p>
<p>但问题出来了，我没有 VPS。当时 <a href="https://openshift.redhat.com/">openshift</a> 这种 PaaS 已经出现了，只是还比较新鲜，我不会用。于是去年 9 月的一次尝试就可耻地失败了。</p>
<p>当时（甚至至今）网上关于这两个软件的文章只有两篇：</p>
<ul>
<li>依云自己的<a href="http://lilydjwg.is-programmer.com/2012/5/14/xmpptalk-chatroom-bot-and-xmpp-group-recommandation.33537.html">介绍性文章</a>，但是太粗略了。</li>
<li>StarBrilliant 的稍微详细一些的<a href="http://m13253.blogspot.jp/2012/08/xmpptalk-get-started.html">文章</a>，但是还是有点犯了程序员的通病：普通用户不知所云。如果你是一个已有 VPS 的博主，看了也得折腾一会儿，要是麻瓜的话，恐怕也就只能看个热闹了。</li>
</ul>
<p>于是逼迫我们群里的 douglarek 写了一篇在 openshift 上折腾它们的文章给我：</p>
<p><a href="http://blog.icocoa.me/xmpptalk-on-openshift/">Openshift 折腾 xmpptalk</a></p>
<p>但实际上这篇文章很水。反正看过就知道啦，到处都是「凑合」。实际上你看它也根本架设不起来（好多致命细节都没说）。</p>
<p>当时我就是在这种情况下开始折腾的。</p>
<p>首先我开了 <code>Do it yourself</code> 应用，然后进去编译，结果很悲剧，红帽给的内存太小，mongodb 编译不成功; 后来我使用 Build Service 模拟了一个 openshift 环境（一个 x86_64 的 RHEL），然后编译编译，我犯懒了…</p>
<p>今年三月份挖出了作者，又折腾了一个多礼拜，总算搞定了。下面是正文：</p>
<h4 id="注册一个-do-it-yourself-应用">注册一个 Do it yourself 应用<a hidden class="anchor" aria-hidden="true" href="#注册一个-do-it-yourself-应用">#</a></h4>
<p>注册、配置 ssh 和怎么使用 ssh 登入服务器的教学见 douglarek 和我之前几篇讲 openshift 的教学，都是最基本的英文，基本能注册 GMail 的都会弄，不能注册 GMail 的基本你也不能在墙外看见我的文章。</p>
<h4 id="编译">编译<a hidden class="anchor" aria-hidden="true" href="#编译">#</a></h4>
<p>基本的 <code>Do it yourself</code> 应用是带有以下部分的：Git，bz2/gz 的解压软件。所以你这些是不需要的。</p>
<p>ssh 进去之后，<code>cd $OPENSHIFT_DATA_DIR</code>，这个文件夹的完整位置是在 <code>app-root/runtime/data</code>，当然你也可以使用 <code>echo $OPENSHIFT_DATA_DIR</code> 看到它的完整路径。</p>
<p>在这个文件夹里使用 wget URL 去下载源代码，git clone 捡出 git 仓库。这些我都假设你已经知道了。</p>
<p>所有的编译过程都是源自依云的 scripts/quick_install.sh，但是我更新了一些东西，所以最好还是看我的。</p>
<h4 id="编译-python-27">编译 Python 2.7<a hidden class="anchor" aria-hidden="true" href="#编译-python-27">#</a></h4>
<p>下载 python 2.7.3 和 3.3 的源代码（你看到这篇的文章的时候可能已经更新了，所以请去 python.org 下载最新版）。然后解压。</p>
<p>编译 2.7.3 是因为后面我们有个程序要用 2to3 把针对 Python 2 gen 写的代码转义到 Python 3 gen。</p>
<pre><code>mkdir python2.7 (我们要把最终的 python 2.7 装进去，因为你没有权限往 /usr 装)
cd Python-2.7.3
// 依云原版的多了个 `--with-computed-gotos`，但这个选项已经没有了，变默认了。另外一个 `--with-wide-unicode` 作废了，现在默认就是 long。
./configure --enable-shared --with-threads --enable-ipv6 --with-system-expat --with-system-ffi --prefix=${OPENSHIFT_DATA_DIR}/python2.7/
make -j4
make install
</code></pre>
<p>这样 python2.7 里就有 python 了。</p>
<h4 id="编译-python-33">编译 Python 3.3<a hidden class="anchor" aria-hidden="true" href="#编译-python-33">#</a></h4>
<p>这才是主依赖，因为依云的代码是基于 3.2 版 Python 写的。</p>
<pre><code>mkdir python3.3
cd Python-3.3
./configure --enable-shared --with-threads --with-computed-gotos --enable-ipv6 --with-system-expat --with-system-ffi --prefix=${OPENSHIFT_DATA_DIR}/python3.3/
make -j4
make install
</code></pre>
<p>需要注意的就是：<code>--prefix=${OPENSHIFT_DATA_DIR}/pythonX.X/</code> 一定要有，而且必须写在最后，否则不起作用。至于原因我也不知道，openshift 就是这样的。如果你看了 douglarek 的文章的话，你可能会知道一个 <code>${OPENSHIFT_RUNTIME_DIR}</code>，这个也作废了。</p>
<h4 id="编译-python3-distribute">编译 python3-distribute<a hidden class="anchor" aria-hidden="true" href="#编译-python3-distribute">#</a></h4>
<p>去 PYPI 下载 <a href="https://pypi.python.org/pypi/distribute">distribute</a>。</p>
<p>这时编译需要用我们前面刚制作好的 python 3.3 来编译它。所以我们需要修改一下系统的 <code>PATH</code> 和 <code>LDLIBRARYPATH</code> 让系统能够找到 python3</p>
<pre><code>export PATH=${OPENSHIFT_DATA_DIR}/python3.3/bin:$PATH
export LD_LIBRARY_PATH=${OPENSHIFT_DATA_DIR}/python3.3/lib:$LD_LIBRARY_PATH
</code></pre>
<p>这个 export 命令只对当前 Shell 有效，也就是说你 ssh logout 再登入，是要重新做的。</p>
<p>编译：</p>
<pre><code>cd distribute-0.6.35
// 我们把所有的子模块都装到 python3.3 目录，下同
python3 setup.py install --prefix=${OPENSHIFT_DATA_DIR}/python3.3/
</code></pre>
<h4 id="编译-python3-dns">编译 python3-dns<a hidden class="anchor" aria-hidden="true" href="#编译-python3-dns">#</a></h4>
<p>去 dnspython.org 下载 Python 3.x stable 对应的软件包。我这时是 1.10.0，解压用 unzip 命令。编译方法同 distribute。</p>
<h4 id="编译-pyxmpp2">编译 pyxmpp2<a hidden class="anchor" aria-hidden="true" href="#编译-pyxmpp2">#</a></h4>
<p>要用依云修改的：</p>
<pre><code>git clone https://github.com/lilydjwg/pyxmpp2.git
</code></pre>
<p>这时需要注意的是，最新版有问题，我们要使用 b3a01f03a10e319a833d2f57639bb696790c930e 这个 commit 的版本：</p>
<pre><code>git checkout b3a01f03a10e319a833d2f57639bb696790c930e pyxmpp2
</code></pre>
<p>以后的编译方法同 distribute。</p>
<h4 id="编译-pymongo">编译 pymongo<a hidden class="anchor" aria-hidden="true" href="#编译-pymongo">#</a></h4>
<p>下载在 <a href="https://pypi.python.org/pypi/pymongo">PYPI</a>。</p>
<p>编译方法同 distribute。</p>
<h4 id="安装-mongodb-的预制包">安装 mongodb 的预制包<a hidden class="anchor" aria-hidden="true" href="#安装-mongodb-的预制包">#</a></h4>
<p>前面已经说了，在 openshift 上编译的话内存会耗尽，所以我们用编译好的。下载在 mongodb.org，要下载 Linux 64-bit 的版本。</p>
<p>然后解压，把 bin 目录下的所有东西都复制到 python3.3/bin 中去就可以了：</p>
<pre><code>cp -r mongodb-*/bin/* python3.3/bin/
</code></pre>
<h4 id="用-python-273-安装-mongokit">用 Python 2.7.3 安装 mongokit<a hidden class="anchor" aria-hidden="true" href="#用-python-273-安装-mongokit">#</a></h4>
<p>下载 <code>github.com/namlook/mongokit.git</code></p>
<pre><code>git clone https://github.com/namlook/mongokit.git
</code></pre>
<p>因为要用 python 2.7.3 编译，所以我们要像前面一样把 python2.7/bin 和 python2.7/lib 导入到环境变量中去，具体方法见 distribute。</p>
<p>编译：</p>
<pre><code>// 就这个不是 python3
python setup.py install --prefix=${OPENSHIFT_DATA_DIR}/python2.7/
</code></pre>
<p>接着我们要做 2to3，方法是：</p>
<pre><code>cd python2.7/lib/python2.7/site-packages/mongokit-*-py2.7.egg/mongokit
2to3 -w .
</code></pre>
<p>然后把 mongokit-*-py2.7.egg 文件夹复制到 python3.3 的相应位置去：</p>
<pre><code>cp -r python2.7/lib/python2.7/site-packages/mongokit-*-py2.7.egg python3.3/lib/python3.3/site-packages/mongokit-*-py3.3.egg
// * 的位置请自己补充
</code></pre>
<p>至此，xmpptalk 的依赖我们就安装完了。下面安装 ircbindxmpp 的。</p>
<h4 id="编译-tornado">编译 tornado<a hidden class="anchor" aria-hidden="true" href="#编译-tornado">#</a></h4>
<p>捡出地址在 github.com/facebook/tornado。编译方法同 distribute。</p>
<p>下面我们的操作都将在 python3.3/lib/python3.3/site-packages 下进行。 取得一些 winterpy 的小脚本</p>
<pre><code>git clone https://github.com/lilydjwg/winterpy.git
</code></pre>
<p>然后把里面的 pylib/myutils.py 和 pylib/xmppbot.py 复制到 site-packages 目录下，winterpy 就可以删掉了。</p>
<p>至此，ircbindxmpp 的依赖安装完毕。下面获取它们两个。</p>
<p>在 site-packages 中捡出它们：</p>
<pre><code>git clone https://github.com/lilydjwg/xmpptalk
git clone https://github.com/lilydjwg/ircbindxmpp
</code></pre>
<h4 id="一些清理">一些清理<a hidden class="anchor" aria-hidden="true" href="#一些清理">#</a></h4>
<p>如果你不准备未来升级你的程序的依赖，那么你可以把 python3.3 下除了 bin 和 lib 的文件夹全部干掉节省空间。也可以不干掉。</p>
<p>除了 python3.3 这个目录外的其它编译中间文件目录都可以 rm -rf 掉。</p>
<h4 id="准备配置">准备配置<a hidden class="anchor" aria-hidden="true" href="#准备配置">#</a></h4>
<p>你需要两个 xmpp 账户，一个用来做 Gtalk 群聊，比如 <a href="mailto:talk@suse.org.cn">talk@suse.org.cn</a>，另一个用来转发 IRC 上的消息，比如 <a href="mailto:irc@suse.org.cn">irc@suse.org.cn</a>。xmpp 账户怎么来你可以看 StarBrilliant 的文章学习配置 prosody，也可以像我一样直接在我的 Google Apps 里新建两个账户（Google 的服务据说发送太多链接和说话太勤对方会收不到，但是目前我还没遇到）。所以我就用 Google Apps 为例了。怎么使用 prosody 我也不会，我的 bundle 里也没有 prosody 的依赖和主包，估计 openshift 在你不绑定域名（见我搭建 wordpress 那篇文章）的情况下也跑不起来（因为要设 SRV 记录，红帽提供的二级域名肯定没这功能）。</p>
<p>注册 Google Apps，需要你有一个个人持有的域名。这个教学我省略了，因为太多了。只讲几个新建账户的注意事项：</p>
<p>你建完账户是 temporary password，可以在该账户的明细里看到，首次登入是会要你改的，所以不要建完就去配置了，那样不会成功。一定要登入改密码。</p>
<p>如果你用 Google Apps 弄过 Gtalk 就知道需要<a href="http://support.google.com/a/bin/answer.py?hl=zh-Hans&amp;answer=34143">设置一个 DNS 的 SRV 记录</a>，才能在非 Google 的客户端比如 Pidgin 上登入。但是这段 SRV 记录并不全，你之所以能在 Pidgin 上登入是你告诉了 Pidgin 我这就是 Google Talk。xmpptalk 是不知道的，它会一直 ping 你的域名的 A 记录，但那上面通常都是个博客或者别的什么，肯定不是 xmpp 服务器。所以你要多加下面一段 SRV 记录，和 Google 给的一起，加到你的 DNS 服务商比如 cloudns.net（不是每个 DNS 服务商都支持用 SRV 记录，至少我知道的免费的就这一个，反正你的域名注册商甚至共享主机商提供的 DNS 都不行），至于怎么改域名的 DNS 请自行搜索。</p>
<pre><code>_xmpp-client._tcp.你的域名. IN SRV 5 0 5222 xmpp-server.l.google.com.
_xmpp-client._tcp.你的域名. IN SRV 20 0 5222 alt1.xmpp-server.l.google.com.
_xmpp-client._tcp.你的域名. IN SRV 20 0 5222 alt2.xmpp-server.l.google.com.
_xmpp-client._tcp.你的域名. IN SRV 20 0 5222 alt3.xmpp-server.l.google.com.
_xmpp-client._tcp.你的域名. IN SRV 20 0 5222 alt4.xmpp-server.l.google.com.
</code></pre>
<p>至于各项的意思，搜索一下就能明白，反正 cloudns 是蛮简单的，就顺序填空…</p>
<p>等 DNS 刷新好了之后，然后请把两个账户相互加为好友。不然到了 ircbindxmpp 的时候，由于不是好友，转发机器人没法把 IRC 说的话转发到 Gtalk 群聊里去。</p>
<p>这样你的账户就准备好了。我们开始配置。</p>
<h4 id="开始配置">开始配置<a hidden class="anchor" aria-hidden="true" href="#开始配置">#</a></h4>
<p>我们需要改两个配置文件：site-packages 中的 xmpptalk/config.py 和 ircbindxmpp/config.py。没有就把 config.py.example 复制一下：</p>
<pre><code>cp -r config.py.example config.py
</code></pre>
<p>下面先说 xmpptalk。</p>
<pre><code>TODO: your bot's JID： 这个是要写群聊机器人使用的账户，比如 talk@suse.org.cn/bot
TODO: your JID：这个是管理员的 Gtalk 账户，比如我的 marguerite@opensuse.org
TODO: type a random string below：这个需要一个随机字符串，可以用 cat /dev/urandom | tr -dc A-Za-z0-9_ | fold -w 12 | head -5 得到一堆。
nickchangeinterval = datetime.timedelta(days=10)：这个是群成员改昵称的间隔，默认是 10 天。
TODO: select a database：这里唯一需要改的是 host，不能用 localhost，可以用 echo $OPENSHIFT_INTERNAL_IP 得到一个 IP 地址，用它。
warnv105 = True：这个改成 False，不然用 Gtalk 105 版的就会持续收到警告说你的客户端不安全之类的，但问题我们群里有台湾地区的用户，我们面临的问题人家不需要。
TODO: the password of your bot：群聊机器人的密码。
</code></pre>
<p>这样就好了。其它的不用管（如果你用 Prosody 的话可能还需要管一个 <del># Which IP to connect?</del>）。[Update] 依云酱说一般不需要，这个是给 Prosody 不支持 IPv6 准备的，一般填也填 IPv6 地址。</p>
<p>然后你还需要新建一个 xmpptalk/mongodb.conf，指定数据库的存放位置和日志的存放位置，完整见下：</p>
<pre><code>dbpath=/var/lib/openshift/513c7ceb5973cab51b0002c5/app-root/runtime/data/openshift-xmpptalk-ircbindxmpp-bundle/data
logpath=/var/lib/openshift/513c7ceb5973cab51b0002c5/app-root/runtime/data/openshift-xmpptalk-ircbindxmpp-bundle/log/mongodb.log
logappend=true
#auth = true
smallfiles = true
nojournal = true
bind_ip = 127.5.76.1
</code></pre>
<p>其中 <code>/var/lib/openshift/513c7ceb5973cab51b0002c5/app-root/runtime/data/</code> 就是 <code>$OPENSHIFT_DATA_DIR</code>，可以用 <code>echo $OPENSHIFT_DATA_DIR</code> 得到，<code>openshift-xmpptalk-ircbindxmpp-bundle</code> 是我预制的那个 bundle（在 git 上），data 和 log 是我自己建的。那个 bind_ip 就是前面刚讲的 <code>$OPENSHIFT_INTERNAL_IP</code>。在配置文件中是不能使用 openshfit 预定义的宏的，因为使用这个配置的程序读不出。</p>
<p>然后新建一个 start_mongo.sh 来启动 mongod 的 daemon，内容如下：</p>
<pre><code>mongod --config ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/mongodb.conf --fork
</code></pre>
<p>那个 &ndash;config 跟的也是 mongodb.conf 所在的完整路径。</p>
<p>ircbindxmpp 的配置：</p>
<pre><code>targetJID = JID('talk@suse.org.cn')：这是你的群聊机器人的账户
BotJID = JID('irc@suse.org.cn/bot')：这是你的转发机器人的账户
'channel': 'opensuse-cn',：你要互通的 IRC 频道
'nick': 'SuSE-Lady'：机器人在频道上的名字
'realname': 'Gtalk Bot'：机器人在频道说话时显示的名字，我们互通 Gtalk 自然叫 Gtalk
password = ''：你的转发机器人的密码。
</code></pre>
<h4 id="运行">运行<a hidden class="anchor" aria-hidden="true" href="#运行">#</a></h4>
<p>export 环境变量（如果你已经登出了的话）。</p>
<p>进入 xmpptalk 文件夹：</p>
<pre><code>// 启动数据库
chmod +x start_mongo.sh
./start_mongo.sh
// 初始化数据库
python3 dbman.py
// 运行群聊机器人
nohup python3 main.py &gt; ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/xmpptalk.log 2&gt;&amp;1 &amp;
</code></pre>
<p>其中 nohup 是不让 python3 进程一直占用你的 shell，后面那一套是把返回在 shell 屏幕上的 runtime 日志给重定向到一个文件中去。不然的话，在你 ssh 退出之后，这些 python3 进程会被 openshift 杀死，你的群就掉线了。</p>
<p>这时您就可以加群聊机器人与其它人通过机器人聊天了。</p>
<p>进去 ircbindxmpp 文件夹：</p>
<pre><code>// 运行 IRC 转发机器人
nohup python3 ircbindxmpp &gt; ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/ircbindxmpp.log 2&gt;&amp;1 &amp;
</code></pre>
<p>原理同上。这时您就可以在 IRC 频道里看到你的机器人上线了。</p>
<p>停止机器人：</p>
<pre><code>killall python3
</code></pre>
<p>简单粗暴但行之有效。</p>
<p>你也可以做个重启脚本 restart.sh 放在根目录下面（一般 mongodb 跑起来就不用我们去管它了，所以不包括这个）：</p>
<pre><code>export PATH=${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin:$PATH
export LD_LIBRARY_PATH=${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib:$LD_LIBRARY_PATH
killall python3
#killall mongod
#mongod --config ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/mongodb.conf --fork
nohup python3 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/main.py &gt; ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/xmpptalk.log 2&gt;&amp;1 &amp;
nohup python3 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/ircbindxmpp/ircbindxmpp &gt; ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/ircbindxmpp.log 2&gt;&amp;1 &amp;
</code></pre>
<p>uncomment mongod 那两行可以连 mongod 一起重启。</p>
<h4 id="特殊注意">特殊注意：<a hidden class="anchor" aria-hidden="true" href="#特殊注意">#</a></h4>
<p>是不是以为万事大吉了？还没呢…红帽说了，后台程序（在网页访问不到的），两天就会被 idle。也就是说两天后两个机器人就都掉线了。怎么办呢？</p>
<p><code>Do-it-yourself</code> 应用的 Git（就是网页上让你 clone 的那个 URL）里面有一个 diy 文件夹，里面是一个 ruby 写的超小网页服务器，我们把那个跑起来，不就有一个非后台应用在跑了么？</p>
<pre><code>git clone ssh://*************@talk-**********.rhcloud.com/~/git/talk.git/
</code></pre>
<p><del>然后啥也不用干，直接 touch 个什么东西，提交回去就行了：</del> [Update] 要改 ./openshift/action_hooks/{start,stop}，不然提交的时候会停掉服务器上正在跑的程序只跑一个 ruby 的网页服务器。</p>
<pre><code>cd talk/.openshift/action_hooks/
</code></pre>
<p>在 start 尾部添加以下几行：</p>
<pre><code>export PATH=${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin:$PATH
export LD_LIBRARY_PATH=${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib:$LD_LIBRARY_PATH
nohup python3 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/main.py &gt; ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/xmpptalk.log 2&gt;&amp;1 &amp;
nohup python3 ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/ircbindxmpp/ircbindxmpp &gt; ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/ircbindxmpp.log 2&gt;&amp;1 &amp;
</code></pre>
<p>在 stop 里面的 exit 0 上面插入一行：</p>
<pre><code>killall python3
</code></pre>
<p>然后提交：</p>
<pre><code>git add .
git commit -m &quot;initial commit&quot;
git push
</code></pre>
<p>然后 <code>.openshift/action_hooks/start</code> 就会在服务器跑，就会把那个网页服务器跑起来了。</p>
<h4 id="额外">额外<a hidden class="anchor" aria-hidden="true" href="#额外">#</a></h4>
<h6 id="prosody">Prosody<a hidden class="anchor" aria-hidden="true" href="#prosody">#</a></h6>
<p>这个确实不懂。不过需要提醒大家注意的一点是，如果你打算在 openshift 上编译并搭建它，你需要了解 openshift 不是每个端口都可以对外的。大部分你熟悉的端口都已经<a href="https://openshift.redhat.com/community/kb/kb-e1038-i-cant-bind-to-a-port">在内外两边都为官方应用保留了</a>，内部你只可以用 15000 – 35530，对外只可以 bind 到 <code>${OPENSHIFT_INTERNAL_PORT}</code> 也就是 8080，会通过 80 端口转发给外部。</p>
<h6 id="群日志">群日志<a hidden class="anchor" aria-hidden="true" href="#群日志">#</a></h6>
<p>在 mongodb 数据库里。可以用 mongoexport 导出。</p>
<p>[Update] 今天他们非要一个 IRC 日志，我就直接把日志做成 cron jobs 放到我们之前跑起来的那个 ruby 网页服务器上了。</p>
<p>[Update1] 他们非要 HTML 格式的日志。好吧：<a href="https://talk-marguerite.rhcloud.com/index.html">https://talk-marguerite.rhcloud.com/index.html</a></p>
<p>把以下内容保存为 log_to_web.sh，放在 .openshfit/cron/hourly 并 <code>chmod +x</code> 后提交：</p>
<pre><code>${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin/mongoexport --host ${OPENSHIFT_INTERNAL_IP}:27017 -d talk -c log --csv -f time,jid,msg -o ${OPENSHIFT_REPO_DIR}/diy/chat.txt
${OPENSHIFT_DATA_DIR}/text2html.sh ${OPENSHIFT_REPO_DIR}/diy/chat.txt &gt; ${OPENSHIFT_REPO_DIR}/diy/index.html
rm -rf ${OPENSHIFT_REPO_DIR}/diy/chat.txt
killall ruby
nohup $OPENSHIFT_REPO_DIR/diy/testrubyserver.rb $OPENSHIFT_INTERNAL_IP $OPENSHIFT_REPO_DIR/diy &gt; $OPENSHIFT_HOMEDIR/diy-0.1/logs/diy_server.log 2&gt;&amp;1 &amp;
</code></pre>
<p>解释下就是导出 log，转为 HTML，然后重启网页服务器生效。</p>
<p>然后把以下内容保存为 text2html.sh，放在 $OPENSHIFT_DATA_DIR 下面然后 chmod +x。</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<pre><code>            &lt;/head&gt;
        &lt;body&gt;&quot;
echo '&lt;h2&gt;openSUSE 中文社團聊天記錄'
echo &quot;`date -R`&quot;
echo '&lt;/h2&gt;&lt;div id='content'&gt;'
cat &quot;$1&quot; | while read p; do
        echo &quot;&lt;p&gt;&quot;
        echo $p
        echo &quot;&lt;/p&gt;&quot;
done
echo '&lt;/div&gt;
                &lt;span&gt;2013 版權所有 suse.ws。這是 openSUSE 中文社區的官方聊天室。&lt;/span&gt;
                &lt;span&gt;添加 talk@suse.ws 爲 Gtalk 好友或 IRC 加入 #opensuse-cn 頻道即可參與。&lt;/span&gt;
        &lt;/body&gt;
    &lt;/html&gt;'
</code></pre>
<p><!-- raw HTML omitted --></p>
<h6 id="备份方案">备份方案<a hidden class="anchor" aria-hidden="true" href="#备份方案">#</a></h6>
<p>你当然可以使用我在之前搭建 wordpress 的文章里讲的 snapshot 方法。不过下面介绍一种自动的：使用 <a href="https://github.com/andreafabrizi/Dropbox-Uploader">Dropbox-Uploader</a> 配合 openshift 的 Cron Cartridge。</p>
<p>首先在网页版的 My Applications 里点进去，然后进入你的 Do-it-yourself 应用，点 add cartridge，加一个 Cron 1.4 的 cartridge。</p>
<p>然后 ssh 进你的应用程序：</p>
<pre><code>cd $OPENSHIFT_DATA_DIR
git clone https://github.com/andreafabrizi/Dropbox-Uploader
</code></pre>
<p>然后把里面那个脚本复制到上级目录，文件夹可以删了。需要修改一个地方：</p>
<pre><code>sed -i &quot;s/CONFIG_FILE=~/CONFIG_FILE=\./&quot; ./dropbox_uploader.sh
</code></pre>
<p>不然会提示权限不够。再：</p>
<pre><code>chmod +x dropbox_uploader.sh
./dropbox_uploader.sh
</code></pre>
<p>一次，跟随设置。这样以后你就可以 ./dropbox_uploader.sh upload 文件 了。</p>
<p>先备份一下我们整个的 openshift-xmpptalk-ircbindxmpp-bundle 吧。注意，以下所有脚本都是在 ${OPENSHIFT_DATA_DIR} 运行的。这是 dump_all.sh 脚本的内容：</p>
<pre><code>pushd ${OPENSHIFT_DATA_DIR}
# 压缩整个 openshift-xmpptalk-ircbindxmpp-bundle 文件夹
tar -cjvf openshift-xmpptalk-ircbindxmpp-bundle-`date +%Y-%m-%d`.tar.bz2 openshift-xmpptalk-ircbindxmpp-bundle/
# 上传到 Dropbox
./dropbox_uploader.sh upload `ls | grep tar.bz2`
# 删除 tar
rm -rf openshift-xmpptalk-ircbindxmpp-bundle-*.tar.bz2
popd
</code></pre>
<p>然后我们编写一个 backup_data.sh 备份脚本，需要备份的有数据库，config.py，mongodb.conf，和 data 与 log 文件夹，以及 mongodump 导出的群消息日志：</p>
<pre><code># 备份 mongodb
${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin/mongodump --host ${OPENSHIFT_INTERNAL_IP}:27017 -d talk -o ${OPENSHIFT_DATA_DIR}/backup/database/
# 导出聊天记录
${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/bin/mongoexport --host ${OPENSHIFT_INTERNAL_IP}:27017 -d talk -c log --csv -f time,jid,msg -o ${OPENSHIFT_DATA_DIR}/backup/chatlog.csv
# 备份 config(s)
mkdir -p ${OPENSHIFT_DATA_DIR}/backup/config/
cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/config.py ${OPENSHIFT_DATA_DIR}/backup/config/xmpptalk.config.py
cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/ircbindxmpp/config.py ${OPENSHIFT_DATA_DIR}/backup/config/ircbindxmpp.config.py
cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/lib/python3.3/site-packages/xmpptalk/mongodb.conf ${OPENSHIFT_DATA_DIR}/backup/config/
# 备份 log(s)
mkdir -p ${OPENSHIFT_DATA_DIR}/backup/log/
cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/log/* ${OPENSHIFT_DATA_DIR}/backup/log/
# 备份裸数据库
mkdir -p ${OPENSHIFT_DATA_DIR}/backup/raw/
cp -r ${OPENSHIFT_DATA_DIR}/openshift-xmpptalk-ircbindxmpp-bundle/data/* ${OPENSHIFT_DATA_DIR}/backup/raw/
# 改名
mv ${OPENSHIFT_DATA_DIR}/backup ${OPENSHIFT_DATA_DIR}/backup-`date +%Y-%m-%d-%H_%M_%S`
pushd ${OPENSHIFT_DATA_DIR}
tar -cjf `ls | grep backup-20`.tar.bz2 backup-*/
# 上传
./dropbox_uploader.sh upload *.tar.bz2
# 清理
rm -rf backup-20*
popd
</code></pre>
<p>现在是 cron 设置了。还记得刚才你弄的那个 talk 的 Git 吗？用那个去搞（以下命令是在本地的）：</p>
<pre><code>cd talk
cd .openshift/cron
</code></pre>
<p>能够看到下面有 minutely 什么的这样的文件夹。openshift 的 cron 就是把脚本扔到这样的文件夹里，就会按照文件夹名所说的时间来跑。我们的 dump_all.sh 一个月执行一次就好了，而 backup_data.sh 可以每天执行一次。于是就把那两个脚本也放到相应的文件夹里去（服务器上的是给你手动跑的），不要忘记 chmod +x 哦！然后：</p>
<pre><code> git add .
git commit -m &quot;scheduled backup&quot;
git push
</code></pre>
<p>完成，enjoy！
呜谢</p>
<ul>
<li>依云酱</li>
<li>douglarek</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="https://marguerite.github.io/">Marguerite Su: Golang/Ruby Programmer, openSUSE Member</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a><script src="https://utteranc.es/client.js"
        repo="marguerite/marguerite.github.io"
        issue-term="title"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
